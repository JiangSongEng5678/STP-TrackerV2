<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰åˆ©å¯¹è±¡è·Ÿè¿›ç³»ç»Ÿ (Amway Prospect Tracker)</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        :root {
            --primary-color: #0d47a1; 
            --secondary-color: #f1f5f9; 
            --accent-color: #10b981; 
            --danger-color: #ef4444;
            --warning-color: #f59e0b; 
            --info-color: #3b82f6; 
            --text-color: #1e2023; /* Darker, more readable main text */
            --light-text-color: #fff;
            --text-color-light: #2d3032; /* Softer, clearer secondary text */
            --border-radius: 12px; 
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-color: #e2e8f0;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: var(--secondary-color); 
            color: var(--text-color); 
            line-height: 1.6;
            background-image: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png');
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .welcome-message {
            text-align: center;
            opacity: 0; /* Start hidden */
            animation: fadeIn 1.5s forwards; /* Fade in */
        }
        #welcome-icon {
            font-size: 4.5em; /* Adjusted size for mobile */
            line-height: 1;
            display: block; /* Make it a block to control spacing */
            margin: 0 auto 15px auto; /* Center it and add space below */
            animation: sparkle 2s infinite ease-in-out;
        }
        #welcome-text {
            font-size: 1.8em; /* Adjusted size for mobile */
            font-weight: 700;
            color: var(--primary-color);
            white-space: nowrap; /* Prevent text from wrapping */
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; } /* Made sparkle more subtle */
        }

        .app-layout { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
        .main-content { flex-grow: 1; }
        .sidebar { flex: 0 0 280px; position: sticky; top: 20px; }
        .container, .sidebar { background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .sidebar h3, #availability-modal-title { color: var(--primary-color); margin-top: 0; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; font-size: 1.1em; }
        #available-slots-list, #modal-slots-list { list-style: none; padding: 0; max-height: calc(100vh - 120px); overflow-y: auto; }
        .slot-day-group { margin-bottom: 15px; }
        .slot-day-group h4 { margin: 0 0 8px 0; font-size: 0.9em; color: #555; background-color: var(--secondary-color); padding: 5px 8px; border-radius: 4px;}
        .slot-time { background-color: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 5px; font-size: 0.9em; text-align: center; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        header h1 {
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; 
            font-size: 1.8em; 
        }
        .controls, .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        button, .btn-file-input { padding: 10px 20px; font-size: 1em; font-weight: 600; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; display: inline-block; text-align: center;}
        button:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: var(--light-text-color); } .btn-primary:hover { background-color: #0b3a8a; box-shadow: 0 4px 10px rgba(13, 71, 161, 0.3); }
        .btn-success { background: linear-gradient(45deg, var(--primary-color), var(--info-color)); color: var(--light-text-color); background-size: 200% auto; } 
        .btn-success:hover { background-position: right center; box-shadow: 0 4px 12px rgba(60, 130, 246, 0.4); }
        .btn-danger { background-color: var(--danger-color); color: var(--light-text-color); } .btn-danger:hover { background-color: #d93333; }
        .btn-secondary { background-color: #64748b; color: var(--light-text-color); } .btn-secondary:hover { background-color: #475569; }
        .tabs { display: flex; margin-bottom: 25px; flex-wrap: wrap; gap: 0; border-bottom: 2px solid var(--border-color); }
        .tab-button { background-color: transparent; border: none; border-bottom: 3px solid transparent; border-radius: 0; padding: 12px 16px; font-weight: 600; color: var(--text-color-light); transition: all 0.2s ease; }
        .tab-button:hover { color: var(--primary-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background-color: transparent; font-weight: 600; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .prospect-card, .reminder-card, .analytics-card, .appointment-card, .settings-card { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--box-shadow); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .prospect-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(30, 41, 59, 0.1); }
        .prospect-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .prospect-meta { display: flex; flex-wrap: wrap; gap: 0 10px; color: var(--text-color-light); font-size: 0.9em; align-items: center;}
        .prospect-meta span { display: inline-block; }
        .prospect-meta .separator { color: var(--border-color); font-size: 1.2em; }
        .status-badge { padding: 5px 12px; border-radius: 999px; font-weight: 600; font-size: 0.85em; color: #fff; text-align: center; }
        .status-STP { background-color: var(--info-color); } .status-GMS_Appointment { background-color: #f97316; }
        .status-KIT_STP, .status-KIT_GMS { background-color: var(--warning-color); color: var(--text-color); }
        .status-Joined { background-color: var(--accent-color); } .status-Disqualified, .status-Not_Joining { background-color: var(--danger-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--primary-color); } .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-color); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); outline: none; }
        .reminders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .reminder-card { border-left-color: var(--warning-color); } .appointment-card { border-left-color: var(--info-color); }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .analytics-card { text-align: center; border-left-color: var(--accent-color); }
        .analytics-card .value { font-size: 2.5em; font-weight: bold; color: var(--primary-color); }
        .search-bar, #sort-by, #status-filter, #analytics-month { padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color); font-size: 1em; background-color: #fff; }
        .search-bar { flex-grow: 1; } .filter-controls { margin-bottom: 20px; }
        .tags-container { margin-top: 8px; }
        .tag-badge { display: inline-block; background-color: #e9ecef; color: var(--text-color); padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; margin-bottom: 5px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px; }
        .calendar-header h2 { color: var(--primary-color); margin: 0; text-align: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { font-weight: bold; text-align: center; padding: 10px 5px; background-color: var(--secondary-color); border-radius: 4px; }
        .calendar-day { border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; min-height: 80px; background-color: white; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: #f8f9fa; color: #ccc; }
        .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; }
        .calendar-day .day-number { font-size: 0.9em; }
        .appointment-dots { margin-top: 5px; display: flex; gap: 4px; }
        .appointment-dot { height: 8px; width: 8px; border-radius: 50%; }
        .dot-stp { background-color: var(--info-color); }
        .dot-gms { background-color: #f97316; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .card-header h3 { margin-top: 0; flex-grow: 1; line-height: 1.2; }
        .card-menu-container { position: relative; flex-shrink: 0; }
        .menu-toggle-btn { padding: 0 8px; font-size: 1.5em; background: transparent; border: none; line-height: 1; color: #888; }
        .card-menu { display: none; position: absolute; right: 0; top: 100%; background-color: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); z-index: 10; min-width: 120px; border: 1px solid #eee; }
        .card-menu.open { display: block; }
        .menu-item { display: block; padding: 10px 15px; color: var(--text-color); text-decoration: none; font-size: 0.9em; }
        .menu-item:hover { background-color: var(--secondary-color); }
        .menu-item-danger { color: var(--danger-color); }
        #planner-modal .modal-content { max-width: 800px; }
        .planner-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .planner-appointments, .planner-timeline { flex: 1; min-width: 300px; }
        #planner-appointments-list li { list-style: none; padding-left: 0; margin-bottom: 5px; }
        .planner-timeline { max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: var(--border-radius); }
        .time-slot { display: block; width: 100%; margin-bottom: 5px; text-align: center; background-color: #e9ecef; border: 1px solid #dee2e6; color: #495057; }
        .time-slot:not(:disabled):hover { background-color: #ced4da; }
        .time-slot.available { background-color: var(--accent-color); color: white; border-color: #1e7e34; }
        .time-slot.booked { background-color: var(--info-color); color: white; border-color: #117a8b; opacity: 0.8; cursor: not-allowed; }
        .planner-footer { margin-top: 20px; text-align: right; }
        .planner-legend { display: flex; gap: 15px; font-size: 0.8em; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        #calendar-legend { justify-content: center; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .legend-color.available { background-color: var(--accent-color); }
        .legend-color.booked { background-color: var(--info-color); }
        .legend-color.busy { background-color: #e9ecef; border: 1px solid #dee2e6; }
        .downline-info { font-size: 0.8em; color: #555; font-style: italic; background-color: #fafafa; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .toggle-switch { display: flex; gap: 5px; background-color: var(--secondary-color); border-radius: var(--border-radius); padding: 5px; margin-bottom: 15px; }
        .toggle-switch button { flex: 1; background-color: transparent; border: none; padding: 8px; font-weight: normal; }
        .toggle-switch button.active { background-color: white; color: var(--primary-color); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #guide { line-height: 1.8; }
        #guide h2 { color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 30px; }
        #guide h3 { color: var(--text-color); margin-top: 25px; margin-bottom: 10px; }
        #guide hr { border: none; border-top: 1px solid var(--border-color); margin: 30px 0; }
        #guide .legend-item { display: inline-flex; margin-right: 15px; }
        #guide code { background-color: var(--secondary-color); padding: 2px 6px; border-radius: 4px; font-family: "Courier New", Courier, monospace; }
        #show-availability-fab { display: none; position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 2px solid white; align-items: center; justify-content: center; z-index: 1001; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 25px; }
        .page-btn { background-color: #fff; border: 1px solid var(--border-color); color: var(--primary-color); font-weight: 600; padding: 8px 14px; border-radius: 8px; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background-color: var(--primary-color); color: var(--light-text-color); border-color: var(--primary-color); }
        .page-btn:not(:disabled):hover { background-color: var(--secondary-color); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        /* --- START: New Login Page & Modal Styles --- */
        #auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 40px);
            padding: 20px;
            box-sizing: border-box;
        }
        .login-card {
            background: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 420px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            animation: fadeIn 0.5s ease-out;
        }
        .login-logo {
            max-width: 100px;
            margin: 0 auto 20px;
        }
        .login-card h2 {
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.8em;
            font-weight: 700;
            color: var(--primary-color);
        }
        .login-card p {
            margin-bottom: 30px;
            color: var(--text-color-light);
        }
        .auth-form-group {
            position: relative;
            margin-bottom: 20px;
        }
        .auth-form-group input {
            width: 100%;
            padding: 12px 12px 12px 45px; /* Add padding for icon */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-size: 1em;
        }
        .auth-form-group input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1);
            outline: none;
        }
        .auth-form-group .icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            pointer-events: none;
        }
         .auth-form-group .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: pointer;
        }
        .login-actions button {
            width: 100%;
            padding: 12px 20px;
            font-size: 1.1em;
        }
        .auth-toggle-link {
            color: var(--primary-color);
            text-decoration: none;
            cursor: pointer;
            font-weight: 600;
        }
        .auth-toggle-link:hover {
            text-decoration: underline;
        }
        .auth-footer {
            margin-top: 20px;
            font-size: 0.9em;
            color: var(--text-color-light);
        }
        .forgot-password-link {
            display: block;
            margin-top: 15px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 0.9em;
            transition: color 0.2s;
        }
        .forgot-password-link:hover {
            text-decoration: underline;
            color: #0b3a8a;
        }
        /* --- END: New Login Page & Modal Styles --- */

        /* ===== Flatpickr Custom Theme ===== */
        .flatpickr-calendar { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 315px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .flatpickr-months .flatpickr-month { color: var(--primary-color); font-weight: 600; font-size: 1rem; height: 40px; }
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { padding: 8px; fill: var(--primary-color); transition: background-color 0.2s; border-radius: 50%; }
        .flatpickr-months .flatpickr-prev-month:hover, .flatpickr-months .flatpickr-next-month:hover { background-color: var(--secondary-color); fill: var(--info-color); }
        .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-current-month .numInputWrapper { font-weight: 600; color: inherit; }
        .flatpickr-weekday { color: var(--text-color-light); font-weight: 600; text-transform: uppercase; font-size: 0.7em; }
        .dayContainer { padding: 5px; }
        .flatpickr-day { border: none; border-radius: 50%; transition: background-color 0.2s, color 0.2s, box-shadow 0.2s; font-weight: 500; }
        .flatpickr-day:hover { background-color: var(--secondary-color); color: var(--text-color); }
        .flatpickr-day.today { border: 2px solid var(--accent-color); color: var(--accent-color); }
        .flatpickr-day.today:hover { background-color: var(--accent-color); color: var(--light-text-color); }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background: var(--primary-color); color: var(--light-text-color); border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .flatpickr-day.selected:hover { background: #0b3a8a; }
        .flatpickr-day.disabled { color: rgba(0,0,0,0.2); }
        .flatpickr-time { border-top: 1px solid var(--border-color); background: var(--secondary-color); }
        .flatpickr-time .numInput, .flatpickr-time .flatpickr-am-pm { color: var(--text-color); background: #fff; border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; }
        .flatpickr-time .numInput:hover, .flatpickr-time .flatpickr-am-pm:hover { background: #eef2f7; }
        .flatpickr-time .numInputWrapper span.arrowUp, .flatpickr-time .numInputWrapper span.arrowDown { opacity: 0.7; transition: opacity 0.2s; }
        .flatpickr-time .numInputWrapper span.arrowUp:hover, .flatpickr-time .numInputWrapper span.arrowDown:hover { opacity: 1; }
        .flatpickr-monthSelect-months { display: block; grid-template-columns: repeat(auto-fit, minmax(95px, 1fr)); gap: 5px; padding: 5px; }
        .flatpickr-monthSelect-month { border-radius: 6px; padding: 10px 5px; font-weight: 500; text-align: center; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .flatpickr-monthSelect-month:hover { background-color: var(--secondary-color); color: var(--primary-color); }
        .flatpickr-monthSelect-month.selected { background-color: var(--primary-color); color: var(--light-text-color); }

        /* ======================================================= */
        /* START: HOVER EFFECT ENHANCEMENTS                      */
        /* ======================================================= */

        /* 1. Add a subtle 'lift' effect to Dashboard cards */
        .reminder-card, .appointment-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .reminder-card:hover, .appointment-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(30, 41, 59, 0.1);
        }

        /* 2. Enhance the main navigation tabs on hover */
        .tab-button:hover {
            transform: translateY(-2px);
            background-color: rgba(0,0,0,0.02);
        }

        /* 3. Make calendar days pop out when hovered */
        .calendar-day {
            /* Add transform and box-shadow to the existing transition */
            transition: background-color 0.2s, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .calendar-day:not(.other-month):hover {
            transform: translateY(-3px);
            box-shadow: var(--box-shadow);
            cursor: pointer;
        }

        /* ======================================================= */
        /* END: HOVER EFFECT ENHANCEMENTS                        */
        /* ======================================================= */

        /* Tablet Responsive Styles */
        @media (max-width: 992px) { 
            body { padding: 15px; }
            .app-layout { flex-direction: column; } 
            .sidebar { display: none; }
            #show-availability-fab { display: flex; }
        }

        /* Phone Responsive Styles */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container, .sidebar { padding: 15px; }
            header { flex-direction: column; align-items: flex-start; gap: 15px; }
            header h1 { font-size: 1.5em; }
            .tabs { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; -ms-overflow-style: none; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab-button { flex-grow: 0; flex-shrink: 0; }
            .prospect-meta { flex-direction: column; gap: 5px; align-items: flex-start; }
            .prospect-meta .separator { display: none; }

            .dashboard-header {
                flex-direction: column;      /* Stack title and buttons vertically */
                align-items: flex-start;   /* Align them to the left */
                gap: 15px;                   /* Add space between the title and buttons */
                margin-bottom: 20px;         /* Add space below the header to prevent overlap */
            }

            .dashboard-header .controls {
                display: grid;               /* Use grid for easy columns */
                grid-template-columns: 1fr 1fr; /* Create a two-column layout for the buttons */
                width: 100%;                 /* Make the container take full width */
            }

            .filter-controls {
                display: grid;
                grid-template-columns: 1fr 1fr; /* Two equal columns */
                gap: 10px;
            }

            .filter-controls .search-bar {
                grid-column: 1 / -1; /* Make search bar span both columns */
            }

            .prospect-card .card-header h3 {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                gap: 8px; /* Adds space between name and badge */
                line-height: 1.4;
            }

            .prospect-actions {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            .login-card { padding: 25px; }
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="welcome-message">
            <span id="welcome-icon">ğŸ’</span> <span id="welcome-text">æ¬¢è¿é’»çŸ³ä»¬!</span>
        </div>
    </div>

    <div id="auth-container" style="display: none;">
        <div class="login-card">
            <img src="images/icon-192x192.png" alt="Logo" class="login-logo">
            <h2 id="auth-title">Welcome Back</h2>
            <p id="auth-subtitle">Login to track your prospects.</p>
            
            <div class="auth-form-group">
                <span class="icon">ğŸ“§</span>
                <input type="email" id="auth-email" placeholder="Email" autocomplete="email">
            </div>
            <div class="auth-form-group">
                <span class="icon">ğŸ”’</span>
                <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
                <span class="password-toggle" id="password-toggle">ğŸ‘ï¸</span>
            </div>
            <div class="auth-form-group" id="confirm-password-group" style="display: none;">
                <span class="icon">ğŸ”‘</span>
                <input type="password" id="auth-confirm-password" placeholder="Confirm Password" autocomplete="new-password">
            </div>

            <div class="login-actions">
                <button class="btn-primary" id="auth-action-btn">Login</button>
            </div>

            <button id="google-signin-btn" class="btn-secondary" style="width:100%; margin-top: 10px;">
                Sign in with Google
            </button>

            <div class="auth-footer">
                <p id="auth-toggle-text">
                    No account? <span class="auth-toggle-link" id="toggle-to-signup">Sign up now</span>.
                </p>
                <a href="#" class="forgot-password-link" id="forgot-password-link">Forgot Password?</a>
            </div>
        </div>
    </div>
    <div class="app-layout" id="main-app" style="display: none;">
        <div class="main-content">
            <div class="container">
                <header>
                    <h1 id="appTitle"></h1>
                    <div class="controls"> <button class="btn-secondary" id="lang-toggle">English</button> <button class="btn-success" id="add-prospect-btn"></button> </div>
                </header>
                <div class="tabs">
                    <button class="tab-button active" data-tab="dashboard" id="tabDashboard"></button>
                    <button class="tab-button" data-tab="calendar" id="tabCalendar"></button>
                    <button class="tab-button" data-tab="all-prospects" id="tabAllProspects"></button>
                    <button class="tab-button" data-tab="analytics" id="tabAnalytics"></button>
                    <button class="tab-button" data-tab="settings" id="tabSettings"></button>
                    <button class="tab-button" data-tab="guide" id="tabGuide"></button>
                </div>
                <div id="dashboard" class="tab-content active">
                    <div class="dashboard-header">
                        <h2 id="upcomingAppointmentsTitle"></h2>
                        <div class="controls">
                            <button id="copy-stp-btn" class="btn-secondary"></button>
                            <button id="copy-gms-btn" class="btn-secondary"></button>
                        </div>
                    </div>
                    <div id="appointments-grid" class="reminders-grid"></div>
                    <h2 id="followUpTitle" style="margin-top: 30px;"></h2> 
                    <div id="follow-ups-grid" class="reminders-grid"></div>
                </div>
                <div id="calendar" class="tab-content">
                    <div class="calendar-header">
                        <button id="prev-month">&lt;</button> <h2 id="current-month-year"></h2> <button id="next-month">&gt;</button>
                    </div>
                    <div id="calendar-legend" class="planner-legend">
                        <span class="legend-item"><span class="appointment-dot dot-stp"></span><span id="legend-stp"></span></span>
                        <span class="legend-item"><span class="appointment-dot dot-gms"></span><span id="legend-gms"></span></span>
                    </div>
                    <div id="calendar-grid-header" class="calendar-grid"></div>
                    <div id="calendar-grid-body" class="calendar-grid"></div>
                </div>
                <div id="all-prospects" class="tab-content">
                    <h2 id="allProspectsTitle"></h2>
                    <div class="toggle-switch" id="prospect-view-toggle"></div>
                    <div class="filter-controls">
                        <input type="search" id="search-input" class="search-bar">
                        <select id="status-filter"></select>
                        <select id="sort-by"></select>
                    </div>
                    <div id="prospect-list" class="prospect-list"></div>
                    <div id="pagination-controls" class="pagination"></div>
                </div>
                <div id="analytics" class="tab-content">
                    <h2 id="analyticsTitle"></h2>
                    <div class="toggle-switch" id="analytics-view-toggle"></div>
                    <div id="downline-analytics-controls" class="form-group" style="display: none;">
                        <label for="downline-filter" id="downline-filter-label"></label>
                        <select id="downline-filter"></select>
                    </div>
                    <div class="form-group"> <label for="analytics-month" id="analyticsMonthLabel"></label> <input type="text" id="analytics-month"> </div>
                    <div id="analytics-summary" class="analytics-grid"></div>
                    <hr>
                    <h3 id="analytics-trend-title" style="text-align: center; color: var(--primary-color);"></h3>
                    <div id="trend-chart-container" style="position: relative; height:40vh; width:100%; margin-top: 20px;">
                        <canvas id="analyticsTrendChart"></canvas>
                    </div>
                </div>
                <div id="settings" class="tab-content">
                    <h2 id="settingsTitle"></h2> 
                    
                    <div class="settings-card" style="border-left-color: var(--warning-color);">
                         <h3>Account</h3>
                         <p><strong>Logged in as:</strong> <span id="user-email"></span></p>
                         <div class="controls">
                             <button id="logout-btn" class="btn-secondary">Logout</button>
                         </div>
                    </div>

                    <div class="settings-card" style="border-left-color: var(--primary-color); margin-top: 20px;">
                        <h3 id="backupSyncTitle"></h3>
                        <p id="backupSyncDesc"></p>
                        <div class="controls">
                            <button id="exportData" class="btn-primary"></button>
                            <label class="btn-secondary btn-file-input">
                                <span id="importDataLabel"></span> <input type="file" id="importData" accept=".json" style="display: none;">
                            </label>
                        </div>
                    </div>

                    <div class="settings-card" style="border-left-color: var(--info-color); margin-top: 20px;">
                        <h3>Data Status</h3>
                        <p><strong>Last Synced/Imported:</strong> <span id="last-sync-time">Never</span></p>
                        <p><strong>Total Prospects:</strong> <span id="total-prospects">0</span></p>
                    </div>

                    <div class="settings-card" style="border-left-color: var(--danger-color); margin-top: 20px;">
                         <h3 id="dangerZoneTitle"></h3>
                         <p id="dangerZoneDesc"></p>
                         <button id="clearData" class="btn-danger"></button>
                    </div>
                </div>
                 <div id="guide" class="tab-content">
                    <h2 id="guide-main-title"></h2>
                    <hr>
                    <h3 id="guide-getting-started-title"></h3>
                    <p id="guide-getting-started-p1"></p>
                    <p><strong><span id="guide-getting-started-p2"></span></strong></p>
                    <ul>
                        <li id="guide-getting-started-li1"></li>
                        <li id="guide-getting-started-li2"></li>
                        <li id="guide-getting-started-li3"></li>
                    </ul>

                    <h3 id="guide-interface-title"></h3>
                    <p id="guide-interface-p1"></p>
                    <ul>
                        <li id="guide-interface-li1"></li>
                        <li id="guide-interface-li2"></li>
                        <li id="guide-interface-li3"></li>
                    </ul>
                    
                    <h3 id="guide-dashboard-title"></h3>
                    <p id="guide-dashboard-p1"></p>
                    <ul>
                        <li id="guide-dashboard-li1"></li>
                        <li id="guide-dashboard-li2"></li>
                        <li id="guide-dashboard-li3"></li>
                    </ul>

                    <h3 id="guide-calendar-title"></h3>
                    <p id="guide-calendar-p1"></p>
                    <div class="planner-legend" style="justify-content: flex-start; margin-left: 20px;">
                        <span class="legend-item"><span class="appointment-dot dot-stp"></span><span id="legend-stp-guide"></span></span>
                        <span class="legend-item"><span class="appointment-dot dot-gms"></span><span id="legend-gms-guide"></span></span>
                    </div>
                    <p id="guide-calendar-p2"></p>
                    <ul>
                        <li id="guide-calendar-li1"></li>
                        <li id="guide-calendar-li2"></li>
                        <li id="guide-calendar-li3"></li>
                    </ul>

                    <h3 id="guide-prospects-title"></h3>
                    <p><strong><span id="guide-prospects-p1"></span></strong></p>
                    <ul>
                        <li id="guide-prospects-li1"></li>
                        <li id="guide-prospects-li2"></li>
                        <li id="guide-prospects-li3"></li>
                    </ul>
                    <p><strong><span id="guide-prospects-p2"></span></strong></p>
                    <ul>
                        <li id="guide-prospects-li4"></li>
                        <li id="guide-prospects-li5"></li>
                    </ul>
                    <p><strong><span id="guide-prospects-p3"></span></strong></p>

                    <h3 id="guide-analytics-title"></h3>
                    <p id="guide-analytics-p1"></p>
                    <ul>
                        <li id="guide-analytics-li1"></li>
                    </ul>
                    <p><strong><span id="guide-analytics-p2"></span></strong></p>
                    <ul>
                        <li id="guide-analytics-li2"></li>
                        <li id="guide-analytics-li3"></li>
                    </ul>
                    <p><strong><span id="guide-analytics-p3"></span></strong></p>
                    
                    <h3 id="guide-settings-title"></h3>
                    <p id="guide-settings-p1"></p>
                    <ul>
                        <li id="guide-settings-li1"></li>
                    </ul>
                    <p><strong><span id="guide-settings-p2"></span></strong></p>
                    <p><strong><span id="guide-settings-p3"></span></strong></p>
                    <ul>
                        <li id="guide-settings-li2"></li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="sidebar">
            <h3 id="sidebar-title"></h3>
            <div id="available-slots-list"></div>
        </div>
    </div>
    
    <div id="prospect-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="modal-title"></h2> <span class="close-button" id="close-modal">&times;</span> </div>
            <form id="prospect-form">
                <input type="hidden" id="prospect-id">
                 <input type="hidden" id="original-stp-time">
                <div class="form-group">
                    <label id="owner-type-label"></label>
                    <select id="owner-type">
                        <option value="user" id="owner-user-option"></option>
                        <option value="downline" id="owner-downline-option"></option>
                    </select>
                </div>
                <div class="form-group" id="downline-name-group" style="display: none;">
                    <label for="downline-name" id="downline-name-label"></label>
                    <input type="text" id="downline-name" list="downline-names-list">
                    <datalist id="downline-names-list"></datalist>
                </div>
                <div class="form-group"> <label for="name" id="labelName"></label> <input type="text" id="name" required> </div>
                <div class="form-group"> <label for="phone" id="labelPhone"></label> <input type="text" id="phone"> </div>
                <div class="form-group"> <label for="age" id="labelAge"></label> <input type="number" id="age"> </div>
                <div class="form-group"> <label for="occupation" id="labelOccupation"></label> <input type="text" id="occupation"> </div>
                <div class="form-group"> <label for="tags" id="labelTags"></label> <input type="text" id="tags"> </div>
                <div class="form-group"> <label for="stp-datetime" id="labelStpTime"></label> <input type="text" id="stp-datetime" required> </div>
                <div class="form-group"> <label for="notes" id="labelNotes"></label> <textarea id="notes" rows="3"></textarea> </div>
                <button type="submit" class="btn-success" id="save-prospect-btn"></button>
            </form>
        </div>
    </div>
    <div id="action-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="action-modal-title"></h2> <span class="close-button" id="action-close-modal">&times;</span> </div>
            <form id="action-form">
                <input type="hidden" id="action-prospect-id"> <input type="hidden" id="action-type">
                <input type="hidden" id="original-gms-time">
                <div class="form-group" id="gms-schedule-group" style="display:none;"> <label for="gms-datetime" id="labelGmsTime"></label> <input type="text" id="gms-datetime"> </div>
                <div class="form-group"> <label for="action-notes" id="labelActionNotes"></label> <textarea id="action-notes" rows="4"></textarea> </div>
                <button type="submit" class="btn-success" id="confirm-action-btn"></button>
            </form>
        </div>
    </div>
    <div id="planner-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> <h2 id="planner-title"></h2> <span class="close-button" id="close-planner-modal">&times;</span> </div>
            <div class="planner-container">
                <div class="planner-appointments">
                    <h3 id="planner-appointments-title"></h3>
                    <ul id="planner-appointments-list"></ul>
                </div>
                <div class="planner-timeline">
                    <h3 id="planner-timeline-title"></h3>
                    <div class="planner-legend">
                        <span class="legend-item"><span class="legend-color available"></span><span id="legend-available"></span></span>
                        <span class="legend-item"><span class="legend-color booked"></span><span id="legend-booked"></span></span>
                        <span class="legend-item"><span class="legend-color busy"></span><span id="legend-busy"></span></span>
                    </div>
                    <div id="planner-timeline-slots"></div>
                </div>
            </div>
            <div class="planner-footer">
                <button class="btn-primary" id="save-availability-btn"></button>
            </div>
        </div>
    </div>
    <div id="availability-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header"> 
                <h2 id="availability-modal-title"></h2> 
                <span class="close-button" id="close-availability-modal">&times;</span> 
            </div>
            <div id="modal-slots-list"></div>
        </div>
    </div>

    <div id="forgot-password-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="forgot-password-title">Reset Password</h2>
                <span class="close-button" id="close-forgot-password-modal">&times;</span>
            </div>
            <p id="forgot-password-instructions">Enter your email address and we will send you instructions to reset your password.</p>
            <div class="form-group">
                <label for="reset-email" id="label-reset-email">Email</label>
                <input type="email" id="reset-email" placeholder="your.email@example.com">
            </div>
            <button class="btn-primary" id="send-reset-btn" style="width: 100%;">Send Reset Instructions</button>
        </div>
    </div>
    <button id="show-availability-fab">ğŸ“…</button>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- START: NEW SUPABASE SETUP ---
    const SUPABASE_URL = 'https://puaofmijvkmamyfugdzi.supabase.co'; // Replace with your Supabase URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1YW9mbWlqdmttYW15ZnVnZHppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTkzOTUsImV4cCI6MjA3MjYzNTM5NX0.fVuYgjxpf2pRLYpkCBIfsC5PjBQKKRYtN5hnL9jrZ8A'; // Replace with your Supabase Anon Key

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // --- END: NEW SUPABASE SETUP ---
    
    let currentPage = 1;
    const PROSPECTS_PER_PAGE = 8;
    let trendChartInstance = null;
    let isLoginView = true; // State for tracking login/signup view

    const translations = {
        'zh-CN': {
            tabCalendar: "æ—¥å†", appTitle: "å®‰åˆ©å¯¹è±¡è·Ÿè¿›ç³»ç»ŸğŸ’", addProspectBtn: "â• æ·»åŠ æ–°å¯¹è±¡", tabDashboard: "å¯¹è±¡è·Ÿè¿›ä¸­å¿ƒ", tabAllProspects: "æ‰€æœ‰å¯¹è±¡åˆ—è¡¨", tabAnalytics: "æ•°æ®åˆ†æ", tabSettings: "è®¾ç½®", tabGuide: "æŒ‡å—",
            upcomingAppointmentsTitle: "æœªæ¥é¢„çº¦ ğŸ“…", followUpTitle: "éœ€è¦è·Ÿè¿› ğŸ“", noAppointmentsText: "æ²¡æœ‰æœªæ¥çš„é¢„çº¦ã€‚", noFollowUpsText: "ç›®å‰æ²¡æœ‰éœ€è¦è·Ÿè¿›å¯¹è±¡ã€‚", allProspectsTitle: "æ‰€æœ‰å¯¹è±¡",
            analyticsTitle: "æœˆåº¦æ•°æ®åˆ†æ", analyticsMonthLabel: "é€‰æ‹©æœˆä»½:", settingsTitle: "æ•°æ®ä¸è®¾ç½®", 
            backupSyncTitle: "å¤‡ä»½ä¸åŒæ­¥", backupSyncDesc: "å°†æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ˆå¯¹è±¡å’Œå¯ç”¨æ—¶é—´ï¼‰å¯¼å‡ºåˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚æ‚¨å¯ä»¥ä¿å­˜æ­¤æ–‡ä»¶ä½œä¸ºå¤‡ä»½ï¼Œæˆ–åœ¨å¦ä¸€å°è®¾å¤‡ä¸Šå¯¼å…¥å®ƒä»¥åŒæ­¥æ‚¨çš„æ•°æ®ã€‚",
            exportData: "å¯¼å‡ºæ•°æ®", importDataLabel: "å¯¼å…¥æ•°æ®", importConfirm: "æ‚¨ç¡®å®šè¦ç”¨æ­¤æ–‡ä»¶ä¸­çš„æ•°æ®è¦†ç›–æ‰€æœ‰å½“å‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚", importSuccess: "æ•°æ®å¯¼å…¥æˆåŠŸï¼", importError: "æ–‡ä»¶æ— æ•ˆæˆ–å·²æŸåã€‚",
            dangerZoneTitle: "å±é™©åŒºåŸŸ", dangerZoneDesc: "æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‚¨çš„æ‰€æœ‰å¯¹è±¡å’Œå¯ç”¨æ—¶é—´æ•°æ®ã€‚",
            clearData: "æ¸…é™¤æ‰€æœ‰æ•°æ®", modalTitleAdd: "æ·»åŠ å¯¹è±¡", modalTitleEdit: "ç¼–è¾‘å¯¹è±¡ä¿¡æ¯", labelName: "åå­—:", labelPhone: "å·ç :", labelAge: "å¹´é¾„:",
            labelOccupation: "èŒä¸š:", labelTags: "æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”):", tagsPlaceholder: "ä¾‹å¦‚ï¼šå­¦ç”Ÿ, æ§ŸåŸ, æœ‹å‹", labelStpTime: "STP é‚€çº¦æ—¶é—´:", labelNotes: "å¤‡æ³¨:", saveProspectBtn: "ä¿å­˜", status: "çŠ¶æ€",
            kitCounter: "è·Ÿè¿›æ¬¡æ•°", actions: "æ“ä½œ", confirmClearData: "æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ", dataCleared: "æ‰€æœ‰æ•°æ®å·²æ¸…é™¤ã€‚", searchPlaceholder: "æœç´¢åå­—, å·ç , æˆ–æ ‡ç­¾...",
            sort: { label: "æ’åº:", newest: "æœ€æ–°ä¼˜å…ˆ (STPæ—¥æœŸ)", name_az: "åå­— (A-Z)", name_za: "åå­— (Z-A)", status: "çŠ¶æ€" }, dayNames: ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'], dayDetailsTitle: 'çš„é¢„çº¦',
            buttonEdit: "ç¼–è¾‘", buttonDelete: "åˆ é™¤", confirmDelete: "æ‚¨ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ä½å¯¹è±¡å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
            plannerTitle: "æ¯æ—¥å¯ç”¨æ—¶é—´è§„åˆ’", plannerAppointmentsTitle: "å·²ç¡®è®¤çš„é¢„çº¦", plannerTimelineTitle: "è®¾ç½®æ‚¨çš„å¯ç”¨æ—¶é—´", saveAvailability: "ä¿å­˜å¯ç”¨æ—¶é—´", noAppointmentsToday: "ä»Šæ—¥æ— é¢„çº¦",
            legendAvailable: "å¯ç”¨", legendBooked: "å·²é¢„çº¦", legendBusy: "å¿™ç¢Œ", legendStp: "STPé¢„çº¦", legendGms: "GMSé¢„çº¦",
            sidebarTitle: "æœªæ¥å¯ç”¨æ—¶æ®µ", noAvailableSlots: "æ²¡æœ‰å¯ç”¨çš„æ—¶é—´æ®µ", availabilityModalTitle: "æœªæ¥å¯ç”¨æ—¶æ®µ", allStatuses: "æ‰€æœ‰çŠ¶æ€",
            ownerTypeLabel: "è¿™ä½å¯¹è±¡å±äº:", ownerUserOption: "æˆ‘è‡ªå·±", ownerDownlineOption: "æˆ‘çš„ä¸‹çº¿", downlineNameLabel: "ä¸‹çº¿åå­—:", downlineInfo: "ä¸‹çº¿å¯¹è±¡: ",
            prospectViewToggleMine: "æˆ‘çš„å¯¹è±¡", prospectViewToggleDownlines: "ä¸‹çº¿å¯¹è±¡", prospectViewToggleAll: "å…¨éƒ¨",
            analyticsViewToggleMine: "æˆ‘çš„åˆ†æ", analyticsViewToggleDownlines: "ä¸‹çº¿æ”¯æŒåˆ†æ", downlineFilterLabel: "ç­›é€‰ä¸‹çº¿:", allDownlinesOption: "æ‰€æœ‰ä¸‹çº¿",
            errorDoubleBooking: "æ­¤æ—¶é—´æ®µå·²è¢«é¢„çº¦ï¼Œè¯·é€‰æ‹©å…¶ä»–æ—¶é—´ã€‚", errorDownlineNameRequired: "è¯·è¾“å…¥ä¸‹çº¿åå­—ã€‚",
            confirmJoin: "ç¡®å®šè¦å°†å¯¹è±¡æ ‡è®°ä¸ºâ€œå·²åŠ å…¥â€å—ï¼Ÿ", confirmDisqualify: "ç¡®å®šè¦å°†æ­¤å¯¹è±¡æ ‡è®°ä¸ºâ€œä¸åˆé€‚â€å—ï¼Ÿ", confirmNotJoining: "ç¡®å®šè¦å°†æ­¤å¯¹è±¡æ ‡è®°ä¸ºâ€œä¸åŠ å…¥â€å—ï¼Ÿ",
            STP: "å·²é‚€çº¦STP", GMS_Appointment: "å·²é‚€çº¦GMS", KIT_STP: "è·Ÿè¿›ä¸­ (STPå)", KIT_GMS: "è·Ÿè¿›ä¸­ (GMSå)", Joined: "å·²åŠ å…¥", Disqualified: "ä¸åˆé€‚", Not_Joining: "ä¸åŠ å…¥",
            actionScheduleGMS: "å®‰æ’GMS", actionKeepInTouch: "ä¿æŒè”ç³»", actionDisqualify: "ä¸åˆé€‚", actionJoined: "å·²åŠ å…¥", actionNotJoining: "ä¸åŠ å…¥", actionFollowUp: "è¿›è¡Œè·Ÿè¿›", actionEditGMS: "ä¿®æ”¹GMSæ—¶é—´",
            actionModalTitle: "æ›´æ–°å¯¹è±¡çŠ¶æ€", labelGmsTime: "GMS é‚€çº¦æ—¶é—´:", labelActionNotes: "è·Ÿè¿›å¤‡æ³¨ (å¯é€‰):", confirmActionBtn: "ç¡®è®¤", phone: "å·ç ", age: "å¹´é¾„", occupation: "èŒä¸š",
            kit_counter: "è·Ÿè¿›æ¬¡æ•°", stp_time: "STPæ—¶é—´", notes: "å¤‡æ³¨", name: "åå­—", analytics: { new_stps: "æ–°å¢STP", new_gms: "æ–°å¢GMS", new_joins: "æˆåŠŸåŠ å…¥", new_disqualified: "ä¸åˆé€‚/ä¸åŠ å…¥" },
            guideMainTitle: "å®‰åˆ©å¯¹è±¡è·Ÿè¿›ç³»ç»Ÿ - ç”¨æˆ·æŒ‡å—",
            guideGettingStartedTitle: "1. å¼€å§‹ä½¿ç”¨ï¼šå¦‚ä½•ä½¿ç”¨æ­¤æ–‡ä»¶",
            guideGettingStartedP1: "æ¬¢è¿æ‚¨ï¼æ­¤è¿½è¸ªå™¨æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å•æ–‡ä»¶åº”ç”¨ç¨‹åºï¼Œæ‚¨æ— éœ€å®‰è£…ä»»ä½•ç‰¹æ®Šè½¯ä»¶å³å¯ä½¿ç”¨ã€‚",
            guideGettingStartedP2: "å¼€å§‹æ­¥éª¤ï¼š",
            guideGettingStartedLi1: "<b>ä¿å­˜æ–‡ä»¶:</b> å°† .html æ–‡ä»¶ä¿å­˜åˆ°æ‚¨ç”µè„‘ä¸Šæ–¹ä¾¿çš„ä½ç½®ï¼Œä¾‹å¦‚æ¡Œé¢æˆ–ä¸“ç”¨æ–‡ä»¶å¤¹ã€‚",
            guideGettingStartedLi2: "<b>æ‰“å¼€æ–‡ä»¶:</b> è¦å¯åŠ¨åº”ç”¨ç¨‹åºï¼Œåªéœ€åŒå‡»è¯¥æ–‡ä»¶ã€‚å®ƒå°†åœ¨æ‚¨çš„é»˜è®¤ç½‘é¡µæµè§ˆå™¨ï¼ˆæ¨èä½¿ç”¨Google Chromeã€Firefoxæˆ–Microsoft Edgeï¼‰ä¸­æ‰“å¼€ã€‚",
            guideGettingStartedLi3: "<b>å…³äºæ•°æ®å­˜å‚¨çš„é‡è¦è¯´æ˜:</b> æ‚¨çš„æ‰€æœ‰æ•°æ®ï¼ˆæ‰€æœ‰ä¼™ä¼´ã€å¯ç”¨æ—¶é—´ç­‰ï¼‰éƒ½ç›´æ¥ä¿å­˜åœ¨æ‚¨ç½‘é¡µæµè§ˆå™¨çš„æœ¬åœ°å­˜å‚¨ä¸­ã€‚è¿™æ„å‘³ç€ï¼š<ul><li><b>æ•°æ®æ˜¯ç§å¯†çš„:</b> æ‚¨çš„æ•°æ®ä¿ç•™åœ¨æ‚¨çš„ç”µè„‘ä¸Šï¼Œä¸ä¼šé€šè¿‡äº’è”ç½‘å‘é€ã€‚</li><li><b>æ•°æ®ä¸æµè§ˆå™¨ç»‘å®š:</b> åœ¨Chrome ä¸­ä¿å­˜çš„æ•°æ®åœ¨Firefox ä¸­æ˜¯çœ‹ä¸è§çš„ï¼Œåä¹‹äº¦ç„¶ã€‚ä¸ºäº†ä¿æŒæ•°æ®ä¸€è‡´ï¼Œè¯·å§‹ç»ˆä½¿ç”¨åŒä¸€ä¸ªæµè§ˆå™¨ã€‚</li><li><b>æ•°æ®ä¸è®¾å¤‡ç»‘å®š:</b> æ•°æ®ä¸ä¼šè‡ªåŠ¨åŒæ­¥åˆ°å¦ä¸€å°ç”µè„‘æˆ–æ‚¨çš„æ‰‹æœºä¸Šã€‚è¯·ä½¿ç”¨ä¸‹è¿°çš„â€œå¤‡ä»½ä¸åŒæ­¥â€åŠŸèƒ½ã€‚</li></ul>",
            guideInterfaceTitle: "2. ä¸»ç•Œé¢ ğŸ—ºï¸",
            guideInterfaceP1: "æ­¤åº”ç”¨ç¨‹åºç»è¿‡ç²¾å¿ƒè®¾è®¡ï¼Œå¯åœ¨å°å¼æœºã€å¹³æ¿ç”µè„‘å’Œæ‰‹æœºä¸Šæä¾›å‡ºè‰²çš„å“åº”å¼ä½“éªŒã€‚",
            guideInterfaceLi1: "<b>ä¸»å†…å®¹åŒº:</b> æ‚¨å°†é€šè¿‡ä¸åŒçš„é€‰é¡¹å¡ä¸æ‚¨çš„æ•°æ®è¿›è¡Œäº¤äº’ã€‚",
            guideInterfaceLi2: "<b>ä¾§è¾¹æ  (æ¡Œé¢è§†å›¾):</b> åœ¨å¤§å±å¹•ä¸Šï¼Œæ­¤é¢æ¿ä¼šè‡ªåŠ¨æ˜¾ç¤ºæ‚¨å³å°†åˆ°æ¥çš„å¯ç”¨æ—¶é—´æ®µï¼Œæ–¹ä¾¿å¿«é€Ÿå®‰æ’ã€‚",
            guideInterfaceLi3: "<b>æµ®åŠ¨æŒ‰é’® (ç§»åŠ¨/å¹³æ¿è§†å›¾):</b> åœ¨å°å±å¹•ä¸Šï¼Œä¾§è¾¹æ è¢«å³ä¸‹è§’çš„ä¸€ä¸ªæµ®åŠ¨æ—¥å†æŒ‰é’® (ğŸ“…) å–ä»£ã€‚ç‚¹å‡»æ­¤æŒ‰é’®ä¼šå¼¹å‡ºä¸€ä¸ªçª—å£ï¼Œæ˜¾ç¤ºæ‚¨çš„å¯ç”¨æ—¶é—´æ®µã€‚",
            guideDashboardTitle: "3. ç®¡ç†æ‚¨çš„æ—¥ç¨‹ï¼šå¯¹è±¡è·Ÿè¿›ä¸­å¿ƒä¸æ—¥å†",
            guideDashboardP1: "<b>å¯¹è±¡è·Ÿè¿›ä¸­å¿ƒé€‰é¡¹å¡</b><br>è¿™æ˜¯æ‚¨çš„ä¸»å±å¹•ï¼Œè®©æ‚¨å¿«é€Ÿäº†è§£å½“å‰æœ€é‡è¦çš„äº‹æƒ…ï¼š",
            guideDashboardLi1: "<b>æœªæ¥é¢„çº¦ ğŸ“…:</b> æ˜¾ç¤ºæ‚¨æ‰€æœ‰æœªæ¥çš„STPå’ŒGMSçº¦ä¼šï¼ŒæŒ‰æ—¶é—´å…ˆåé¡ºåºæ’åˆ—ã€‚",
            guideDashboardLi2: "<b>ä¸€é”®å¤åˆ¶æŒ‰é’®:</b> åœ¨æ ‡é¢˜æ—è¾¹ï¼Œæ‚¨ä¼šæ‰¾åˆ° â€œå¤åˆ¶STPåˆ—è¡¨â€ å’Œ â€œå¤åˆ¶GMSåˆ—è¡¨â€ æŒ‰é’®ã€‚ç‚¹å‡»å®ƒä»¬ä¼šå¤åˆ¶ä¸€ä»½ä¸ºWhatsAppç­‰èŠå¤©åº”ç”¨é¢„å…ˆæ ¼å¼åŒ–å¥½çš„çº¦ä¼šæ‘˜è¦ï¼Œæ–¹ä¾¿æ‚¨å‘ä¸Šçº¿æ±‡æŠ¥ã€‚",
            guideDashboardLi3: "<b>éœ€è¦è·Ÿè¿› ğŸ“:</b> åˆ—å‡ºæ‰€æœ‰å½“å‰å¤„äºâ€œä¿æŒè”ç³»â€(KIT)é˜¶æ®µçš„ä¼™ä¼´ã€‚",
            guideCalendarTitle: "æ—¥å†é€‰é¡¹å¡ & å¯ç”¨æ—¶é—´è§„åˆ’å™¨",
            guideCalendarP1: "è¿™æ˜¯æ‚¨ç®¡ç†æ—¶é—´çš„æ ¸å¿ƒå·¥å…·ã€‚",
            guideCalendarP2: "<b>æ¯æ—¥å¯ç”¨æ—¶é—´è§„åˆ’å™¨:</b> ç‚¹å‡»æ—¥å†ä¸­çš„ä»»ä½•ä¸€å¤©ï¼Œå³å¯ä¸ºè¯¥æ—¥æœŸæ‰“å¼€è§„åˆ’å™¨ã€‚åœ¨æ­¤å¼¹å‡ºçª—å£ä¸­ï¼Œæ‚¨å¯ä»¥ï¼š",
            guideCalendarLi1: "<b>æŸ¥çœ‹å·²ç¡®è®¤çš„çº¦ä¼š:</b> æŸ¥çœ‹æ‚¨å½“å¤©å°†ä¼šè§çš„å¯¹è±¡åˆ—è¡¨ã€‚",
            guideCalendarLi2: "<b>è®¾ç½®æ‚¨çš„ç©ºé—²æ—¶é—´:</b> ç‚¹å‡»30åˆ†é’Ÿçš„æ—¶é—´æ®µï¼Œå°†å…¶æ ‡è®°ä¸ºå¯ç”¨ã€‚",
            guideCalendarLi3: "<b>ä¿å­˜:</b> ç‚¹å‡» \"ä¿å­˜å¯ç”¨æ—¶é—´\"ã€‚æ‚¨æ ‡è®°çš„æ—¶é—´å°†å‡ºç°åœ¨ä¾§è¾¹æ æˆ–æµ®åŠ¨æŒ‰é’®çš„å¼¹å‡ºçª—å£ä¸­ã€‚",
            guideProspectsTitle: "4. æ‰€æœ‰ä¼™ä¼´ï¼šæ‚¨çš„ä¸­å¤®æ•°æ®åº“",
            guideProspectsP1: "<b>æ·»åŠ å’Œç¼–è¾‘ä¼™ä¼´:</b>",
            guideProspectsLi1: "ç‚¹å‡»é¡¶éƒ¨çš„ â• æ·»åŠ æ–°ä¼™ä¼´ æŒ‰é’®ã€‚",
            guideProspectsLi2: "åœ¨è¡¨å•ä¸­ï¼Œæ‚¨å¯ä»¥æŒ‡å®šæ­¤ä¼™ä¼´å±äº \"æˆ‘è‡ªå·±\" è¿˜æ˜¯ \"æˆ‘çš„ä¸‹çº¿\"ã€‚å¦‚æœé€‰æ‹©ä¸‹çº¿ï¼Œæ‚¨å¯ä»¥ä»åˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªå·²æœ‰çš„ä¸‹çº¿ï¼Œæˆ–è¾“å…¥ä¸€ä¸ªæ–°åå­—ã€‚",
            guideProspectsLi3: "å¡«å†™æ‰€æœ‰è¯¦ç»†ä¿¡æ¯ï¼Œç„¶åç‚¹å‡» ä¿å­˜ã€‚ä¼˜é›…çš„æ—¥æœŸå’Œæ—¶é—´é€‰æ‹©å™¨ä½¿å®‰æ’çº¦ä¼šå˜å¾—éå¸¸ç›´è§‚ã€‚",
            guideProspectsP2: "<b>ç­›é€‰ä¸æ’åº:</b>",
            guideProspectsLi4: "<b>è§†å›¾åˆ‡æ¢:</b> åœ¨åˆ—è¡¨é¡¶éƒ¨ï¼Œæ‚¨å¯ä»¥åœ¨ \"æˆ‘çš„ä¼™ä¼´\"ã€\"ä¸‹çº¿ä¼™ä¼´\" æˆ– \"å…¨éƒ¨\" ä¹‹é—´è¿›è¡Œç­›é€‰ã€‚",
            guideProspectsLi5: "<b>æœç´¢ã€ç­›é€‰å’Œæ’åº:</b> ä½¿ç”¨æœç´¢æ æŒ‰å§“åã€ç”µè¯å·ç æˆ–æ ‡ç­¾æŸ¥æ‰¾æŸäººã€‚ä½¿ç”¨ çŠ¶æ€ç­›é€‰ ä¸‹æ‹‰èœå•æŒ‰å½“å‰çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œä»…æ˜¾ç¤ºâ€œå·²åŠ å…¥â€çš„ä¼™ä¼´ï¼‰æ¥ç¼©å°åˆ—è¡¨èŒƒå›´ã€‚æ‚¨è¿˜å¯ä»¥æŒ‰æ—¥æœŸã€å§“åæˆ–çŠ¶æ€å¯¹ç»“æœè¿›è¡Œæ’åºã€‚",
            guideProspectsP3: "<b>åˆ†é¡µåŠŸèƒ½:</b> ä¸ºäº†ä¿æŒåˆ—è¡¨çš„æ•´æ´å’Œå¿«é€Ÿï¼Œä¼™ä¼´è¢«åˆ†æˆäº†å¤šä¸ªé¡µé¢ã€‚ä½¿ç”¨åº•éƒ¨çš„å¯¼èˆªæ§ä»¶åœ¨é¡µé¢ä¹‹é—´åˆ‡æ¢ã€‚",
            guideAnalyticsTitle: "5. æ•°æ®åˆ†æï¼šè¿½è¸ªæ‚¨çš„è¿›åº¦ ğŸ“Š",
            guideAnalyticsP1: "æ­¤é€‰é¡¹å¡é€šè¿‡å¯è§†åŒ–æ•°æ®å¸®åŠ©æ‚¨è¡¡é‡æ‚¨è‡ªå·±å’Œå›¢é˜Ÿçš„æ´»åŠ¨è¿›å±•ã€‚",
            guideAnalyticsP2: "<b>ç­›é€‰å™¨:</b>",
            guideAnalyticsLi1: "<b>è§†å›¾åˆ‡æ¢:</b>",
            guideAnalyticsLi2: "ä½¿ç”¨å¹²å‡€æ•´æ´çš„ç½‘æ ¼æ ·å¼ æœˆä»½é€‰æ‹©å™¨ æ¥é€‰æ‹©æ‚¨æƒ³æŸ¥çœ‹çš„æœˆä»½ã€‚",
            guideAnalyticsLi3: "åœ¨â€œä¸‹çº¿æ”¯æŒåˆ†æâ€è§†å›¾ä¸­ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ ç­›é€‰ä¸‹çº¿ ä¸‹æ‹‰èœå•æŸ¥çœ‹ç‰¹å®šä¸‹çº¿æˆ–æ‰€æœ‰ä¸‹çº¿çš„ç»Ÿè®¡æ•°æ®ã€‚",
            guideAnalyticsP3: "<b>6ä¸ªæœˆè¡¨ç°è¶‹åŠ¿å›¾:</b> è¿™ä¸ªäº¤äº’å¼æŠ˜çº¿å›¾å°†æ‚¨è¿‡å»å…­ä¸ªæœˆçš„å››ä¸ªå…³é”®æŒ‡æ ‡ï¼ˆæ–°å¢STPã€æ–°å¢GMSã€æˆåŠŸåŠ å…¥ã€ä¸åˆé€‚/ä¸åŠ å…¥ï¼‰è¿›è¡Œå¯è§†åŒ–ã€‚å°†é¼ æ ‡æ‚¬åœåœ¨å›¾ä¸Šçš„ä»»ä½•ç‚¹ä¸Šå¯ä»¥æŸ¥çœ‹è¯¦ç»†æ•°å­—ï¼Œç‚¹å‡»é¡¶éƒ¨çš„å›¾ä¾‹å¯ä»¥åˆ‡æ¢æ˜¾ç¤ºä¸åŒçš„æ•°æ®çº¿ã€‚",
            guideSettingsTitle: "6. è®¾ç½®ï¼šæ•°æ®ç®¡ç†ä¸åŒæ­¥ âš™ï¸",
            guideSettingsP1: "æ‚¨å¯ä»¥åœ¨è¿™é‡Œç®¡ç†æ‚¨çš„åº”ç”¨ç¨‹åºæ•°æ®ã€‚",
            guideSettingsP2: "<b>æ•°æ®çŠ¶æ€:</b> ä¸€ç›®äº†ç„¶åœ°æŸ¥çœ‹æ‚¨çš„æ•°æ®ä¸Šæ¬¡åŒæ­¥çš„æ—¶é—´ä»¥åŠæ‚¨æ‹¥æœ‰çš„ä¼™ä¼´æ€»æ•°ã€‚",
            guideSettingsP3: "<b>å±é™©åŒºåŸŸ:</b>",
            guideSettingsLi1: "<b>å¤‡ä»½ä¸åŒæ­¥:</b> è¿™æ˜¯ç¡®ä¿æ‚¨çš„æ•°æ®å®‰å…¨å¹¶åœ¨ä¸åŒè®¾å¤‡é—´åŒæ­¥çš„æœ€é‡è¦åŠŸèƒ½ã€‚<ul><li><b>å¯¼å‡ºæ•°æ®:</b> ç‚¹å‡»æ­¤æŒ‰é’®ï¼Œå°†æ‚¨æ‰€æœ‰çš„ä¼™ä¼´å’Œå¯ç”¨æ—¶é—´æ•°æ®ä¸‹è½½åˆ°ä¸€ä¸ªå¤‡ä»½æ–‡ä»¶ï¼ˆ.jsonï¼‰ä¸­ã€‚è¯¥æ–‡ä»¶å°†ä»¥å½“å‰æ—¥æœŸå’Œæ—¶é—´å‘½åã€‚</li><li><b>å¯¼å…¥æ•°æ®:</b> åœ¨å¦ä¸€å°è®¾å¤‡ä¸Šï¼ˆæˆ–åŒä¸€å°è®¾å¤‡ä¸Šï¼‰ï¼Œç‚¹å‡»æ­¤æŒ‰é’®å¹¶é€‰æ‹©æ‚¨ä¹‹å‰å¯¼å‡ºçš„å¤‡ä»½æ–‡ä»¶ã€‚ç¡®è®¤æ“ä½œåï¼Œå½“å‰æ•°æ®å°†è¢«è¦†ç›–ï¼Œä»è€Œå®ç°è®¾å¤‡é—´çš„åŒæ­¥ã€‚</li></ul>",
            guideSettingsLi2: "<b>æ¸…é™¤æ‰€æœ‰æ•°æ®:</b> è¯·è°¨æ…ä½¿ç”¨æ­¤åŠŸèƒ½ï¼ è¿™å°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰çš„ä¼™ä¼´è®°å½•å’Œå¯ç”¨æ—¶é—´æ•°æ®ã€‚æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚",
            guidePeriodLingchen: "å‡Œæ™¨", guidePeriodZaoshang: "æ—©ä¸Š", guidePeriodZhongwu: "ä¸­åˆ", guidePeriodXiawu: "ä¸‹åˆ", guidePeriodBangwan: "å‚æ™š", guidePeriodWanshang: "æ™šä¸Š",
            analyticsTrendTitle: "6ä¸ªæœˆè¡¨ç°è¶‹åŠ¿",
            copyStpBtn: "å¤åˆ¶STPåˆ—è¡¨", copyGmsBtn: "å¤åˆ¶GMSåˆ—è¡¨", copied: "å·²å¤åˆ¶!",
            welcome: "æ¬¢è¿é’»çŸ³ä»¬!"
        },
        'en': {
            tabCalendar: "Calendar", appTitle: "Amway Prospect TrackerğŸ’", addProspectBtn: "â• Add New Prospect", tabDashboard: "Dashboard", tabAllProspects: "All Prospects", tabAnalytics: "Analytics", tabSettings: "Settings", tabGuide: "Guide",
            upcomingAppointmentsTitle: "Upcoming Appointments ğŸ“…", followUpTitle: "Follow-up Needed ğŸ“", noAppointmentsText: "No upcoming appointments.", noFollowUpsText: "No prospects to follow up with right now.",
            allProspectsTitle: "All Prospects", analyticsTitle: "Monthly Analytics", analyticsMonthLabel: "Select Month:", settingsTitle: "Data & Settings", 
            backupSyncTitle: "Backup & Sync", backupSyncDesc: "Export all your data (prospects and availability) to a single file. You can save this file as a backup or import it on another device to sync your data.",
            exportData: "Export Data", importDataLabel: "Import Data", importConfirm: "Are you sure you want to overwrite all current data with the data from this file? This action cannot be undone.", importSuccess: "Data imported successfully!", importError: "Invalid or corrupted file.",
            dangerZoneTitle: "Danger Zone", dangerZoneDesc: "This action will permanently delete all your prospect and availability data.",
            clearData: "Clear All Data", modalTitleAdd: "Add New Prospect", modalTitleEdit: "Edit Prospect Info", labelName: "Name:", labelPhone: "Phone:", labelAge: "Age:",
            labelOccupation: "Occupation:", labelTags: "Tags (comma-separated):", tagsPlaceholder: "e.g. Student, Penang, Friend", labelStpTime: "STP Appointment Time:", labelNotes: "Notes:",
            saveProspectBtn: "Save", status: "Status", kitCounter: "Follow-up Count", actions: "Actions", confirmClearData: "Are you sure you want to permanently delete all data?",
            dataCleared: "All data has been cleared.", searchPlaceholder: "Search by name, phone, or tag...", dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], dayDetailsTitle: "Appointments for",
            sort: { label: "Sort by:", newest: "Newest First (STP Date)", name_az: "Name (A-Z)", name_za: "Name (Z-A)", status: "Status" },
            buttonEdit: "Edit", buttonDelete: "Delete", confirmDelete: "Are you sure you want to permanently delete this prospect? This action cannot be undone.",
            plannerTitle: "Daily Availability Planner", plannerAppointmentsTitle: "Confirmed Appointments", plannerTimelineTitle: "Set Your Availability", saveAvailability: "Save Availability", noAppointmentsToday: "No appointments today",
            legendAvailable: "Available", legendBooked: "Booked", legendBusy: "Busy", legendStp: "STP Appointment", legendGms: "GMS Appointment",
            sidebarTitle: "Upcoming Available Slots", noAvailableSlots: "No available slots found.", availabilityModalTitle: "Upcoming Available Slots", allStatuses: "All Statuses",
            ownerTypeLabel: "This prospect belongs to:", ownerUserOption: "Myself", ownerDownlineOption: "My Downline", downlineNameLabel: "Downline's Name:", downlineInfo: "Downline's Prospect: ",
            prospectViewToggleMine: "My Prospects", prospectViewToggleDownlines: "Downline's", prospectViewToggleAll: "All",
            analyticsViewToggleMine: "My Analytics", analyticsViewToggleDownlines: "Downline Support", downlineFilterLabel: "Filter by Downline:", allDownlinesOption: "All Downlines",
            errorDoubleBooking: "This time slot is already booked. Please choose another time.", errorDownlineNameRequired: "Please enter the downline's name.",
            confirmJoin: "Are you sure you want to mark this prospect as 'Joined'?", confirmDisqualify: "Are you sure you want to mark this prospect as 'Disqualified'?", confirmNotJoining: "Are you sure you want to mark this prospect as 'Not Joining'?",
            STP: "STP Scheduled", GMS_Appointment: "GMS Scheduled", KIT_STP: "Keep In Touch (Post-STP)", KIT_GMS: "Keep In Touch (Post-GMS)", Joined: "Joined",
            Disqualified: "Disqualified", Not_Joining: "Not Joining", actionScheduleGMS: "Schedule GMS", actionKeepInTouch: "Keep In Touch", actionDisqualify: "Disqualify",
            actionJoined: "Mark as Joined", actionNotJoining: "Mark as Not Joining", actionFollowUp: "Follow Up", actionEditGMS: "Edit GMS Time", actionModalTitle: "Update Prospect Status",
            labelGmsTime: "GMS Appointment Time:", labelActionNotes: "Follow-up Notes (Optional):", confirmActionBtn: "Confirm", phone: "Phone", age: "Age",
            occupation: "Occupation", kit_counter: "KIT Count", stp_time: "STP Time", notes: "Notes", name: "Name",
            analytics: { new_stps: "New STPs", new_gms: "New GMS", new_joins: "New Joins", new_disqualified: "Disqualified / Not Joining" },
            guideMainTitle: "Amway Prospect Tracker - User Guide",
            guideGettingStartedTitle: "1. Getting Started: How to Use This File",
            guideGettingStartedP1: "Welcome! This tracker is a standalone, single-file application. You don't need to install any special software to use it.",
            guideGettingStartedP2: "To begin:",
            guideGettingStartedLi1: "<b>Save the File:</b> Save the .html file to a convenient location on your computer, like your Desktop or a dedicated folder.",
            guideGettingStartedLi2: "<b>Open the File:</b> To launch the application, simply double-click the file. It will open in your default web browser (Google Chrome, Firefox, or Microsoft Edge are recommended).",
            guideGettingStartedLi3: "<b>Important Note on Data Storage:</b> Your data (all prospects, availability, etc.) is saved directly in your web browser's local storage. This means:<ul><li><b>It's Private:</b> Your data stays on your computer and is not sent over the internet.</li><li><b>It's Browser-Specific:</b> Data saved while using Chrome will not be visible if you open the file in Firefox, and vice-versa. Always use the same browser for consistency.</li><li><b>It's Device-Specific:</b> The data will not automatically sync to another computer or your phone. Please use the 'Backup & Sync' feature for this.</li></ul>",
            guideInterfaceTitle: "2. The Main Interface ğŸ—ºï¸",
            guideInterfaceP1: "The application is designed to be responsive and looks great on desktop, tablet, or phone.",
            guideInterfaceLi1: "<b>Main Content Area:</b> This is where you'll interact with your data through different tabs.",
            guideInterfaceLi2: "<b>Sidebar (Desktop View):</b> On larger screens, this panel automatically shows your upcoming available time slots for quick scheduling.",
            guideInterfaceLi3: "<b>Floating Button (Mobile/Tablet View):</b> On smaller screens, the sidebar is replaced by a floating calendar button (ğŸ“…) in the bottom-right corner. Tapping this opens a pop-up with your available slots.",
            guideDashboardTitle: "3. Managing Your Day: The Dashboard & Calendar",
            guideDashboardP1: "<b>The Dashboard Tab</b><br>This is your home screen, giving you a quick overview of what's important:",
            guideDashboardLi1: "<b>Upcoming Appointments ğŸ“…:</b> Shows all your future STP and GMS appointments, sorted by the soonest first.",
            guideDashboardLi2: "<b>One-Click Copy Buttons:</b> Next to the title, you will find 'Copy STP List' and 'Copy GMS List'. Clicking these will copy a pre-formatted summary of your upcoming appointments for that category, ready to paste into WhatsApp or other messaging apps to update your upline.",
            guideDashboardLi3: "<b>Follow-up Needed ğŸ“:</b> Lists all prospects currently in the 'Keep In Touch' (KIT) stage.",
            guideCalendarTitle: "The Calendar Tab & Availability Planner",
            guideCalendarP1: "This is your command center for time management.",
            guideCalendarP2: "<b>Daily Availability Planner:</b> Click on any day in the calendar to open the planner. In this pop-up, you can:",
            guideCalendarLi1: "<b>View Confirmed Appointments:</b> See a list of who you're meeting that day.",
            guideCalendarLi2: "<b>Set Your Free Time:</b> Click on the 30-minute time slots to mark them as available.",
            guideCalendarLi3: "<b>Save:</b> Click 'Save Availability'. The times you marked will now appear in the sidebar or the floating button's pop-up.",
            guideProspectsTitle: "4. Managing Your Prospects: The All Prospects Tab",
            guideProspectsP1: "<b>Adding and Editing a Prospect:</b>",
            guideProspectsLi1: "Click the â• Add New Prospect button in the header.",
            guideProspectsLi2: "In the form, you can specify if the prospect belongs to 'Myself' or 'My Downline'. If you select a downline, you can choose an existing one from a list or type a new name.",
            guideProspectsLi3: "Fill in all details and click Save. The elegant date and time picker makes scheduling intuitive.",
            guideProspectsP2: "<b>Filtering and Sorting:</b>",
            guideProspectsLi4: "<b>View Toggles:</b> At the top, you can filter between 'My Prospects', 'Downline's', or 'All'.",
            guideProspectsLi5: "<b>Search, Filter, and Sort:</b> Use the search bar to find someone by name, phone, or tag. Use the Status Filter dropdown to narrow the list by their current status (e.g., show only 'Joined' prospects). You can also sort the results by date, name, or status.",
            guideProspectsP3: "<b>Pagination:</b> To keep the list clean and fast, prospects are shown on pages. Use the navigation controls at the bottom to move between pages.",
            guideAnalyticsTitle: "5. Tracking Your Progress: The Analytics Tab ğŸ“Š",
            guideAnalyticsP1: "This tab helps you measure your activity and your team's progress with visual data.",
            guideAnalyticsP2: "<b>Filters:</b>",
            guideAnalyticsLi1: "<b>View Toggles:</b>",
            guideAnalyticsLi2: "Use the clean, grid-style Month Picker to select the month you want to review.",
            guideAnalyticsLi3: "When in 'Downline Support' view, you can use the Filter by Downline dropdown to see statistics for a specific downline or all of them combined.",
            guideAnalyticsP3: "<b>6-Month Performance Trend Chart:</b> This interactive line chart visualizes your performance over the last six months for your four key metrics. Hover over any point to see details, and click the legend at the top to toggle lines on or off.",
            guideSettingsTitle: "6. Settings: Data Management & Syncing âš™ï¸",
            guideSettingsP1: "This is where you manage your application data.",
            guideSettingsP2: "<b>Data Status:</b> See at a glance when your data was last synced and the total number of prospects you have.",
            guideSettingsP3: "<b>Danger Zone:</b>",
            guideSettingsLi1: "<b>Backup & Sync:</b> This is the most important feature for keeping your data safe and synchronized across devices.<ul><li><b>Export Data:</b> Click this to download a backup file (.json) of all your prospects and availability data. The file will be named with the current date and time.</li><li><b>Import Data:</b> On another device (or the same one), click this button and select the backup file you exported. Confirm the action to overwrite the current data, effectively syncing your devices.</li></ul>",
            guideSettingsLi2: "<b>Clear All Data:</b> Use with caution! This will permanently delete all prospect records and availability data. This action cannot be undone.",
            analyticsTrendTitle: "6-Month Performance Trend",
            copyStpBtn: "Copy STP List", copyGmsBtn: "Copy GMS List", copied: "Copied!",
            welcome: "Welcome Diamonds!"
        }
    };
    let currentLang = 'zh-CN';
    let calendarDate = new Date();
    let prospects = [];
    let availability = {};
    let prospectViewFilter = 'user'; 
    let analyticsView = 'user'; 
    let lastSyncTimestamp = null;

    // --- START: NEW EVENT LISTENERS & LOGIC FOR LOGIN PAGE ---
    const forgotPasswordModal = document.getElementById('forgot-password-modal');
    
    document.getElementById('forgot-password-link').addEventListener('click', (e) => {
        e.preventDefault();
        forgotPasswordModal.style.display = 'flex';
    });
    
    document.getElementById('close-forgot-password-modal').onclick = () => {
        forgotPasswordModal.style.display = 'none';
    };
    
    document.getElementById('send-reset-btn').addEventListener('click', async () => {
        const email = document.getElementById('reset-email').value;
        if (!email) {
            alert('Please enter your email address.');
            return;
        }
        const { error } = await supabase.auth.resetPasswordForEmail(email, {
            redirectTo: window.location.href.split('#')[0],
        });

        if (error) {
            alert(`Error: ${error.message}`);
        } else {
            alert('Password reset instructions have been sent to your email.');
            forgotPasswordModal.style.display = 'none';
        }
    });

    document.getElementById('password-toggle').addEventListener('click', (e) => {
        const passwordInput = document.getElementById('auth-password');
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        e.target.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
    });
    // --- END: New Event Listeners & Logic for Login Page ---


    function setLanguage(lang) {
        currentLang = lang; 
        document.documentElement.lang = lang; 
        localStorage.setItem('preferredLanguage', lang); // Save preference
        const t = translations[lang];

        // Set locale for flatpickr instances
        const locale = lang === 'zh-CN' ? 'zh' : 'default';
        stpPicker.set('locale', locale);
        gmsPicker.set('locale', locale);
        analyticsPicker.set('locale', locale);

        const elements = {
            appTitle: t.appTitle, 'add-prospect-btn': t.addProspectBtn, 'lang-toggle': lang === 'zh-CN' ? 'English' : 'ä¸­æ–‡', tabDashboard: t.tabDashboard, tabCalendar: t.tabCalendar,
            tabAllProspects: t.tabAllProspects, tabAnalytics: t.tabAnalytics, tabSettings: t.tabSettings, tabGuide: t.tabGuide,
            upcomingAppointmentsTitle: t.upcomingAppointmentsTitle, followUpTitle: t.followUpTitle,
            allProspectsTitle: t.allProspectsTitle, analyticsTitle: t.analyticsTitle, analyticsMonthLabel: t.analyticsMonthLabel, settingsTitle: t.settingsTitle,
            backupSyncTitle: t.backupSyncTitle, backupSyncDesc: t.backupSyncDesc, exportData: t.exportData, importDataLabel: t.importDataLabel,
            dangerZoneTitle: t.dangerZoneTitle, dangerZoneDesc: t.dangerZoneDesc,
            clearData: t.clearData, modalTitleAdd: t.modalTitleAdd, modalTitleEdit: t.modalTitleEdit, labelName: t.labelName, labelPhone: t.labelPhone, labelAge: t.labelAge,
            labelOccupation: t.labelOccupation, labelTags: t.labelTags, labelStpTime: t.labelStpTime, labelNotes: t.labelNotes, 'save-prospect-btn': t.saveProspectBtn,
            labelGmsTime: t.labelGmsTime, labelActionNotes: t.labelActionNotes, 'confirm-action-btn': t.confirmActionBtn, 'action-modal-title': t.actionModalTitle,
            'planner-appointments-title': t.plannerAppointmentsTitle, 'planner-timeline-title': t.plannerTimelineTitle, 'save-availability-btn': t.saveAvailability,
            'legend-available': t.legendAvailable, 'legend-booked': t.legendBooked, 'legend-busy': t.legendBusy, 'legend-stp': t.legendStp, 'legend-gms': t.legendGms,
            'sidebar-title': t.sidebarTitle, 'availability-modal-title': t.availabilityModalTitle,
            'owner-type-label': t.ownerTypeLabel, 'owner-user-option': t.ownerUserOption, 'owner-downline-option': t.ownerDownlineOption,
            'downline-name-label': t.downlineNameLabel, 'downline-filter-label': t.downlineFilterLabel,
            
            'guide-main-title': t.guideMainTitle, 
            'guide-getting-started-title': t.guideGettingStartedTitle, 
            'guide-getting-started-p1': t.guideGettingStartedP1,
            'guide-getting-started-p2': t.guideGettingStartedP2,
            'guide-getting-started-li1': t.guideGettingStartedLi1,
            'guide-getting-started-li2': t.guideGettingStartedLi2,
            'guide-getting-started-li3': t.guideGettingStartedLi3,

            'guide-interface-title': t.guideInterfaceTitle, 
            'guide-interface-p1': t.guideInterfaceP1,
            'guide-interface-li1': t.guideInterfaceLi1,
            'guide-interface-li2': t.guideInterfaceLi2,
            'guide-interface-li3': t.guideInterfaceLi3,

            'guide-dashboard-title': t.guideDashboardTitle,
            'guide-dashboard-p1': t.guideDashboardP1,
            'guide-dashboard-li1': t.guideDashboardLi1,
            'guide-dashboard-li2': t.guideDashboardLi2,
            'guide-dashboard-li3': t.guideDashboardLi3,

            'guide-calendar-title': t.guideCalendarTitle,
            'guide-calendar-p1': t.guideCalendarP1,
            'guide-calendar-p2': t.guideCalendarP2,
            'legend-stp-guide': t.legendStp, 'legend-gms-guide': t.legendGms, 
            'guide-calendar-li1':t.guideCalendarLi1, 'guide-calendar-li2':t.guideCalendarLi2, 'guide-calendar-li3':t.guideCalendarLi3,

            'guide-prospects-title': t.guideProspectsTitle, 
            'guide-prospects-p1': t.guideProspectsP1,
            'guide-prospects-li1': t.guideProspectsLi1,
            'guide-prospects-li2': t.guideProspectsLi2,
            'guide-prospects-li3': t.guideProspectsLi3,
            'guide-prospects-p2': t.guideProspectsP2,
            'guide-prospects-li4': t.guideProspectsLi4,
            'guide-prospects-li5': t.guideProspectsLi5,
            'guide-prospects-p3': t.guideProspectsP3,

            'guide-analytics-title': t.guideAnalyticsTitle,
            'guide-analytics-p1': t.guideAnalyticsP1,
            'guide-analytics-li1': t.guideAnalyticsLi1,
            'guide-analytics-p2': t.guideAnalyticsP2,
            'guide-analytics-li2': t.guideAnalyticsLi2,
            'guide-analytics-li3': t.guideAnalyticsLi3,
            'guide-analytics-p3': t.guideAnalyticsP3,

            'guide-settings-title': t.guideSettingsTitle,
            'guide-settings-p1': t.guideSettingsP1,
            'guide-settings-li1': t.guideSettingsLi1,
            'guide-settings-p2': t.guideSettingsP2,
            'guide-settings-p3': t.guideSettingsP3,
            'guide-settings-li2': t.guideSettingsLi2,

            'analytics-trend-title': t.analyticsTrendTitle, 'copy-stp-btn': t.copyStpBtn, 'copy-gms-btn': t.copyGmsBtn, 'welcome-text': t.welcome
        };
        for (const id in elements) { 
            const el = document.getElementById(id);
            if (el) el.innerHTML = elements[id];
        }

        const statusFilter = document.getElementById('status-filter');
        const statuses = ['STP', 'GMS_Appointment', 'KIT_STP', 'KIT_GMS', 'Joined', 'Disqualified', 'Not_Joining'];
        let statusOptionsHtml = `<option value="all">${t.allStatuses}</option>`;
        statuses.forEach(status => {
            statusOptionsHtml += `<option value="${status}">${t[status]}</option>`;
        });
        statusFilter.innerHTML = statusOptionsHtml;

        document.getElementById('search-input').placeholder = t.searchPlaceholder;
        document.getElementById('tags').placeholder = t.tagsPlaceholder;
        const sortSelect = document.getElementById('sort-by');
        sortSelect.innerHTML = `<option value="newest">${t.sort.newest}</option><option value="name_az">${t.sort.name_az}</option><option value="name_za">${t.sort.name_za}</option><option value="status">${t.sort.status}</option>`;
        
    }
    
    async function renderAll() { 
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const { data: prospectsData, error: prospectsError } = await supabase
            .from('prospects')
            .select('*')
            .eq('user_id', user.id);

        const { data: availabilityData, error: availabilityError } = await supabase
            .from('availability')
            .select('*')
            .eq('user_id', user.id);

        if (prospectsData) {
            prospects = prospectsData;
        } else {
            prospects = [];
        }
        if (availabilityData) {
            availability = availabilityData.reduce((acc, curr) => {
                acc[curr.date] = curr.time_slots;
                return acc;
            }, {});
        } else {
            availability = {};
        }
        
        populateDownlineDatalist();
        renderDashboard(); 
        renderProspectList(); 
        renderCalendar(); 
        if (document.getElementById('analytics').classList.contains('active')) {
            populateDownlineFilter();
            renderAnalytics();
        }
        renderAvailableSlotsSidebar(); 
        renderToggles(); 
        renderDataStatus();
    }
    
    const stpPicker = flatpickr("#stp-datetime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });
    const gmsPicker = flatpickr("#gms-datetime", { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });
    const analyticsPicker = flatpickr("#analytics-month", { 
        plugins: [ new monthSelectPlugin({ shorthand: false, dateFormat: "Y-m", altFormat: "F Y" }) ],
        altInput: true,
        onChange: () => renderAnalytics() 
    });
    
    const prospectModal = document.getElementById('prospect-modal'); 
    const actionModal = document.getElementById('action-modal');
    const plannerModal = document.getElementById('planner-modal');
    const availabilityModal = document.getElementById('availability-modal');
    const showAvailabilityFab = document.getElementById('show-availability-fab');

    document.getElementById('add-prospect-btn').onclick = () => { document.getElementById('prospect-form').reset(); stpPicker.clear(); document.getElementById('prospect-id').value = ''; document.getElementById('modal-title').textContent = translations[currentLang].modalTitleAdd; document.getElementById('downline-name-group').style.display = 'none'; prospectModal.style.display = 'flex'; };
    document.getElementById('close-modal').onclick = () => prospectModal.style.display = 'none';
    document.getElementById('action-close-modal').onclick = () => actionModal.style.display = 'none';
    document.getElementById('close-planner-modal').onclick = () => plannerModal.style.display = 'none';
    document.getElementById('close-availability-modal').onclick = () => availabilityModal.style.display = 'none';
    showAvailabilityFab.onclick = () => availabilityModal.style.display = 'flex';
    document.getElementById('lang-toggle').addEventListener('click', () => setLanguage(currentLang === 'zh-CN' ? 'en' : 'zh-CN'));
    
    window.addEventListener('click', (e) => {
        if (!e.target.closest('.card-menu-container')) {
            document.querySelectorAll('.card-menu.open').forEach(menu => menu.classList.remove('open'));
        }
        if (e.target == prospectModal) prospectModal.style.display = 'none'; 
        if (e.target == actionModal) actionModal.style.display = 'none'; 
        if (e.target == plannerModal) plannerModal.style.display = 'none';
        if (e.target == availabilityModal) availabilityModal.style.display = 'none';
        if (e.target == forgotPasswordModal) forgotPasswordModal.style.display = 'none';
    });
    
    document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab).classList.add('active'); if(button.dataset.tab === 'analytics') { populateDownlineFilter(); renderAnalytics(); } }); });
    
    document.getElementById('owner-type').addEventListener('change', (e) => {
        document.getElementById('downline-name-group').style.display = e.target.value === 'downline' ? 'block' : 'none';
    });

    document.getElementById('prospect-form').addEventListener('submit', async (e) => {
        e.preventDefault(); 
        const id = document.getElementById('prospect-id').value;
        const stpTimeValue = document.getElementById('stp-datetime').value;
        if (!stpTimeValue) { alert('Please select an STP time.'); return; }
        const stpTime = new Date(stpTimeValue).toISOString();

        const ownerType = document.getElementById('owner-type').value;
        const downlineName = document.getElementById('downline-name').value.trim();

        if (ownerType === 'downline' && !downlineName) {
            alert(translations[currentLang].errorDownlineNameRequired);
            return;
        }
        if (isTimeSlotBooked(stpTimeValue, id)) {
            alert(translations[currentLang].errorDoubleBooking);
            return;
        }

        const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
        const newNote = document.getElementById('notes').value;
        
        const { data: { user } } = await supabase.auth.getUser();

        const prospectData = {
            name: document.getElementById('name').value,
            phone: document.getElementById('phone').value,
            age: document.getElementById('age').value || null,
            occupation: document.getElementById('occupation').value,
            tags: tags,
            stp_time: stpTime,
            owner_type: ownerType,
            downline_name: downlineName,
            user_id: user.id
        };

        if (id) { // Edit
            const originalStpTime = document.getElementById('original-stp-time').value;
            const { data, error } = await supabase.from('prospects').update(prospectData).eq('id', id);

            if (error) {
                console.error('Error updating prospect:', error);
            } else {
                 if (newNote) {
                    const { data: currentProspect, error: fetchError } = await supabase.from('prospects').select('notes').eq('id', id).single();
                    if (currentProspect) {
                        const updatedNotes = currentProspect.notes || [];
                        updatedNotes.push({ date: new Date().toISOString(), content: `[EDIT] ${newNote}` });
                        await supabase.from('prospects').update({ notes: updatedNotes }).eq('id', id);
                    }
                }
                if (originalStpTime !== stpTime) {
                    await addBackAvailabilityToDB(new Date(originalStpTime).toISOString());
                    await removeBookedSlotFromDB(stpTimeValue);
                }
            }
        } else { // New
            prospectData.notes = newNote ? [{ date: new Date().toISOString(), content: newNote }] : [];
            prospectData.status = 'STP';
            prospectData.kit_counter = 0;
            const { data, error } = await supabase.from('prospects').insert([prospectData]);
            if (error) {
                console.error('Error creating prospect:', error);
            } else {
                await removeBookedSlotFromDB(stpTimeValue);
            }
        }
        
        prospectModal.style.display = 'none';
    });

    document.getElementById('action-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        const id = document.getElementById('action-prospect-id').value; 
        const action = document.getElementById('action-type').value; 
        const index = prospects.findIndex(p => p.id == id); 
        if (index === -1) return;
        
        const p = prospects[index]; 
        const notes = document.getElementById('action-notes').value; 
        if(notes) {
            if(!p.notes) p.notes = [];
            p.notes.push({ date: new Date().toISOString(), content: `[${action}] ${notes}` });
        }
        if (!p.tags) p.tags = [];
        
        const gmsTimeValue = document.getElementById('gms-datetime').value;
        if ((action === 'schedule_gms' || action === 'edit_gms') && isTimeSlotBooked(gmsTimeValue, p.id)) {
            alert(translations[currentLang].errorDoubleBooking);
            return;
        }
        
        let confirmAction = true;
        if (action === 'joined') confirmAction = confirm(translations[currentLang].confirmJoin);
        if (action === 'disqualify') confirmAction = confirm(translations[currentLang].confirmDisqualify);
        if (action === 'not_joining') confirmAction = confirm(translations[currentLang].confirmNotJoining);

        if (!confirmAction) return;
        
        let updateData = { notes: p.notes, tags: p.tags };

        switch(action) {
            case 'schedule_gms': 
                Object.assign(updateData, { status: 'GMS_Appointment', gms_time: new Date(gmsTimeValue).toISOString(), kit_counter: 0 });
                await removeBookedSlotFromDB(gmsTimeValue);
                break;
            case 'edit_gms':
                const originalGmsTime = document.getElementById('original-gms-time').value;
                Object.assign(updateData, { gms_time: new Date(gmsTimeValue).toISOString() });
                if(originalGmsTime !== gmsTimeValue) {
                    await addBackAvailabilityToDB(originalGmsTime);
                    await removeBookedSlotFromDB(gmsTimeValue);
                }
                break;
            case 'kit_stp': 
                Object.assign(updateData, { status: 'KIT_STP', kit_counter: 1 });
                break;
            case 'kit_gms': 
                Object.assign(updateData, { status: 'KIT_GMS', kit_counter: 1 });
                break;
            case 'disqualify': 
                Object.assign(updateData, { status: 'Disqualified' });
                break;
            case 'not_joining': 
                Object.assign(updateData, { status: 'Not_Joining' });
                break;
            case 'joined': 
                Object.assign(updateData, { status: 'Joined' });
                break;
            case 'follow_up': 
                Object.assign(updateData, { kit_counter: (p.kit_counter || 0) + 1 });
                break;
        }

        const { data, error } = await supabase.from('prospects').update(updateData).eq('id', id);
        if (error) console.error('Error updating prospect status:', error);
        
        actionModal.style.display = 'none';
    });

    function openActionModal(id, action) {
        const p = prospects.find(prospect => prospect.id == id);
        if(!p) return;
        document.getElementById('action-form').reset(); 
        gmsPicker.clear(); 
        document.getElementById('action-prospect-id').value = id; 
        document.getElementById('action-type').value = action; 
        const gmsGroup = document.getElementById('gms-schedule-group'); 
        gmsGroup.style.display = (action === 'schedule_gms' || action === 'edit_gms') ? 'block' : 'none'; 
        document.getElementById('gms-datetime').required = (action === 'schedule_gms' || action === 'edit_gms');
        if (action === 'edit_gms' && p.gms_time) {
            gmsPicker.setDate(new Date(p.gms_time), true);
            document.getElementById('original-gms-time').value = new Date(p.gms_time).toISOString();
        }
        actionModal.style.display = 'flex';
    }

    function openEditModal(prospectId) {
        const p = prospects.find(p => p.id == prospectId);
        if (!p) return;
        
        document.getElementById('prospect-form').reset();
        document.getElementById('modal-title').textContent = translations[currentLang].modalTitleEdit;
        document.getElementById('prospect-id').value = p.id; 
        document.getElementById('name').value = p.name;
        document.getElementById('phone').value = p.phone; 
        document.getElementById('age').value = p.age;
        document.getElementById('occupation').value = p.occupation; 
        document.getElementById('tags').value = p.tags ? p.tags.join(', ') : '';
        document.getElementById('owner-type').value = p.owner_type || 'user';
        const downlineGroup = document.getElementById('downline-name-group');
        if (p.owner_type === 'downline') {
            downlineGroup.style.display = 'block';
            document.getElementById('downline-name').value = p.downline_name;
        } else {
            downlineGroup.style.display = 'none';
        }
        stpPicker.setDate(new Date(p.stp_time), true); 
        document.getElementById('original-stp-time').value = new Date(p.stp_time).toISOString();
        document.getElementById('notes').value = ''; 
        prospectModal.style.display = 'flex';
    }

    async function deleteProspect(prospectId) {
        if (confirm(translations[currentLang].confirmDelete)) {
            const prospectToDelete = prospects.find(p => p.id == prospectId);
            const { error } = await supabase.from('prospects').delete().eq('id', prospectId);

            if (error) {
                console.error('Error deleting prospect:', error);
            } else {
                if (prospectToDelete) {
                    await addBackAvailabilityToDB(prospectToDelete.stp_time);
                    await addBackAvailabilityToDB(prospectToDelete.gms_time);
                }
            }
        }
    }

    function formatChineseTime(date) {
        const hour = date.getHours();
        const minute = String(date.getMinutes()).padStart(2, '0');
        let period = '';
        const t = translations['zh-CN'];

        if (hour >= 0 && hour < 5) period = t.guidePeriodLingchen;
        else if (hour >= 5 && hour < 12) period = t.guidePeriodZaoshang;
        else if (hour === 12) period = t.guidePeriodZhongwu;
        else if (hour > 12 && hour < 18) period = t.guidePeriodXiawu;
        else if (hour === 18) period = t.guidePeriodBangwan;
        else period = t.guidePeriodWanshang;
        
        let displayHour = hour % 12;
        if (displayHour === 0) displayHour = 12; 
        
        return `${period} ${displayHour}:${minute}`;
    }

    function formatDate(dateString) { 
        if (!dateString) return 'N/A'; 
        const date = new Date(dateString);

        if (isNaN(date.getTime())) {
            return "N/A";
        }
        if (currentLang === 'zh-CN') {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${year}å¹´${month}æœˆ${day}æ—¥ ${formatChineseTime(date)}`;
        }
        return date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); 
    }
    
    function isTimeSlotBooked(dateTimeString, prospectIdToExclude = null) {
        if (!dateTimeString) return false;
        const newApptTime = new Date(dateTimeString).getTime();
        const thirtyMinutes = 30 * 60 * 1000;
        return prospects.some(p => {
            if (p.id == prospectIdToExclude) return false;
            const stpTime = p.stp_time ? new Date(p.stp_time).getTime() : 0;
            if (stpTime && Math.abs(newApptTime - stpTime) < thirtyMinutes) return true;
            const gmsTime = p.gms_time ? new Date(p.gms_time).getTime() : 0;
            if (gmsTime && Math.abs(newApptTime - gmsTime) < thirtyMinutes) return true;
            return false;
        });
    }

    function renderDashboard() {
        const appointmentsGrid = document.getElementById('appointments-grid'); 
        const followUpsGrid = document.getElementById('follow-ups-grid');
        appointmentsGrid.innerHTML = ''; 
        followUpsGrid.innerHTML = ''; 
        const now = new Date(); 
        let upcoming = [];
        prospects.forEach(p => {
            if (p.stp_time && new Date(p.stp_time) > now) upcoming.push({ p, type: 'STP', date: new Date(p.stp_time) });
            if (p.gms_time && new Date(p.gms_time) > now) upcoming.push({ p, type: 'GMS', date: new Date(p.gms_time) });
        });
        upcoming.sort((a, b) => a.date - b.date);
        if (upcoming.length === 0) appointmentsGrid.innerHTML = `<p>${translations[currentLang].noAppointmentsText}</p>`;
        else upcoming.forEach(item => { const card = document.createElement('div'); card.className = 'appointment-card'; card.innerHTML = `<h3>${item.p.name}</h3><p><strong>${item.type}:</strong> ${formatDate(item.date)}</p>`; appointmentsGrid.appendChild(card); });
        
        const followUps = prospects.filter(p => p.status && p.status.startsWith('KIT_'));
        if (followUps.length === 0) followUpsGrid.innerHTML = `<p>${translations[currentLang].noFollowUpsText}</p>`;
        else followUps.forEach(p => {
            const card = document.createElement('div'); card.className = 'reminder-card';
            card.innerHTML = `<h3>${p.name}</h3><p><strong>${translations[currentLang].status}:</strong> ${translations[currentLang][p.status]}</p><p><strong>${translations[currentLang].kitCounter}:</strong> ${p.kit_counter || 0}</p>
            <div class="prospect-actions"><button class="btn-primary" data-id="${p.id}" data-action="${p.status === 'KIT_STP' ? 'schedule_gms' : 'joined'}">${p.status === 'KIT_STP' ? translations[currentLang].actionScheduleGMS : translations[currentLang].actionJoined}</button>
            <button class="btn-warning" data-id="${p.id}" data-action="follow_up">${translations[currentLang].actionFollowUp}</button></div>`;
            followUpsGrid.appendChild(card);
        });
        followUpsGrid.querySelectorAll('.prospect-actions button').forEach(button => button.addEventListener('click', (e) => openActionModal(e.target.dataset.id, e.target.dataset.action)));
    }
    
    document.getElementById('copy-stp-btn').addEventListener('click', () => copyAppointmentsToClipboard('STP'));
    document.getElementById('copy-gms-btn').addEventListener('click', () => copyAppointmentsToClipboard('GMS'));

    function copyAppointmentsToClipboard(type) {
        const now = new Date();
        let upcoming = [];
        prospects.forEach(p => {
            if (p.stp_time && new Date(p.stp_time) > now) upcoming.push({ p, type: 'STP', date: new Date(p.stp_time) });
            if (p.gms_time && new Date(p.gms_time) > now) upcoming.push({ p, type: 'GMS', date: new Date(p.gms_time) });
        });

        const appointmentsToCopy = upcoming.filter(item => item.type === type);
        if (appointmentsToCopy.length === 0) return;

        const dayNames = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];

        let textToCopy = type === 'STP' ? 'STPèµ„æ–™\n' : 'GMSèµ„æ–™\n';
        appointmentsToCopy.forEach((item, index) => {
            const d = item.date;
            const formattedDate = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()} ${dayNames[d.getDay()]} ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
            if(type === 'STP') {
                textToCopy += `\n(${index+1})\n`;
                textToCopy += `åå­—ï¼š${item.p.name}\n`;
                textToCopy += `èŒä¸šï¼ˆå·¥ä½œ/è¯»ä¹¦ï¼‰ï¼š${item.p.occupation || ''}\n`;
                textToCopy += `å¹´é¾„ï¼š${item.p.age || ''}\n`;
                textToCopy += `é‚€çº¦æ—¶é—´ï¼š${formattedDate}\n`;
            } else { // GMS
                textToCopy += `\n(${index+1})\n`;
                textToCopy += `åå­— ï¼š${item.p.name}\n`;
                textToCopy += `å·ç  ï¼š${item.p.phone || ''}\n`;
                textToCopy += `å¹´é¾„ ï¼š${item.p.age || ''}\n`;
                const lastNote = item.p.notes && item.p.notes.length > 0 ? item.p.notes[item.p.notes.length - 1].content : '';
                textToCopy += `åŠ å…¥/ä¸åŠ å…¥ï¼š${lastNote}\n`;
                textToCopy += `é‚€çº¦æ—¶é—´ ï¼š${formattedDate}\n`;
            }
        });
        
        navigator.clipboard.writeText(textToCopy.trim()).then(() => {
            const btn = document.getElementById(`copy-${type.toLowerCase()}-btn`);
            const originalText = btn.textContent;
            btn.textContent = translations[currentLang].copied;
            setTimeout(() => { btn.textContent = originalText; setLanguage(currentLang); }, 2000);
        });
    }

    function renderPagination(totalProspects) {
        const paginationControls = document.getElementById('pagination-controls');
        paginationControls.innerHTML = '';
        const totalPages = Math.ceil(totalProspects / PROSPECTS_PER_PAGE);

        if (totalPages <= 1) return;

        let paginationHTML = `<button class="page-btn" id="prev-page" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
        for (let i = 1; i <= totalPages; i++) {
            paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
        }
        paginationHTML += `<button class="page-btn" id="next-page" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
        paginationControls.innerHTML = paginationHTML;

        document.querySelectorAll('.page-btn[data-page]').forEach(button => {
            button.onclick = () => {
                currentPage = Number(button.dataset.page);
                renderProspectList();
            };
        });
        document.getElementById('prev-page')?.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderProspectList();
            }
        });
        document.getElementById('next-page')?.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                renderProspectList();
            }
        });
    }

    function renderProspectList() {
        const listDiv = document.getElementById('prospect-list');
        listDiv.innerHTML = '';

        const searchQuery = document.getElementById('search-input').value.toLowerCase();
        const statusFilter = document.getElementById('status-filter').value;
        const sortBy = document.getElementById('sort-by').value;
        let prospectsToDisplay = prospects;

        if (prospectViewFilter === 'user') {
            prospectsToDisplay = prospects.filter(p => p.owner_type !== 'downline');
        } else if (prospectViewFilter === 'downline') {
            prospectsToDisplay = prospects.filter(p => p.owner_type === 'downline');
        }

        let filtered = prospectsToDisplay.filter(p => {
            const pStatus = p.status || 'STP';
            const matchesSearch = p.name.toLowerCase().includes(searchQuery) || (p.phone && p.phone.includes(searchQuery)) || (p.tags && p.tags.some(tag => tag.toLowerCase().includes(searchQuery)));
            const matchesStatus = (statusFilter === 'all' || pStatus === statusFilter);
            return matchesSearch && matchesStatus;
        });

        filtered.sort((a, b) => { switch (sortBy) { case 'name_az': return a.name.localeCompare(b.name); case 'name_za': return b.name.localeCompare(a.name); case 'status': return (a.status || 'STP').localeCompare(b.status || 'STP'); case 'newest': default: return new Date(b.stp_time) - new Date(a.stp_time); } });

        const startIndex = (currentPage - 1) * PROSPECTS_PER_PAGE;
        const endIndex = startIndex + PROSPECTS_PER_PAGE;
        const paginatedProspects = filtered.slice(startIndex, endIndex);

        if (paginatedProspects.length === 0) {
            listDiv.innerHTML = `<p>${translations[currentLang].noFollowUpsText}</p>`;
            renderPagination(0);
            return;
        }

        paginatedProspects.forEach(p => {
            const pStatus = p.status || 'STP';
            const card = document.createElement('div'); card.className = 'prospect-card'; const statusText = translations[currentLang][pStatus] || pStatus;
            let kitInfo = pStatus.startsWith('KIT_') ? ` (${translations[currentLang].kitCounter}: ${p.kit_counter || 0})` : '';
            let tagsHtml = p.tags && p.tags.length ? `<div class="tags-container">${p.tags.map(tag => `<span class="tag-badge">${tag}</span>`).join('')}</div>` : '';
            let notesHtml = p.notes && p.notes.map(note => `<small>${formatDate(note.date)}: ${note.content}</small>`).join('<br>') || '';
            let downlineHtml = p.owner_type === 'downline' ? `<div class="downline-info">ğŸ‘¤ ${translations[currentLang].downlineInfo}${p.downline_name}</div>` : '';
            card.innerHTML = `
                <div class="card-header">
                    <h3>${p.name} <span class="status-badge status-${pStatus}">${statusText}${kitInfo}</span></h3>
                    <div class="card-menu-container">
                        <button class="menu-toggle-btn" data-id="${p.id}">&#8942;</button>
                        <div class="card-menu" id="menu-${p.id}">
                            <a href="#" class="menu-item" data-action="edit" data-id="${p.id}">${translations[currentLang].buttonEdit}</a>
                            <a href="#" class="menu-item menu-item-danger" data-action="delete" data-id="${p.id}">${translations[currentLang].buttonDelete}</a>
                        </div>
                    </div>
                </div>
                ${downlineHtml}
                ${tagsHtml}
                <p class="prospect-meta">
                    <span><strong>${translations[currentLang].phone}:</strong> ${p.phone||'N/A'}</span><span class="separator">|</span>
                    <span><strong>${translations[currentLang].age}:</strong> ${p.age||'N/A'}</span><span class="separator">|</span>
                    <span><strong>${translations[currentLang].occupation}:</strong> ${p.occupation||'N/A'}</span>
                </p>
                <p class="prospect-meta">
                    <span><strong>${translations[currentLang].stp_time}:</strong> ${formatDate(p.stp_time)}</span><span class="separator">|</span>
                    <span><strong>GMS:</strong> ${formatDate(p.gms_time)}</span>
                </p>
                <div><strong>${translations[currentLang].notes}:</strong><br>${notesHtml}</div>
                <div class="prospect-actions"></div>`;
            const actionsDiv = card.querySelector('.prospect-actions');
            if (pStatus === 'STP') { actionsDiv.innerHTML += `<button class="btn-primary" data-action="schedule_gms" data-id="${p.id}">${translations[currentLang].actionScheduleGMS}</button><button class="btn-secondary" data-action="kit_stp" data-id="${p.id}">${translations[currentLang].actionKeepInTouch}</button><button class="btn-danger" data-action="disqualify" data-id="${p.id}">${translations[currentLang].actionDisqualify}</button>`;
            } else if (pStatus === 'KIT_STP') { actionsDiv.innerHTML += `<button class="btn-primary" data-action="schedule_gms" data-id="${p.id}">${translations[currentLang].actionScheduleGMS}</button><button class="btn-warning" data-action="follow_up" data-id="${p.id}">${translations[currentLang].actionFollowUp} (${p.kit_counter || 0})</button><button class="btn-danger" data-action="disqualify" data-id="${p.id}">${translations[currentLang].actionDisqualify}</button>`;
            } else if (pStatus === 'GMS_Appointment') { actionsDiv.innerHTML += `<button class="btn-success" data-action="joined" data-id="${p.id}">${translations[currentLang].actionJoined}</button><button class="btn-primary" data-action="edit_gms" data-id="${p.id}">${translations[currentLang].actionEditGMS}</button><button class="btn-secondary" data-action="kit_gms" data-id="${p.id}">${translations[currentLang].actionKeepInTouch}</button><button class="btn-danger" data-action="not_joining" data-id="${p.id}">${translations[currentLang].actionNotJoining}</button>`;
            } else if (pStatus === 'KIT_GMS') { actionsDiv.innerHTML += `<button class="btn-success" data-action="joined" data-id="${p.id}">${translations[currentLang].actionJoined}</button><button class="btn-warning" data-action="follow_up" data-id="${p.id}">${translations[currentLang].actionFollowUp} (${p.kit_counter || 0})</button><button class="btn-danger" data-action="not_joining" data-id="${p.id}">${translations[currentLang].actionNotJoining}</button>`; }
            listDiv.appendChild(card);
        });

        renderPagination(filtered.length);
    }
    
    document.getElementById('prospect-list').addEventListener('click', (e) => {
        const menuToggle = e.target.closest('.menu-toggle-btn');
        if (menuToggle) {
            e.stopPropagation();
            const prospectId = menuToggle.dataset.id;
            const menu = document.getElementById(`menu-${prospectId}`);
            const isMenuOpen = menu.classList.contains('open');
            document.querySelectorAll('.card-menu.open').forEach(m => m.classList.remove('open'));
            if (!isMenuOpen) menu.classList.add('open');
            return;
        }
        const menuItem = e.target.closest('.menu-item');
        if (menuItem) {
            e.preventDefault();
            const prospectId = menuItem.dataset.id;
            const action = menuItem.dataset.action;
            if (action === 'edit') openEditModal(prospectId);
            if (action === 'delete') deleteProspect(prospectId);
            menuItem.closest('.card-menu').classList.remove('open');
            return;
        }
        const actionButton = e.target.closest('.prospect-actions button');
        if (actionButton) {
            openActionModal(actionButton.dataset.id, actionButton.dataset.action);
        }
    });
    
    document.getElementById('search-input').addEventListener('input', () => { currentPage = 1; renderProspectList(); }); 
    document.getElementById('sort-by').addEventListener('change', () => { currentPage = 1; renderProspectList(); });
    document.getElementById('status-filter').addEventListener('change', () => { currentPage = 1; renderProspectList(); });
    document.getElementById('prospect-view-toggle').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            currentPage = 1;
            prospectViewFilter = e.target.dataset.filter;
            renderProspectList();
            renderToggles();
        }
    });

    function renderAnalytics() {
        const monthInput = document.getElementById('analytics-month');
        const selectedMonth = monthInput.value;
        if (!selectedMonth) return;
        const [year, month] = selectedMonth.split('-').map(Number);
        
        let prospectsToAnalyze = prospects;
        if (analyticsView === 'user') {
            prospectsToAnalyze = prospects.filter(p => p.owner_type !== 'downline');
        } else {
            const selectedDownline = document.getElementById('downline-filter').value;
            prospectsToAnalyze = prospects.filter(p => p.owner_type === 'downline' && (selectedDownline === 'all' || p.downline_name === selectedDownline));
        }

        let newStps = 0, newGms = 0, newJoins = 0, newDisqualified = 0;
        prospectsToAnalyze.forEach(p => {
            if (p.created_at) {
                const createdDate = new Date(p.created_at);
                if (createdDate.getFullYear() === year && createdDate.getMonth() + 1 === month) {
                    newStps++;
                }
            }
            if (p.gms_time) {
                const gmsDate = new Date(p.gms_time);
                if (gmsDate.getFullYear() === year && gmsDate.getMonth() + 1 === month) {
                    newGms++;
                }
            }
            if (p.status === 'Joined') {
                 const joinedDate = new Date(p.updated_at); // Assuming status update changes updated_at
                 if (joinedDate.getFullYear() === year && joinedDate.getMonth() + 1 === month) {
                    newJoins++;
                 }
            }
             if (p.status === 'Disqualified' || p.status === 'Not_Joining') {
                 const disqualifiedDate = new Date(p.updated_at);
                 if (disqualifiedDate.getFullYear() === year && disqualifiedDate.getMonth() + 1 === month) {
                    newDisqualified++;
                 }
            }
        });
        const summaryDiv = document.getElementById('analytics-summary');
        const t = translations[currentLang].analytics;
        summaryDiv.innerHTML = `<div class="analytics-card"><h4>${t.new_stps}</h4><div class="value">${newStps}</div></div><div class="analytics-card"><h4>${t.new_gms}</h4><div class="value">${newGms}</div></div>
                                <div class="analytics-card"><h4>${t.new_joins}</h4><div class="value">${newJoins}</div></div><div class="analytics-card"><h4>${t.new_disqualified}</h4><div class="value">${newDisqualified}</div></div>`;
        
        renderTrendChart(prospectsToAnalyze);
    }
    
    function getMonthlyTrendData(prospectsToAnalyze) {
        const data = { labels: [], datasets: { stps: [], gms: [], joins: [], disqualified: [] } };
        const now = new Date();
        for (let i = 5; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const year = d.getFullYear();
            const month = d.getMonth() + 1;
            const monthName = d.toLocaleString(currentLang === 'zh-CN' ? 'zh-CN' : 'en-US', { month: 'short' });
            data.labels.push(monthName);

            let stps = 0, gms = 0, joins = 0, disqualified = 0;
            prospectsToAnalyze.forEach(p => {
                if(p.created_at) {
                    const createdDate = new Date(p.created_at);
                    if (createdDate.getFullYear() === year && createdDate.getMonth() + 1 === month) {
                        stps++;
                    }
                }
                if (p.gms_time) {
                    const gmsDate = new Date(p.gms_time);
                    if (gmsDate.getFullYear() === year && gmsDate.getMonth() + 1 === month) {
                        gms++;
                    }
                }
                 if (p.status === 'Joined') {
                    const joinedDate = new Date(p.updated_at);
                     if (joinedDate.getFullYear() === year && joinedDate.getMonth() + 1 === month) {
                        joins++;
                     }
                }
                 if (p.status === 'Disqualified' || p.status === 'Not_Joining') {
                    const disqualifiedDate = new Date(p.updated_at);
                     if (disqualifiedDate.getFullYear() === year && disqualifiedDate.getMonth() + 1 === month) {
                        disqualified++;
                     }
                }
            });
            data.datasets.stps.push(stps);
            data.datasets.gms.push(gms);
            data.datasets.joins.push(joins);
            data.datasets.disqualified.push(disqualified);
        }
        return data;
    }

    function renderTrendChart(prospectsToAnalyze) {
        const ctx = document.getElementById('analyticsTrendChart').getContext('2d');
        const trendData = getMonthlyTrendData(prospectsToAnalyze);
        const t = translations[currentLang].analytics;
        if (trendChartInstance) {
            trendChartInstance.destroy();
        }
        trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: [
                    { label: t.new_stps, data: trendData.datasets.stps, borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 },
                    { label: t.new_gms, data: trendData.datasets.gms, borderColor: 'rgba(249, 115, 22, 1)', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 },
                    { label: t.new_joins, data: trendData.datasets.joins, borderColor: 'rgba(16, 185, 129, 1)', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 },
                    { label: t.new_disqualified, data: trendData.datasets.disqualified, borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true, ticks: { precision: 0 } }
                },
                plugins: {
                    legend: { position: 'top' },
                },
                interaction: {
                    intersect: false,
                    mode: 'index',
                }
            }
        });
    }

    function renderToggles() {
        const t = translations[currentLang];
        const prospectToggle = document.getElementById('prospect-view-toggle');
        prospectToggle.innerHTML = `
            <button class="${prospectViewFilter === 'user' ? 'active' : ''}" data-filter="user">${t.prospectViewToggleMine}</button>
            <button class="${prospectViewFilter === 'downline' ? 'active' : ''}" data-filter="downline">${t.prospectViewToggleDownlines}</button>
            <button class="${prospectViewFilter === 'all' ? 'active' : ''}" data-filter="all">${t.prospectViewToggleAll}</button>
        `;
        const analyticsToggle = document.getElementById('analytics-view-toggle');
        analyticsToggle.innerHTML = `
            <button class="${analyticsView === 'user' ? 'active' : ''}" data-view="user">${t.analyticsViewToggleMine}</button>
            <button class="${analyticsView === 'downline' ? 'active' : ''}" data-view="downline">${t.analyticsViewToggleDownlines}</button>
        `;
    }

    document.getElementById('analytics-view-toggle').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON') {
            analyticsView = e.target.dataset.view;
            document.getElementById('downline-analytics-controls').style.display = analyticsView === 'downline' ? 'block' : 'none';
            if (analyticsView === 'downline') {
                populateDownlineFilter();
            }
            renderAnalytics();
            renderToggles();
        }
    });
    
    document.getElementById('downline-filter').addEventListener('change', renderAnalytics);

    function populateDownlineFilter() {
        const downlineNames = [...new Set(prospects.filter(p => p.owner_type === 'downline' && p.downline_name).map(p => p.downline_name))];
        const filterSelect = document.getElementById('downline-filter');
        const currentVal = filterSelect.value;
        filterSelect.innerHTML = `<option value="all">${translations[currentLang].allDownlinesOption}</option>`;
        downlineNames.sort().forEach(name => {
            filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
        });
        filterSelect.value = downlineNames.includes(currentVal) ? currentVal : 'all';
    }

    function populateDownlineDatalist() {
        const downlineNames = [...new Set(prospects.filter(p => p.owner_type === 'downline' && p.downline_name).map(p => p.downline_name))];
        const datalist = document.getElementById('downline-names-list');
        datalist.innerHTML = '';
        downlineNames.sort().forEach(name => {
            datalist.innerHTML += `<option value="${name}"></option>`;
        });
    }

    document.getElementById('clearData').addEventListener('click', async () => { 
        if (confirm(translations[currentLang].confirmClearData)) { 
            const { data: { user } } = await supabase.auth.getUser();
            if(!user) return;
            const { error: prospectError } = await supabase.from('prospects').delete().eq('user_id', user.id);
            const { error: availabilityError } = await supabase.from('availability').delete().eq('user_id', user.id);

            if (prospectError || availabilityError) {
                console.error('Error clearing data:', prospectError, availabilityError);
            } else {
                alert(translations[currentLang].dataCleared);
            }
        } 
    });
    
    document.getElementById('exportData').addEventListener('click', () => {
        if (prospects.length === 0 && Object.keys(availability).length === 0) return alert('No data to export.');
        const timestamp = new Date();
        const dataToExport = {
            prospects: prospects,
            availability: availability,
            timestamp: timestamp.toISOString()
        };
        const dataStr = JSON.stringify(dataToExport, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        const date = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')}`;
        const time = `${String(timestamp.getHours()).padStart(2, '0')}-${String(timestamp.getMinutes()).padStart(2, '0')}`;
        link.download = `AmwayTracker_Backup_${date}_${time}.json`;
        link.href = url;
        link.click();
        URL.revokeObjectURL(url);
    });

    document.getElementById('importData').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const data = JSON.parse(e.target.result);
                if (data && data.prospects && data.availability) {
                    if (confirm(translations[currentLang].importConfirm)) {
                        const { data: { user } } = await supabase.auth.getUser();
                        if(!user) return;

                        await supabase.from('prospects').delete().eq('user_id', user.id);
                        await supabase.from('availability').delete().eq('user_id', user.id);

                        const prospectsToInsert = data.prospects.map(p => ({ ...p, user_id: user.id, id: undefined })); // Ensure DB generates new IDs
                        const availabilityToInsert = Object.keys(data.availability).map(date => ({ date, time_slots: data.availability[date], user_id: user.id }));

                        if(prospectsToInsert.length > 0) await supabase.from('prospects').insert(prospectsToInsert);
                        if(availabilityToInsert.length > 0) await supabase.from('availability').insert(availabilityToInsert);
                        
                        alert(translations[currentLang].importSuccess);
                    }
                } else {
                    alert(translations[currentLang].importError);
                }
            } catch (error) {
                console.error("Import error:", error);
                alert(translations[currentLang].importError);
            }
        };
        reader.readAsText(file);
        event.target.value = ''; // Reset file input
    });

    function renderDataStatus() {
        document.getElementById('total-prospects').textContent = prospects.length;
        const syncTimeEl = document.getElementById('last-sync-time');
        if (lastSyncTimestamp) {
            syncTimeEl.textContent = formatDate(lastSyncTimestamp);
        } else {
            syncTimeEl.textContent = "Never";
        }
    }
    
    document.getElementById('prev-month').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
    document.getElementById('next-month').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
    function renderCalendar() {
        const gridBody = document.getElementById('calendar-grid-body'); const gridHeader = document.getElementById('calendar-grid-header');
        gridBody.innerHTML = ''; gridHeader.innerHTML = ''; const month = calendarDate.getMonth(); const year = calendarDate.getFullYear();
        document.getElementById('current-month-year').textContent = new Date(year, month).toLocaleString(currentLang === 'zh-CN' ? 'zh-Hans-CN' : 'en-US', { month: 'long', year: 'numeric' });
        translations[currentLang].dayNames.forEach(day => { const dayEl = document.createElement('div'); dayEl.className = 'calendar-day-header'; dayEl.textContent = day; gridHeader.appendChild(dayEl); });
        const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) { const emptyCell = document.createElement('div'); emptyCell.className = 'calendar-day other-month'; gridBody.appendChild(emptyCell); }
        for (let i = 1; i <= daysInMonth; i++) {
            const dayCell = document.createElement('div'); dayCell.className = 'calendar-day'; const thisDate = new Date(year, month, i); const today = new Date();
            if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayCell.classList.add('today');
            const dayNumber = document.createElement('div'); dayNumber.className = 'day-number'; dayNumber.textContent = i; dayCell.appendChild(dayNumber);
            const appointmentsOnDay = prospects.filter(p => { const stpDate = p.stp_time ? new Date(p.stp_time) : null; const gmsDate = p.gms_time ? new Date(p.gms_time) : null; return (stpDate && stpDate.getDate() === i && stpDate.getMonth() === month && stpDate.getFullYear() === year) || (gmsDate && gmsDate.getDate() === i && gmsDate.getMonth() === month && gmsDate.getFullYear() === year); });
            if (appointmentsOnDay.length > 0) {
                const dotsContainer = document.createElement('div'); dotsContainer.className = 'appointment-dots';
                if (appointmentsOnDay.some(p => p.stp_time && new Date(p.stp_time).getDate() === i && new Date(p.stp_time).getMonth() === month)) {
                    dotsContainer.innerHTML += '<span class="appointment-dot dot-stp"></span>';
                }
                if (appointmentsOnDay.some(p => p.gms_time && new Date(p.gms_time).getDate() === i && new Date(p.gms_time).getMonth() === month)) {
                     dotsContainer.innerHTML += '<span class="appointment-dot dot-gms"></span>';
                }
                dayCell.appendChild(dotsContainer);
            }
            dayCell.style.cursor = 'pointer'; dayCell.onclick = () => showPlanner(thisDate);
            gridBody.appendChild(dayCell);
        }
    }

    let currentPlannerDate = null;
    function showPlanner(date) {
        currentPlannerDate = date;
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const t = translations[currentLang];
        document.getElementById('planner-title').textContent = `${date.toLocaleDateString(currentLang === 'zh-CN' ? 'zh-Hans-CN' : 'en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})} - ${t.plannerTitle}`;
        const apptList = document.getElementById('planner-appointments-list');
        apptList.innerHTML = '';
        const appointmentsOnDay = prospects.filter(p => { const stpDate = p.stp_time ? new Date(p.stp_time) : null; const gmsDate = p.gms_time ? new Date(p.gms_time) : null; return (stpDate && stpDate.toDateString() === date.toDateString()) || (gmsDate && gmsDate.toDateString() === date.toDateString()); });
        if (appointmentsOnDay.length === 0) { apptList.innerHTML = `<li>${t.noAppointmentsToday}</li>`; } else {
            appointmentsOnDay.sort((a,b) => new Date(a.stp_time || a.gms_time) - new Date(b.stp_time || b.gms_time)).forEach(p => {
                let ownerInfo = p.owner_type === 'downline' ? ` (${p.downline_name})` : '';
                const formatTime = (timeStr) => {
                    const time = new Date(timeStr);
                    return currentLang === 'zh-CN' ? formatChineseTime(time) : time.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                };
                if (p.stp_time && new Date(p.stp_time).toDateString() === date.toDateString()) apptList.innerHTML += `<li>ğŸ”µ <strong>STP:</strong> ${p.name}${ownerInfo} - ${formatTime(p.stp_time)}</li>`;
                if (p.gms_time && new Date(p.gms_time).toDateString() === date.toDateString()) apptList.innerHTML += `<li>ğŸŸ  <strong>GMS:</strong> ${p.name}${ownerInfo} - ${formatTime(p.gms_time)}</li>`;
            });
        }
        const timeline = document.getElementById('planner-timeline-slots');
        timeline.innerHTML = '';
        const savedSlots = availability[dateKey] || [];
        for (let hour = 0; hour < 24; hour++) {
            for (let min = 0; min < 60; min += 30) {
                const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                const slotBtn = document.createElement('button');
                slotBtn.className = 'time-slot'; slotBtn.dataset.time = timeStr;
                const tempDate = new Date(2000, 0, 1, hour, min);
                slotBtn.textContent = (currentLang === 'zh-CN') ? formatChineseTime(tempDate) : tempDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                
                // FIXED: Robust isBooked check
                const isBooked = appointmentsOnDay.some(p => {
                    const slotStart = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, min);
                    const slotEnd = new Date(slotStart.getTime() + 30 * 60 * 1000);
                    
                    let stpBooked = false;
                    if (p.stp_time) {
                        const stpTime = new Date(p.stp_time);
                        if (stpTime >= slotStart && stpTime < slotEnd) stpBooked = true;
                    }

                    let gmsBooked = false;
                    if (p.gms_time) {
                        const gmsTime = new Date(p.gms_time);
                        if (gmsTime >= slotStart && gmsTime < slotEnd) gmsBooked = true;
                    }
                    return stpBooked || gmsBooked;
                });

                if (isBooked) { slotBtn.classList.add('booked'); slotBtn.disabled = true; } 
                else if (savedSlots.includes(timeStr)) { slotBtn.classList.add('available'); }
                if (!isBooked) { slotBtn.onclick = () => slotBtn.classList.toggle('available'); }
                timeline.appendChild(slotBtn);
            }
        }
        plannerModal.style.display = 'flex';
    }

    document.getElementById('save-availability-btn').addEventListener('click', async () => {
        const dateKey = `${currentPlannerDate.getFullYear()}-${String(currentPlannerDate.getMonth() + 1).padStart(2, '0')}-${String(currentPlannerDate.getDate()).padStart(2, '0')}`;
        const availableSlots = Array.from(document.querySelectorAll('#planner-timeline-slots .time-slot.available')).map(slot => slot.dataset.time);
        
        const { data: { user } } = await supabase.auth.getUser();
        if(!user) return;
        
        const { error } = await supabase
            .from('availability')
            .upsert({ date: dateKey, time_slots: availableSlots, user_id: user.id }, { onConflict: 'date, user_id' });

        if (error) console.error('Error saving availability:', error);

        plannerModal.style.display = 'none';
    });
    
    function getSlotFromTime(date) {
        if (!date) return null;
        const minutes = date.getMinutes() < 30 ? '00' : '30';
        return `${String(date.getHours()).padStart(2, '0')}:${minutes}`;
    }

    async function removeBookedSlotFromDB(dateTimeString) {
        if (!dateTimeString) return;
        const date = new Date(dateTimeString);
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const timeSlot = getSlotFromTime(date);
        
        const { data: { user } } = await supabase.auth.getUser();
        if(!user || !availability[dateKey]) return;

        const updatedSlots = availability[dateKey].filter(slot => slot !== timeSlot);

        if (updatedSlots.length === 0) {
            await supabase.from('availability').delete().match({ date: dateKey, user_id: user.id });
        } else {
            await supabase.from('availability').update({ time_slots: updatedSlots }).match({ date: dateKey, user_id: user.id });
        }
    }

    async function addBackAvailabilityToDB(dateTimeString) {
        if (!dateTimeString) return;
        const date = new Date(dateTimeString);
        const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const timeSlot = getSlotFromTime(date);
        
        const { data: { user } } = await supabase.auth.getUser();
        if(!user) return;
        
        const currentSlots = availability[dateKey] || [];
        if (!currentSlots.includes(timeSlot)) {
            currentSlots.push(timeSlot);
            currentSlots.sort();
            await supabase.from('availability').upsert({ date: dateKey, time_slots: currentSlots, user_id: user.id }, { onConflict: 'date, user_id' });
        }
    }

    function renderAvailableSlotsSidebar() {
        const listContainer = document.getElementById('available-slots-list');
        const modalListContainer = document.getElementById('modal-slots-list');
        listContainer.innerHTML = '';
        modalListContainer.innerHTML = '';
        const now = new Date();
        let allAvailableSlots = [];

        Object.keys(availability).sort().forEach(dateKey => {
            const date = new Date(dateKey.replace(/-/g, '/')); 
            if (date >= new Date(now.toDateString())) {
                availability[dateKey].forEach(timeStr => {
                    const [hour, minute] = timeStr.split(':');
                    const slotDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, minute);
                    if (slotDate > now) {
                        allAvailableSlots.push(slotDate);
                    }
                });
            }
        });
        
        // SORTING FIX: Sort all slots before grouping
        allAvailableSlots.sort((a, b) => a - b);

        let contentHTML = '';
        if (allAvailableSlots.length === 0) {
            contentHTML = `<div class="slot-time">${translations[currentLang].noAvailableSlots}</div>`;
        } else {
            const groupedSlots = {};
            allAvailableSlots.slice(0, 20).forEach(slotDate => {
                const dayKey = slotDate.toLocaleDateString(currentLang === 'zh-CN' ? 'zh-Hans-CN' : 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                if (!groupedSlots[dayKey]) groupedSlots[dayKey] = [];
                const timeString = (currentLang === 'zh-CN') ? formatChineseTime(slotDate) : slotDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                groupedSlots[dayKey].push(timeString);
            });

            for (const day in groupedSlots) {
                contentHTML += `<div class="slot-day-group"><h4>${day}</h4>`;
                // No need to sort here anymore as the main array is sorted
                groupedSlots[day].forEach(time => {
                    contentHTML += `<div class="slot-time">${time}</div>`;
                });
                contentHTML += `</div>`;
            }
        }
        listContainer.innerHTML = contentHTML;
        modalListContainer.innerHTML = contentHTML;
    }

    function setupNotifications() {
        if (!("Notification" in window)) {
            console.log("This browser does not support desktop notification");
            return;
        }

        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Notification permission granted.");
                setInterval(checkForUpcomingAppointments, 60000);
            }
        });
    }

    function checkForUpcomingAppointments() {
        const now = new Date();
        const fifteenMinutesFromNow = new Date(now.getTime() + 15 * 60000);
        const t = translations[currentLang];

        prospects.forEach(p => {
            let appointmentTime = null;
            let appointmentType = '';

            if (p.status === 'STP' && p.stp_time) {
                appointmentTime = new Date(p.stp_time);
                appointmentType = 'STP';
            } else if (p.status === 'GMS_Appointment' && p.gms_time) {
                appointmentTime = new Date(p.gms_time);
                appointmentType = 'GMS';
            }

            if (appointmentTime && appointmentTime > now && appointmentTime <= fifteenMinutesFromNow) {
                const notificationKey = `notif_sent_${p.id}_${appointmentType}`;
                if (sessionStorage.getItem(notificationKey) === 'true') {
                    return; 
                }

                const title = t.upcomingAppointmentsTitle;
                const options = {
                    body: `${p.name} - ${appointmentType} @ ${appointmentTime.toLocaleTimeString(currentLang === 'zh-CN' ? 'zh-CN' : 'en-US', { hour: '2-digit', minute: '2-digit' })}`,
                    icon: 'images/icon-192x192.png'
                };

                new Notification(title, options);
                sessionStorage.setItem(notificationKey, 'true');
            }
        });
    }

    // =======================================================
    // START: APP INITIALIZATION LOGIC
    // =======================================================
    async function cleanupExpiredAvailability() {
        const { data: { user } } = await supabase.auth.getUser();
        if (!user) return;

        const today = new Date();
        const todayDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        
        const { error: deleteError } = await supabase.from('availability').delete().lt('date', todayDateString);
        if(deleteError) console.error("Error cleaning past dates:", deleteError);

        const { data: todayData, error: fetchError } = await supabase.from('availability').select('*').eq('date', todayDateString).single();
        if (fetchError || !todayData) return;

        const now = new Date();
        const futureSlots = todayData.time_slots.filter(timeStr => {
            const [hour, minute] = timeStr.split(':');
            const slotDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, minute);
            return slotDate > now;
        });

        if (futureSlots.length !== todayData.time_slots.length) {
            if (futureSlots.length === 0) {
                await supabase.from('availability').delete().eq('id', todayData.id);
            } else {
                await supabase.from('availability').update({ time_slots: futureSlots }).eq('id', todayData.id);
            }
        }
    }


    async function startApp() {
        // Load language preference FIRST
        const preferredLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
        setLanguage(preferredLanguage);

        try {
            const now = new Date();
            analyticsPicker.setDate(now, true);
        } catch (error) {
            console.error("Failed to initialize analytics picker, but continuing:", error);
        }
        await cleanupExpiredAvailability();
        await renderAll();
        setupNotifications();

        supabase
          .channel('public:prospects')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'prospects' }, payload => {
            console.log('Prospect change received!', payload);
            renderAll();
          })
          .subscribe();

         supabase
          .channel('public:availability')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'availability' }, payload => {
            console.log('Availability change received!', payload);
            renderAll();
          })
          .subscribe();
    }
    
    // --- START: DYNAMIC AUTH UI LOGIC ---
    function updateAuthView() {
        const title = document.getElementById('auth-title');
        const subtitle = document.getElementById('auth-subtitle');
        const actionBtn = document.getElementById('auth-action-btn');
        const confirmPassGroup = document.getElementById('confirm-password-group');
        const toggleText = document.getElementById('auth-toggle-text');
        const forgotPassLink = document.getElementById('forgot-password-link');

        if (isLoginView) {
            title.textContent = 'Welcome Back';
            subtitle.textContent = 'Login to track your prospects.';
            actionBtn.textContent = 'Login';
            actionBtn.className = 'btn-primary';
            confirmPassGroup.style.display = 'none';
            toggleText.innerHTML = 'No account? <span class="auth-toggle-link" id="toggle-to-signup">Sign up now</span>.';
            forgotPassLink.style.display = 'block';
            document.getElementById('toggle-to-signup').addEventListener('click', () => {
                isLoginView = false;
                updateAuthView();
            });
        } else {
            title.textContent = 'Create an Account';
            subtitle.textContent = 'Start tracking your prospects today.';
            actionBtn.textContent = 'Sign Up';
            actionBtn.className = 'btn-success';
            confirmPassGroup.style.display = 'block';
            toggleText.innerHTML = 'Already have an account? <span class="auth-toggle-link" id="toggle-to-login">Log in</span>.';
            forgotPassLink.style.display = 'none';
            document.getElementById('toggle-to-login').addEventListener('click', () => {
                isLoginView = true;
                updateAuthView();
            });
        }
    }
    
    document.getElementById('toggle-to-signup').addEventListener('click', () => {
        isLoginView = false;
        updateAuthView();
    });

    // --- END: DYNAMIC AUTH UI LOGIC ---


    // --- START: FINAL AUTH LOGIC & APP STARTUP ---
    const authContainer = document.getElementById('auth-container');
    const mainApp = document.getElementById('main-app');
    const logoutBtn = document.getElementById('logout-btn');

    document.getElementById('auth-action-btn').addEventListener('click', async () => {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        
        if (isLoginView) {
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) alert(error.message);
        } else {
            const confirmPassword = document.getElementById('auth-confirm-password').value;
            if (password !== confirmPassword) {
                alert("Passwords do not match.");
                return;
            }
            const { error } = await supabase.auth.signUp({ email, password });
            if (error) {
                alert(error.message);
            } else {
                alert('Sign up successful! Please check your email to verify.');
                isLoginView = true;
                updateAuthView();
            }
        }
    });

    logoutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
    });

    document.getElementById('google-signin-btn').addEventListener('click', async () => {
        const { error } = await supabase.auth.signInWithOAuth({
            provider: 'google',
        });
        if (error) {
            alert('Error signing in with Google: ' + error.message);
        }
    });

    async function updateUserUI(user) {
        setTimeout(() => {
            document.getElementById('loading-screen').classList.add('hidden');
        }, 1500);

        const userEmailEl = document.getElementById('user-email');

        if (user) {
            authContainer.style.display = 'none';
            mainApp.style.display = 'flex';
            if (userEmailEl) {
                userEmailEl.textContent = user.email;
            }
            await startApp();
        } else {
            authContainer.style.display = 'flex';
            mainApp.style.display = 'none';
            if (userEmailEl) {
                userEmailEl.textContent = '';
            }
            updateAuthView(); 
        }
    }

    supabase.auth.onAuthStateChange((event, session) => {
        const user = session ? session.user : null;
        updateUserUI(user);
    });

    (async () => {
        const { data: { user } } = await supabase.auth.getUser();
        await updateUserUI(user);
    })();
    // --- END: FINAL AUTH LOGIC & APP STARTUP ---
    
});
</script>
</body>
</html>