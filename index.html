<!DOCTYPE html>
<html lang="zh-CN">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   安利对象跟进系统 (Amway Prospect Tracker)
  </title>
  <link href="libs/flatpickr.min.css" rel="stylesheet"/>
  <link href="libs/monthSelect.css" rel="stylesheet"/>
  <link href="manifest.json" rel="manifest"/>
  <meta content="#0d47a1" name="theme-color"/>
  <style>
   :root {
            --primary-color: #0d47a1; 
            --secondary-color: #f1f5f9; 
            --accent-color: #10b981; 
            --danger-color: #ef4444;
            --warning-color: #f59e0b; 
            --info-color: #3b82f6; 
            --text-color: #1e2023; /* Darker, more readable main text */
            --light-text-color: #fff;
            --text-color-light: #2d3032; /* Softer, clearer secondary text */
            --border-radius: 12px; 
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --card-bg: rgba(255, 255, 255, 0.95);
            --border-color: #e2e8f0;
        }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            margin: 0; 
            padding: 20px; 
            background-color: var(--secondary-color); 
            color: var(--text-color); 
            line-height: 1.6;
            background-image: url('https://www.transparenttextures.com/patterns/diamond-upholstery.png');
        }
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        #loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .welcome-message {
            text-align: center;
            opacity: 0; /* Start hidden */
            animation: fadeIn 1.5s forwards; /* Fade in */
        }
        #welcome-icon {
            font-size: 4.5em; /* Adjusted size for mobile */
            line-height: 1;
            display: block; /* Make it a block to control spacing */
            margin: 0 auto 15px auto; /* Center it and add space below */
            animation: sparkle 2s infinite ease-in-out;
        }
        #welcome-text {
            font-size: 1.8em; /* Adjusted size for mobile */
            font-weight: 700;
            color: var(--primary-color);
            white-space: nowrap; /* Prevent text from wrapping */
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
        @keyframes sparkle {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; } /* Made sparkle more subtle */
        }

        .app-layout { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; align-items: flex-start; }
        .main-content { flex-grow: 1; }
        .sidebar { flex: 0 0 280px; position: sticky; top: 20px; }
        .container, .sidebar { background: var(--card-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.5); padding: 20px; border-radius: var(--border-radius); box-shadow: var(--box-shadow); }
        .sidebar h3, #availability-modal-title { color: var(--primary-color); margin-top: 0; border-bottom: 2px solid var(--secondary-color); padding-bottom: 10px; font-size: 1.1em; }
        #available-slots-list, #modal-slots-list { list-style: none; padding: 0; max-height: calc(100vh - 120px); overflow-y: auto; }
        .slot-day-group { margin-bottom: 15px; }
        .slot-day-group h4 { margin: 0 0 8px 0; font-size: 0.9em; color: #555; background-color: var(--secondary-color); padding: 5px 8px; border-radius: 4px;}
        .slot-time { background-color: #e9ecef; padding: 8px 12px; border-radius: 4px; margin-bottom: 5px; font-size: 0.9em; text-align: center; }
        header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        header h1 {
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-color), var(--info-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0; 
            font-size: 1.8em; 
        }
        .controls, .filter-controls { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        button, .btn-file-input { padding: 10px 20px; font-size: 1em; font-weight: 600; border: none; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease; display: inline-block; text-align: center;}
        button:active { transform: scale(0.97); }
        .btn-primary { background-color: var(--primary-color); color: var(--light-text-color); } .btn-primary:hover { background-color: #0b3a8a; box-shadow: 0 4px 10px rgba(13, 71, 161, 0.3); }
        .btn-success { background: linear-gradient(45deg, var(--primary-color), var(--info-color)); color: var(--light-text-color); background-size: 200% auto; } 
        .btn-success:hover { background-position: right center; box-shadow: 0 4px 12px rgba(60, 130, 246, 0.4); }
        .btn-danger { background-color: var(--danger-color); color: var(--light-text-color); } .btn-danger:hover { background-color: #d93333; }
        .btn-secondary { background-color: #64748b; color: var(--light-text-color); } .btn-secondary:hover { background-color: #475569; }
        .tabs { display: flex; margin-bottom: 25px; flex-wrap: wrap; gap: 0; border-bottom: 2px solid var(--border-color); }
        .tab-button { background-color: transparent; border: none; border-bottom: 3px solid transparent; border-radius: 0; padding: 12px 16px; font-weight: 600; color: var(--text-color-light); transition: all 0.2s ease; }
        .tab-button:hover { color: var(--primary-color); }
        .tab-button.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background-color: transparent; font-weight: 600; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .prospect-card, .reminder-card, .analytics-card, .appointment-card, .settings-card { background: var(--card-bg); border: 1px solid var(--border-color); border-left: 5px solid var(--primary-color); border-radius: var(--border-radius); padding: 20px; margin-bottom: 15px; box-shadow: var(--box-shadow); transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .prospect-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(30, 41, 59, 0.1); }
        .prospect-actions { margin-top: 15px; display: flex; flex-wrap: wrap; gap: 10px; }
        .prospect-meta { display: flex; flex-wrap: wrap; gap: 0 10px; color: var(--text-color-light); font-size: 0.9em; align-items: center;}
        .prospect-meta span { display: inline-block; }
        .prospect-meta .separator { color: var(--border-color); font-size: 1.2em; }
        .status-badge { padding: 5px 12px; border-radius: 999px; font-weight: 600; font-size: 0.85em; color: #fff; text-align: center; }
        .status-STP { background-color: var(--info-color); } .status-GMS_Appointment { background-color: #f97316; }
        .status-KIT_STP, .status-KIT_GMS { background-color: var(--warning-color); color: var(--text-color); }
        .status-Joined { background-color: var(--accent-color); } .status-Disqualified, .status-Not_Joining { background-color: var(--danger-color); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: var(--primary-color); } .close-button { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin-bottom: 15px; } .form-group label { display: block; margin-bottom: 5px; font-weight: 600; color: var(--text-color); }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); outline: none; }
        .reminders-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .reminder-card { border-left-color: var(--warning-color); } .appointment-card { border-left-color: var(--info-color); }
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .analytics-card { text-align: center; border-left-color: var(--accent-color); }
        .analytics-card .value { font-size: 2.5em; font-weight: bold; color: var(--primary-color); }
        .search-bar, #sort-by, #status-filter, #analytics-month { padding: 12px; border-radius: var(--border-radius); border: 1px solid var(--border-color); font-size: 1em; background-color: #fff; }
        .search-bar { flex-grow: 1; } .filter-controls { margin-bottom: 20px; }
        .tags-container { margin-top: 8px; }
        .tag-badge { display: inline-block; background-color: #e9ecef; color: var(--text-color); padding: 3px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; margin-bottom: 5px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 0 10px; }
        .calendar-header h2 { color: var(--primary-color); margin: 0; text-align: center; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-day-header { font-weight: bold; text-align: center; padding: 10px 5px; background-color: var(--secondary-color); border-radius: 4px; }
        .calendar-day { border: 1px solid var(--border-color); border-radius: 8px; padding: 8px; min-height: 80px; background-color: white; transition: background-color 0.2s; }
        .calendar-day.other-month { background-color: #f8f9fa; color: #ccc; }
        .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; }
        .calendar-day .day-number { font-size: 0.9em; }
        .appointment-dots { margin-top: 5px; display: flex; gap: 4px; }
        .appointment-dot { height: 8px; width: 8px; border-radius: 50%; }
        .dot-stp { background-color: var(--info-color); }
        .dot-gms { background-color: #f97316; }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .card-header h3 { margin-top: 0; flex-grow: 1; line-height: 1.2; }
        .card-menu-container { position: relative; flex-shrink: 0; }
        .menu-toggle-btn { padding: 0 8px; font-size: 1.5em; background: transparent; border: none; line-height: 1; color: #888; }
        .card-menu { display: none; position: absolute; right: 0; top: 100%; background-color: white; border-radius: var(--border-radius); box-shadow: var(--box-shadow); z-index: 10; min-width: 120px; border: 1px solid #eee; }
        .card-menu.open { display: block; }
        .menu-item { display: block; padding: 10px 15px; color: var(--text-color); text-decoration: none; font-size: 0.9em; }
        .menu-item:hover { background-color: var(--secondary-color); }
        .menu-item-danger { color: var(--danger-color); }
        #planner-modal .modal-content { max-width: 800px; }
        .planner-container { display: flex; gap: 20px; flex-wrap: wrap; }
        .planner-appointments, .planner-timeline { flex: 1; min-width: 300px; }
        #planner-appointments-list li { list-style: none; padding-left: 0; margin-bottom: 5px; }
        .planner-timeline { max-height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: var(--border-radius); }
        .time-slot { display: block; width: 100%; margin-bottom: 5px; text-align: center; background-color: #e9ecef; border: 1px solid #dee2e6; color: #495057; }
        .time-slot:not(:disabled):hover { background-color: #ced4da; }
        .time-slot.available { background-color: var(--accent-color); color: white; border-color: #1e7e34; }
        .time-slot.booked { background-color: var(--info-color); color: white; border-color: #117a8b; opacity: 0.8; cursor: not-allowed; }
        .planner-footer { margin-top: 20px; text-align: right; }
        .planner-legend { display: flex; gap: 15px; font-size: 0.8em; margin-bottom: 10px; align-items: center; flex-wrap: wrap; }
        #calendar-legend { justify-content: center; margin-bottom: 15px; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .legend-color { width: 12px; height: 12px; border-radius: 3px; }
        .legend-color.available { background-color: var(--accent-color); }
        .legend-color.booked { background-color: var(--info-color); }
        .legend-color.busy { background-color: #e9ecef; border: 1px solid #dee2e6; }
        .downline-info { font-size: 0.8em; color: #555; font-style: italic; background-color: #fafafa; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-top: 5px; }
        .toggle-switch { display: flex; gap: 5px; background-color: var(--secondary-color); border-radius: var(--border-radius); padding: 5px; margin-bottom: 15px; }
        .toggle-switch button { flex: 1; background-color: transparent; border: none; padding: 8px; font-weight: normal; }
        .toggle-switch button.active { background-color: white; color: var(--primary-color); font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #guide { line-height: 1.8; }
        #guide h2 { color: var(--primary-color); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; margin-top: 30px; }
        #guide h3 { color: var(--text-color); margin-top: 25px; margin-bottom: 10px; }
        #guide hr { border: none; border-top: 1px solid var(--border-color); margin: 30px 0; }
        #guide .legend-item { display: inline-flex; margin-right: 15px; }
        #guide code { background-color: var(--secondary-color); padding: 2px 6px; border-radius: 4px; font-family: "Courier New", Courier, monospace; }
        #show-availability-fab { display: none; position: fixed; bottom: 20px; right: 20px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--primary-color); color: white; font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 2px solid white; align-items: center; justify-content: center; z-index: 1001; }
        .pagination { display: flex; justify-content: center; align-items: center; gap: 5px; margin-top: 25px; }
        .page-btn { background-color: #fff; border: 1px solid var(--border-color); color: var(--primary-color); font-weight: 600; padding: 8px 14px; border-radius: 8px; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .page-btn.active { background-color: var(--primary-color); color: var(--light-text-color); border-color: var(--primary-color); }
        .page-btn:not(:disabled):hover { background-color: var(--secondary-color); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        
        /* --- START: Login Page Styles --- */
        #auth-container { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 40px); padding: 20px; box-sizing: border-box; }
        .login-card { background: var(--card-bg); padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 420px; text-align: center; border: 1px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: fadeIn 0.5s ease-out; }
        .login-logo { max-width: 100px; margin: 0 auto 20px; }
        .login-card h2 { margin-top: 0; margin-bottom: 10px; font-size: 1.8em; font-weight: 700; color: var(--primary-color); }
        .login-card p { margin-bottom: 30px; color: var(--text-color-light); }
        .auth-form-group { position: relative; margin-bottom: 20px; }
        .auth-form-group input { width: 100%; padding: 12px 12px 12px 45px; border-radius: var(--border-radius); border: 1px solid var(--border-color); box-sizing: border-box; transition: border-color 0.2s, box-shadow 0.2s; font-size: 1em; }
        .auth-form-group input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(13, 71, 161, 0.1); outline: none; }
        .auth-form-group .icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
         .auth-form-group .password-toggle { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; cursor: pointer; }
        .login-actions button { width: 100%; padding: 12px 20px; font-size: 1.1em; }
        .auth-toggle-link { color: var(--primary-color); text-decoration: none; cursor: pointer; font-weight: 600; }
        .auth-toggle-link:hover { text-decoration: underline; }
        .auth-footer { margin-top: 20px; font-size: 0.9em; color: var(--text-color-light); }
        .forgot-password-link { display: block; margin-top: 15px; color: var(--primary-color); text-decoration: none; font-size: 0.9em; transition: color 0.2s; }
        .forgot-password-link:hover { text-decoration: underline; color: #0b3a8a; }
        /* --- END: Login Page Styles --- */

        /* ===== Flatpickr Custom Theme ===== */
        .flatpickr-calendar { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--box-shadow); width: 315px; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .flatpickr-months .flatpickr-month { color: var(--primary-color); font-weight: 600; font-size: 1rem; height: 40px; }
        .flatpickr-months .flatpickr-prev-month, .flatpickr-months .flatpickr-next-month { padding: 8px; fill: var(--primary-color); transition: background-color 0.2s; border-radius: 50%; }
        .flatpickr-months .flatpickr-prev-month:hover, .flatpickr-months .flatpickr-next-month:hover { background-color: var(--secondary-color); fill: var(--info-color); }
        .flatpickr-current-month .flatpickr-monthDropdown-months, .flatpickr-current-month .numInputWrapper { font-weight: 600; color: inherit; }
        .flatpickr-weekday { color: var(--text-color-light); font-weight: 600; text-transform: uppercase; font-size: 0.7em; }
        .dayContainer { padding: 5px; }
        .flatpickr-day { border: none; border-radius: 50%; transition: background-color 0.2s, color 0.2s, box-shadow 0.2s; font-weight: 500; }
        .flatpickr-day:hover { background-color: var(--secondary-color); color: var(--text-color); }
        .flatpickr-day.today { border: 2px solid var(--accent-color); color: var(--accent-color); }
        .flatpickr-day.today:hover { background-color: var(--accent-color); color: var(--light-text-color); }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background: var(--primary-color); color: var(--light-text-color); border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color); }
        .flatpickr-day.selected:hover { background: #0b3a8a; }
        .flatpickr-day.disabled { color: rgba(0,0,0,0.2); }
        .flatpickr-time { border-top: 1px solid var(--border-color); background: var(--secondary-color); }
        .flatpickr-time .numInput, .flatpickr-time .flatpickr-am-pm { color: var(--text-color); background: #fff; border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; }
        .flatpickr-time .numInput:hover, .flatpickr-time .flatpickr-am-pm:hover { background: #eef2f7; }
        .flatpickr-time .numInputWrapper span.arrowUp, .flatpickr-time .numInputWrapper span.arrowDown { opacity: 0.7; transition: opacity 0.2s; }
        .flatpickr-time .numInputWrapper span.arrowUp:hover, .flatpickr-time .numInputWrapper span.arrowDown:hover { opacity: 1; }
        .flatpickr-monthSelect-months { display: block; grid-template-columns: repeat(auto-fit, minmax(95px, 1fr)); gap: 5px; padding: 5px; }
        .flatpickr-monthSelect-month { border-radius: 6px; padding: 10px 5px; font-weight: 500; text-align: center; transition: background-color 0.2s, color 0.2s; cursor: pointer; }
        .flatpickr-monthSelect-month:hover { background-color: var(--secondary-color); color: var(--primary-color); }
        .flatpickr-monthSelect-month.selected { background-color: var(--primary-color); color: var(--light-text-color); }

        /* --- Hover Effect Enhancements --- */
        .reminder-card, .appointment-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .reminder-card:hover, .appointment-card:hover { transform: translateY(-3px); box-shadow: 0 8px 16px rgba(30, 41, 59, 0.1); }
        .tab-button:hover { transform: translateY(-2px); background-color: rgba(0,0,0,0.02); }
        .calendar-day { transition: background-color 0.2s, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .calendar-day:not(.other-month):hover { transform: translateY(-3px); box-shadow: var(--box-shadow); cursor: pointer; }
        
        /* --- START: NEW Recurring Availability Styles --- */
        .recurring-day-accordion { border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 10px; overflow: hidden; }
        .accordion-header { background-color: var(--secondary-color); padding: 12px 15px; font-weight: 600; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .accordion-header:hover { background-color: #e2e8f0; }
        .accordion-header::after { content: '▼'; font-size: 0.8em; transition: transform 0.3s ease; }
        .accordion-header.active::after { transform: rotate(180deg); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; background-color: #fff; padding: 0 15px; }
        .accordion-content.open { max-height: 500px; padding: 15px 15px; }
        .time-block { margin-bottom: 15px; }
        .time-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
        .time-block-header h4 { margin: 0; font-size: 0.9em; color: var(--text-color-light); }
        .select-all-btn { background: none; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 3px 8px; font-size: 0.8em; font-weight: normal; border-radius: 6px; }
        .time-block-slots { display: flex; flex-wrap: wrap; gap: 8px; }
        .slot-chip { background: #e9ecef; padding: 6px 12px; border-radius: 15px; font-size: 0.85em; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid transparent; }
        .slot-chip.selected { background: var(--primary-color); color: white; border-color: var(--primary-color); }
        /* --- END: NEW Recurring Availability Styles --- */
        
        /* --- Available Slots Picker --- */
        .available-slots-picker { margin-top: 10px; max-height: 150px; overflow-y: auto; padding: 5px; border: 1px solid var(--border-color); border-radius: 8px; }
        .slot-picker-btn { display: inline-block; width: auto; margin: 3px; padding: 6px 12px; font-size: 0.9em; background-color: var(--secondary-color); border: 1px solid var(--border-color); }
        .slot-picker-btn:hover { background-color: var(--primary-color); color: white; }

        /* --- START: Toast Notification Styles --- */
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 10000; }
        .toast { background-color: var(--text-color); color: var(--light-text-color); padding: 15px 20px; border-radius: var(--border-radius); box-shadow: 0 5px 15px rgba(0,0,0,0.2); margin-bottom: 10px; opacity: 0; transform: translateX(100%); animation: toast-in 0.5s forwards, toast-out 0.5s 4.5s forwards; font-weight: 600; }
        .toast.success { background-color: var(--accent-color); }
        .toast.error { background-color: var(--danger-color); }
        @keyframes toast-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes toast-out { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
        /* --- END: Toast Notification Styles --- */

        /* Tablet Responsive Styles */
        @media (max-width: 992px) { 
            body { padding: 15px; }
            .app-layout { flex-direction: column; } 
            .sidebar { display: none; }
            body.logged-in #show-availability-fab { display: flex; }
        }

        /* Phone Responsive Styles */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .container, .sidebar { padding: 15px; }
            header { flex-direction: column; align-items: flex-start; gap: 15px; }
            header h1 { font-size: 1.5em; }
            .tabs { flex-wrap: nowrap; overflow-x: auto; padding-bottom: 5px; -ms-overflow-style: none; scrollbar-width: none; }
            .tabs::-webkit-scrollbar { display: none; }
            .tab-button { flex-grow: 0; flex-shrink: 0; }
            .prospect-meta { flex-direction: column; gap: 5px; align-items: flex-start; }
            .prospect-meta .separator { display: none; }
            .dashboard-header { flex-direction: column; align-items: flex-start; gap: 15px; margin-bottom: 20px; }
            .dashboard-header .controls { display: grid; grid-template-columns: 1fr 1fr; width: 100%; }
            .filter-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
            .filter-controls .search-bar { grid-column: 1 / -1; }
            .login-card { padding: 25px; }
            header .controls .btn-success { padding: 10px 15px; font-size: 0.9em; }
            .prospect-card .card-header h3 { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; line-height: 1.4; }
            .prospect-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }
  </style>
 
<style id="all-prospects-mobile-fixes">
/* === All Prospects: mobile layout fixes (scoped) === */

/* Prevent flex/grid children from overflowing on small screens */
#all-prospects .filter-controls,
#all-prospects .filter-controls > * {
  min-width: 0;
}

/* Normalize spacing to match other tabs */
#all-prospects h2 { margin: 4px 0 12px; }
#all-prospects .toggle-switch { margin-bottom: 10px; }
#all-prospects .filter-controls { margin-bottom: 14px; }

/* Keep menu from pushing header text */
#all-prospects .prospect-card { position: relative; }
#all-prospects .card-menu-container { flex-shrink: 0; }
#all-prospects .card-header h3 { min-width: 0; }

/* Ensure inputs/selects don't get cramped at tablet widths */
@media (max-width: 768px) {
  #all-prospects .search-bar,
  #all-prospects #status-filter,
  #all-prospects #sort-by {
    flex: 1 1 auto;
  }
}

/* Very small phones: stack filters into a single column */
@media (max-width: 420px) {
  #all-prospects .filter-controls {
    display: grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }
  #all-prospects .filter-controls .search-bar,
  #all-prospects #status-filter,
  #all-prospects #sort-by {
    width: 100%;
  }
}
</style>

</head>
 <body>
  <!-- Early language init & live toggle binding -->
  <script>
   (function(){
  const preferred = localStorage.getItem('preferredLanguage') || 'zh-CN';
  window.currentLang = preferred;
  function trySet(){
    if (typeof setLanguage === 'function') {
      setLanguage(preferred);
      window._langInitDone = true;
    } else {
      setTimeout(trySet, 30);
    }
  }
  trySet();

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('#lang-toggle');
    if (!btn) return;
    const next = (window.currentLang === 'zh-CN') ? 'en' : 'zh-CN';
    if (typeof setLanguage === 'function') setLanguage(next);
  }, { passive: true });
})();
  </script>
  <div id="toast-container">
  </div>
  <div id="loading-screen">
   <div class="welcome-message">
    <span id="welcome-icon">
     💎
    </span>
    <span id="welcome-text">
     欢迎钻石们!
    </span>
   </div>
  </div>
  <div id="auth-container" style="display: none;">
   <div class="login-card">
    <img alt="Logo" class="login-logo" src="images/icon-192x192.png"/>
    <h2 id="auth-title">
     Welcome Back
    </h2>
    <p id="auth-subtitle">
     Login to track your prospects.
    </p>
    <div class="auth-form-group">
     <span class="icon">
      📧
     </span>
     <input autocomplete="email" id="auth-email" placeholder="Email" type="email"/>
    </div>
    <div class="auth-form-group">
     <span class="icon">
      🔒
     </span>
     <input autocomplete="current-password" id="auth-password" placeholder="Password" type="password"/>
     <span class="password-toggle" id="password-toggle">
      👁️
     </span>
    </div>
    <div class="auth-form-group" id="confirm-password-group" style="display: none;">
     <span class="icon">
      🔑
     </span>
     <input autocomplete="new-password" id="auth-confirm-password" placeholder="Confirm Password" type="password"/>
    </div>
    <div class="login-actions">
     <button class="btn-primary" id="auth-action-btn">
      Login
     </button>
    </div>
    <button class="btn-secondary" id="google-signin-btn" style="width:100%; margin-top: 10px;">
     Sign in with Google
    </button>
    <div class="auth-footer">
     <p id="auth-toggle-text">
      No account?
      <span class="auth-toggle-link" id="toggle-to-signup">
       Sign up now
      </span>
      .
     </p>
     <a class="forgot-password-link" href="#" id="forgot-password-link">
      Forgot Password?
     </a>
    </div>
   </div>
  </div>
  <div class="app-layout" id="main-app" style="display: none;">
   <div class="main-content">
    <div class="container">
     <header>
      <h1 id="appTitle">
       Amway Prospect Tracker💎
      </h1>
      <div class="controls">
       <button class="btn-secondary" id="lang-toggle" type="button">
        中文
       </button>
       <button class="btn-success" id="add-prospect-btn">
        ➕ Add New Prospect
       </button>
      </div>
     </header>
     <div class="tabs">
      <button class="tab-button active" data-tab="dashboard" id="tabDashboard">
       Dashboard
      </button>
      <button class="tab-button" data-tab="calendar" id="tabCalendar">
       Calendar
      </button>
      <button class="tab-button" data-tab="all-prospects" id="tabAllProspects">
       All Prospects
      </button>
      <button class="tab-button" data-tab="analytics" id="tabAnalytics">
       Analytics
      </button>
      <button class="tab-button" data-tab="settings" id="tabSettings">
       Settings
      </button>
     </div>
     <div class="tab-content active" id="dashboard">
      <div class="dashboard-header">
       <h2 id="upcomingAppointmentsTitle">
        Upcoming Appointments 📅
       </h2>
       <div class="controls">
        <button class="btn-secondary" id="copy-stp-btn">
         Copy STP List
        </button>
        <button class="btn-secondary" id="copy-gms-btn">
         Copy GMS List
        </button>
       </div>
      </div>
      <div class="reminders-grid" id="appointments-grid">
      </div>
      <h2 id="followUpTitle" style="margin-top: 30px;">
       Follow-up Needed 📞
      </h2>
      <div class="reminders-grid" id="follow-ups-grid">
      </div>
     </div>
     <div class="tab-content" id="calendar">
      <div class="calendar-header">
       <button id="prev-month">
        &lt;
       </button>
       <h2 id="current-month-year">
       </h2>
       <button id="next-month">
        &gt;
       </button>
      </div>
      <div class="planner-legend" id="calendar-legend">
       <span class="legend-item">
        <span class="appointment-dot dot-stp">
        </span>
        <span id="legend-stp">
        </span>
       </span>
       <span class="legend-item">
        <span class="appointment-dot dot-gms">
        </span>
        <span id="legend-gms">
        </span>
       </span>
      </div>
      <div class="calendar-grid" id="calendar-grid-header">
      </div>
      <div class="calendar-grid" id="calendar-grid-body">
      </div>
     </div>
     <div class="tab-content" id="all-prospects">
      <h2 id="allProspectsTitle">
       All Prospects
      </h2>
      <div class="toggle-switch" id="prospect-view-toggle">
      </div>
      <div class="filter-controls">
       <input class="search-bar" id="search-input" type="search"/>
       <select id="status-filter">
       </select>
       <select id="sort-by">
       </select>
      </div>
      <div class="prospect-list" id="prospect-list">
      </div>
      <div class="pagination" id="pagination-controls">
      </div>
     </div>
     <div class="tab-content" id="analytics">
      <h2 id="analyticsTitle">
       Monthly Analytics
      </h2>
      <div class="toggle-switch" id="analytics-view-toggle">
      </div>
      <div class="form-group" id="downline-analytics-controls" style="display: none;">
       <label for="downline-filter" id="downline-filter-label">
        Filter by Downline:
       </label>
       <select id="downline-filter">
       </select>
      </div>
      <div class="form-group">
       <label for="analytics-month" id="analyticsMonthLabel">
        Select Month:
       </label>
       <input id="analytics-month" type="text"/>
      </div>
      <div class="analytics-grid" id="analytics-summary">
      </div>
      <hr/>
      <h3 id="analytics-trend-title" style="text-align: center; color: var(--primary-color);">
       6-Month Performance Trend
      </h3>
      <div id="trend-chart-container" style="position: relative; height:40vh; width:100%; margin-top: 20px;">
       <canvas id="analyticsTrendChart">
       </canvas>
      </div>
     </div>
     <div class="tab-content" id="settings">
      <h2 id="settingsTitle">
       Data &amp; Settings
      </h2>
      <div class="settings-card" style="border-left-color: var(--warning-color);">
       <h3>
        Account
       </h3>
       <p>
        <strong>
         Logged in as:
        </strong>
        <span id="user-email">
        </span>
       </p>
       <div class="controls">
        <button class="btn-secondary" id="logout-btn">
         Logout
        </button>
       </div>
      </div>
      <div class="settings-card" style="border-left-color: var(--accent-color); margin-top: 20px;">
       <h3 id="recurringAvailabilityTitle">
        Set Recurring Weekly Availability
       </h3>
       <p id="recurringAvailabilityDesc">
        Set your fixed weekly schedule here. These slots will be automatically applied to future dates.
       </p>
       <div id="recurring-availability-form">
       </div>
       <button class="btn-primary" id="save-recurring-btn" style="margin-top: 15px;">
        Save Recurring Slots
       </button>
      </div>
      <div class="settings-card" style="border-left-color: var(--primary-color); margin-top: 20px;">
       <h3 id="backupSyncTitle">
        Backup &amp; Sync
       </h3>
       <p id="backupSyncDesc">
        Export all your data (prospects and availability) to a single file. You can Save this file as a backup or import it on another device to sync your data.
       </p>
       <div class="controls">
        <button class="btn-primary" id="exportData">
         Export Data
        </button>
        <label class="btn-secondary btn-file-input">
         <span id="importDataLabel">
          Import Data
         </span>
         <input accept=".json" id="importData" style="display: none;" type="file"/>
        </label>
       </div>
      </div>
      <div class="settings-card" style="border-left-color: var(--info-color); margin-top: 20px;">
       <h3>
        Data Status
       </h3>
       <p>
        <strong>
         Last Synced/Imported:
        </strong>
        <span id="last-sync-time">
         Never
        </span>
       </p>
       <p>
        <strong>
         Total Prospects:
        </strong>
        <span id="total-prospects">
         0
        </span>
       </p>
      </div>
      <div class="settings-card" style="border-left-color: var(--danger-color); margin-top: 20px;">
       <h3 id="dangerZoneTitle">
        Danger Zone
       </h3>
       <p id="dangerZoneDesc">
        this action will permanently delete all your prospect and availability data.
       </p>
       <button class="btn-danger" id="clearData">
        Clear All Data
       </button>
      </div>
     </div>
    </div>
   </div>
   <div class="sidebar">
    <h3 id="sidebar-title">
     Upcoming Available Slots
    </h3>
    <div id="available-slots-list">
    </div>
   </div>
  </div>
  <div class="modal" id="prospect-modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="modal-title">
      Add New Prospect
     </h2>
     <span class="close-button" id="close-modal">
      &times;
     </span>
    </div>
    <form id="prospect-form">
     <input id="prospect-id" type="hidden"/>
     <div class="form-group">
      <label id="owner-type-label">
       This prospect belongs to:
      </label>
      <select id="owner-type">
       <option id="owner-user-option" value="user">
        Myself
       </option>
       <option id="owner-downline-option" value="downline">
        My Downline
       </option>
      </select>
     </div>
     <div class="form-group" id="downline-name-group" style="display: none;">
      <label for="downline-name" id="downline-name-label">
       Downline's Name:
      </label>
      <input id="downline-name" list="downline-names-list" type="text"/>
      <datalist id="downline-names-list">
      </datalist>
     </div>
     <div class="form-group">
      <label for="name" id="labelName">
       Name:
      </label>
      <input id="name" required="" type="text"/>
     </div>
     <div class="form-group">
      <label for="phone" id="labelPhone">
       Phone:
      </label>
      <input id="phone" type="text"/>
     </div>
     <div class="form-group">
      <label for="age" id="labelAge">
       Age:
      </label>
      <input id="age" type="number"/>
     </div>
     <div class="form-group">
      <label for="occupation" id="labelOccupation">
       Occupation:
      </label>
      <input id="occupation" type="text"/>
     </div>
     <div class="form-group">
      <label for="tags" id="labelTags">
       Tags (comma-separated):
      </label>
      <input id="tags" type="text"/>
     </div>
     <div class="form-group">
      <label for="stp-datetime" id="labelStpTime">
       STP Appointment Time:
      </label>
      <input id="stp-datetime" required="" type="text"/>
      <div class="available-slots-picker" id="stp-available-slots">
      </div>
     </div>
     <div class="form-group">
      <label for="notes" id="labelNotes">
       Notes:
      </label>
      <textarea id="notes" rows="3"></textarea>
     </div>
     <button class="btn-success" id="save-prospect-btn" type="submit">
      Save
     </button>
    </form>
   </div>
  </div>
  <div class="modal" id="action-modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="action-modal-title">
      Update Prospect Status
     </h2>
     <span class="close-button" id="action-close-modal">
      &times;
     </span>
    </div>
    <form id="action-form">
     <input id="action-prospect-id" type="hidden"/>
     <input id="action-type" type="hidden"/>
     <div class="form-group" id="gms-schedule-group" style="display:none;">
      <label for="gms-datetime" id="labelGmsTime">
       GMS Appointment Time:
      </label>
      <input id="gms-datetime" type="text"/>
      <div class="available-slots-picker" id="gms-available-slots">
      </div>
     </div>
     <div class="form-group">
      <label for="action-notes" id="labelActionNotes">
       Follow-up Notes (Optional):
      </label>
      <textarea id="action-notes" rows="4"></textarea>
     </div>
     <button class="btn-success" id="confirm-action-btn" type="submit">
      Confirm
     </button>
    </form>
   </div>
  </div>
  <div class="modal" id="planner-modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="planner-title">
      Daily Availability Planner
     </h2>
     <span class="close-button" id="close-planner-modal">
      &times;
     </span>
    </div>
    <div class="planner-container">
     <div class="planner-appointments">
      <h3 id="planner-appointments-title">
       Confirmed Appointments
      </h3>
      <ul id="planner-appointments-list">
      </ul>
     </div>
     <div class="planner-timeline">
      <h3 id="planner-timeline-title">
       Set Your Availability
      </h3>
      <div class="planner-legend">
       <span class="legend-item">
        <span class="legend-color available">
        </span>
        <span id="legend-available">
         Available
        </span>
       </span>
       <span class="legend-item">
        <span class="legend-color booked">
        </span>
        <span id="legend-booked">
        </span>
        Booked
       </span>
       <span class="legend-item">
        <span class="legend-color busy">
        </span>
        <span id="legend-busy">
        </span>
        Busy
       </span>
      </div>
      <div id="planner-timeline-slots">
      </div>
     </div>
    </div>
    <div class="planner-footer">
     <button class="btn-primary" id="save-availability-btn">
      Save Availability
     </button>
    </div>
   </div>
  </div>
  <div class="modal" id="availability-modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="availability-modal-title">
      Upcoming Available Slots
     </h2>
     <span class="close-button" id="close-availability-modal">
      &times;
     </span>
    </div>
    <div id="modal-slots-list">
    </div>
   </div>
  </div>
  <div class="modal" id="forgot-password-modal">
   <div class="modal-content">
    <div class="modal-header">
     <h2 id="forgot-password-title">
      Reset Password
     </h2>
     <span class="close-button" id="close-forgot-password-modal">
      &times;
     </span>
    </div>
    <p id="forgot-password-instructions">
     Enter your email address and we will send you instructions to reset your password.
    </p>
    <div class="form-group">
     <label for="reset-email" id="label-reset-email">
      Email
     </label>
     <input id="reset-email" placeholder="your.email@example.com" type="email"/>
    </div>
    <button class="btn-primary" id="send-reset-btn" style="width: 100%;">
     Send Reset Instructions
    </button>
   </div>
  </div>
  <button id="show-availability-fab">
   📅
  </button>
  <script src="libs/supabase.js">
  </script>

  <script>
  // Wait for flatpickr to be available before using it
  function whenFlatpickrReady(fn) {
    if (window.flatpickr) {
      try { fn(window.flatpickr); } catch (e) { console.error(e); }
    } else {
      const __fpWait = setInterval(() => {
        if (window.flatpickr) {
          clearInterval(__fpWait);
          try { fn(window.flatpickr); } catch (e) { console.error(e); }
        }
      }, 25);
    }
  }
  </script>
  <script defer="" src="libs/flatpickr.js">
  </script>
  <script defer="" src="libs/chart.js">
  </script>
  <script>
   function runWhenSupabaseReady(fn){
  if (typeof supabase !== 'undefined' && supabase) { try { fn(); } catch(e) { console.error(e); } return; }
  if (typeof supabaseReady !== 'undefined' && supabaseReady && typeof supabaseReady.then === 'function') {
    supabaseReady.then(() => { try { fn(); } catch(e) { console.error(e); } });
  } else {
    const t = setInterval(() => {
      if (typeof supabase !== 'undefined' && supabase) { clearInterval(t); try { fn(); } catch(e){ console.error(e);} }
    }, 25);
  }
}
  </script>
  <script>
   function monthSelectPlugin(pluginConfig) {
        const defaultConfig = {
            shorthand: false,
            dateFormat: "F Y",
            altFormat: "F Y",
            theme: "light",
        };

        const config = { ...defaultConfig, ...pluginConfig };

        return function(fp) {
            fp.config.dateFormat = config.dateFormat;
            fp.config.altFormat = config.altFormat;

            const self = { monthsContainer: null };

            function getEventTarget(event) {
                try {
                    if (typeof event.composedPath === "function") {
                        const path = event.composedPath();
                        return path[0];
                    }
                    return event.target;
                } catch (error) {
                    return event.target;
                }
            }
            
            function clearNode(node) {
                if (!node) return;
                while (node.firstChild) {
                    node.removeChild(node.firstChild);
                }
            }

            function buildMonths() {
                if (!self.monthsContainer) return;
                clearNode(self.monthsContainer);
                const frag = document.createDocumentFragment();
                for (let i = 0; i < 12; i++) {
                    const month = fp.createDay("flatpickr-monthSelect-month", new Date(fp.currentYear, i), 0, i);
                    if (month.dateObj.getMonth() === new Date().getMonth() && month.dateObj.getFullYear() === new Date().getFullYear())
                        month.classList.add("today");
                    month.textContent = fp.l10n.months[config.shorthand ? "shorthand" : "longhand"][i];
                    month.addEventListener("click", selectMonth);
                    frag.appendChild(month);
                }
                self.monthsContainer.appendChild(frag);
                
                if (fp.prevMonthNav) {
                    if (fp.config.minDate && fp.currentYear === fp.config.minDate.getFullYear())
                        fp.prevMonthNav.classList.add("flatpickr-disabled");
                    else
                        fp.prevMonthNav.classList.remove("flatpickr-disabled");
                }

                if (fp.nextMonthNav) {
                    if (fp.config.maxDate && fp.currentYear === fp.config.maxDate.getFullYear())
                        fp.nextMonthNav.classList.add("flatpickr-disabled");
                    else
                        fp.nextMonthNav.classList.remove("flatpickr-disabled");
                }
            }

            function bindEvents() {
                // FIX: Check if nav elements exist before binding events to prevent crash
                if (fp.prevMonthNav) {
                    fp._bind(fp.prevMonthNav, "click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        fp.changeYear(fp.currentYear - 1);
                        selectYear();
                        buildMonths();
                    });
                }
                
                if (fp.nextMonthNav) {
                     fp._bind(fp.nextMonthNav, "click", (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        fp.changeYear(fp.currentYear + 1);
                        selectYear();
                        buildMonths();
                    });
                }

                if (self.monthsContainer) {
                    fp._bind(self.monthsContainer, "mouseover", (e) => {
                        if (fp.config.mode === "range")
                            fp.onMouseOver(getEventTarget(e), "flatpickr-monthSelect-month");
                    });
                }
            }

            function selectYear() {
                let selectedDate = fp.selectedDates[0];
                if (selectedDate) {
                    selectedDate = new Date(selectedDate);
                    selectedDate.setFullYear(fp.currentYear);
                    if (fp.config.minDate && selectedDate < fp.config.minDate) {
                        selectedDate = fp.config.minDate;
                    }
                    if (fp.config.maxDate && selectedDate > fp.config.maxDate) {
                        selectedDate = fp.config.maxDate;
                    }
                    fp.currentYear = selectedDate.getFullYear();
                }

                if (fp.currentYearElement) {
                    fp.currentYearElement.value = String(fp.currentYear);
                }
                if (fp.rContainer) {
                    const months = fp.rContainer.querySelectorAll(".flatpickr-monthSelect-month");
                    months.forEach(month => {
                        month.dateObj.setFullYear(fp.currentYear);
                        if ((fp.config.minDate && month.dateObj < fp.config.minDate) || (fp.config.maxDate && month.dateObj > fp.config.maxDate)) {
                            month.classList.add("flatpickr-disabled");
                        } else {
                            month.classList.remove("flatpickr-disabled");
                        }
                    });
                }
                setCurrentlySelected();
            }
            
            function setCurrentlySelected() {
                 if (!fp.rContainer || !fp.selectedDates.length) return;
                 
                 const currentlySelected = fp.rContainer.querySelectorAll(".flatpickr-monthSelect-month.selected");
                 currentlySelected.forEach(el => el.classList.remove("selected"));
                 
                 const targetMonth = fp.selectedDates[0].getMonth();
                 const month = fp.rContainer.querySelector(`.flatpickr-monthSelect-month:nth-child(${targetMonth + 1})`);
                 if (month) {
                     month.classList.add("selected");
                 }
            }

            function selectMonth(e) {
                e.preventDefault();
                e.stopPropagation();
                const eventTarget = getEventTarget(e);
                if (!(eventTarget instanceof Element) || eventTarget.classList.contains("flatpickr-disabled")) {
                    return;
                }
                setMonth(eventTarget.dateObj);
                if (fp.config.closeOnSelect) {
                    const single = fp.config.mode === "single";
                    const range = fp.config.mode === "range" && fp.selectedDates.length === 2;
                    if (single || range) fp.close();
                }
            }
            
            function setMonth(date) {
                const selectedDate = new Date(fp.currentYear, date.getMonth(), 1);
                fp.setDate([selectedDate], true);
                setCurrentlySelected();
            }
            
            return {
                onParseConfig: function() {
                    fp.config.enableTime = false;
                },
                onValueUpdate: setCurrentlySelected,
                onReady: [
                    () => {
                        if (!fp.rContainer) return;
                        clearNode(fp.rContainer);
                        if(fp.weekdayContainer) fp.weekdayContainer.style.display = 'none';
                        if(fp.daysContainer) fp.daysContainer.style.display = 'none';

                        fp.calendarContainer.classList.add(`flatpickr-monthSelect-theme-${config.theme}`);
                        self.monthsContainer = fp._createElement("div", "flatpickr-monthSelect-months");
                        self.monthsContainer.tabIndex = -1;
                        buildMonths();
                        fp.rContainer.appendChild(self.monthsContainer);
                    },
                    bindEvents,
                    setCurrentlySelected,
                    () => { fp.loadedPlugins.push("monthSelect"); }
                ],
            };
        };
    }
  </script>
  <script>
   // --- START: NEW SUPABASE SETUP ---
        const SUPABASE_URL = 'https://puaofmijvkmamyfugdzi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1YW9mbWlqdmttYW15ZnVnZHppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcwNTkzOTUsImV4cCI6MjA3MjYzNTM5NX0.fVuYgjxpf2pRLYpkCBIfsC5PjBQKKRYtN5hnL9jrZ8A';

        var supabase;
let supabaseReadyResolve;
const supabaseReady = new Promise(r => (supabaseReadyResolve = r));
(function initSupabase() {
  function start() {
    if (window.supabase && typeof window.supabase.createClient === 'function') {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      if (supabaseReadyResolve) supabaseReadyResolve(supabase);
    } else {
      // try again shortly (handles slow script load in some environments)
      setTimeout(start, 25);
    }
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', start);
  } else {
    start();
  }
})();
        // --- END: NEW SUPABASE SETUP ---
        
        // --- FIX: Add Flatpickr Chinese Locale directly to prevent loading errors ---
        const flatpickr_zh_locale = {
            weekdays: { shorthand: ["日", "一", "二", "三", "四", "五", "六"], longhand: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"], },
            months: { shorthand: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"], longhand: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"], },
            rangeSeparator: " 至 ",
            weekAbbreviation: "周",
            scrollTitle: "滚动切换",
            toggleTitle: "点击切换 12/24 小时时制"
        };
        if (window.flatpickr) {
            window.flatpickr.l10ns.zh = flatpickr_zh_locale;
        }
        
        // --- Global State Variables ---
        let currentPage = 1;
        const PROSPECTS_PER_PAGE = 8;
        let trendChartInstance = null;
        let isLoginView = true;
        let currentLang = 'zh-CN';
        let calendarDate = new Date();
        let prospects = [];
        let availability = {};
        let recurringAvailability = {};
        let prospectViewFilter = 'user'; 
        let analyticsView = 'user'; 
        let lastSyncTimestamp = null;

        const translations = {
            'zh-CN': {
                tabCalendar: "日历", appTitle: "安利对象跟进系统💎", addProspectBtn: "➕ 添加新对象", tabDashboard: "对象跟进中心", tabAllProspects: "所有对象列表", tabAnalytics: "数据分析", tabSettings: "设置", tabGuide: "指南",
                upcomingAppointmentsTitle: "未来预约 📅", followUpTitle: "需要跟进 📞", noAppointmentsText: "没有未来的预约。", noFollowUpsText: "目前没有需要跟进对象。", allProspectsTitle: "所有对象",
                analyticsTitle: "月度数据分析", analyticsMonthLabel: "选择月份:", settingsTitle: "数据与设置", 
                backupSyncTitle: "备份与同步", backupSyncDesc: "将您的所有数据（对象和可用时间）导出到一个文件中。您可以保存此文件作为备份，或在另一台设备上导入它以同步您的数据。",
                exportData: "导出数据", importDataLabel: "导入数据", importConfirm: "您确定要用此文件中的数据覆盖所有当前数据吗？此操作无法撤销。", importSuccess: "数据导入成功！", importError: "文件无效或已损坏。",
                dangerZoneTitle: "危险区域", dangerZoneDesc: "此操作将永久删除您的所有对象和可用时间数据。",
                clearData: "清除所有数据", modalTitleAdd: "添加对象", modalTitleEdit: "编辑对象信息", labelName: "名字:", labelPhone: "号码:", labelAge: "年龄:",
                labelOccupation: "职业:", labelTags: "标签 (用逗号分隔):", tagsPlaceholder: "例如：学生, 槟城, 朋友", labelStpTime: "STP 邀约时间:", labelNotes: "备注:", saveProspectBtn: "保存", status: "状态",
                kitCounter: "跟进次数", actions: "操作", confirmClearData: "您确定要永久删除所有数据吗？", dataCleared: "所有数据已清除。", searchPlaceholder: "搜索名字, 号码, 或标签...",
                sort: { label: "排序:", newest: "最新优先 (STP日期)", name_az: "名字 (A-Z)", name_za: "名字 (Z-A)", status: "状态" }, dayNames: ['日', '一', '二', '三', '四', '五', '六'], dayDetailsTitle: '的预约',
                buttonEdit: "编辑", buttonDelete: "删除", confirmDelete: "您确定要永久删除这位对象吗？此操作无法撤销。",
                plannerTitle: "每日可用时间规划", plannerAppointmentsTitle: "已确认的预约", plannerTimelineTitle: "设置您的可用时间", saveAvailability: "保存可用时间", noAppointmentsToday: "今日无预约",
                legendAvailable: "可用", legendBooked: "已预约", legendBusy: "忙碌", legendStp: "STP预约", legendGms: "GMS预约",
                sidebarTitle: "未来可用时段", noAvailableSlots: "没有可用的时间段", availabilityModalTitle: "未来可用时段", allStatuses: "所有状态",
                ownerTypeLabel: "这位对象属于:", ownerUserOption: "我自己", ownerDownlineOption: "我的下线", downlineNameLabel: "下线名字:", downlineInfo: "下线对象: ",
                prospectViewToggleMine: "我的对象", prospectViewToggleDownlines: "下线对象", prospectViewToggleAll: "全部",
                analyticsViewToggleMine: "我的分析", analyticsViewToggleDownlines: "下线支持分析", downlineFilterLabel: "筛选下线:", allDownlinesOption: "所有下线",
                errorDoubleBooking: "此时间段已被预约，请选择其他时间。", errorDownlineNameRequired: "请输入下线名字。",
                errorGmsAfterStp: "GMS 时间必须在 STP 时间之后。",
                confirmJoin: "确定要将对象标记为“已加入”吗？", confirmDisqualify: "确定要将此对象标记为“不合适”吗？", confirmNotJoining: "确定要将此对象标记为“不加入”吗？",
                STP: "已邀约STP", GMS_Appointment: "已邀约GMS", KIT_STP: "跟进中 (STP后)", KIT_GMS: "跟进中 (GMS后)", Joined: "已加入", Disqualified: "不合适", Not_Joining: "不加入",
                actionScheduleGMS: "安排GMS", actionKeepInTouch: "保持联系", actionDisqualify: "不合适", actionJoined: "已加入", actionNotJoining: "不加入", actionFollowUp: "进行跟进", actionEditGMS: "修改GMS时间",
                actionModalTitle: "更新对象状态", labelGmsTime: "GMS 邀约时间:", labelActionNotes: "跟进备注 (可选):", confirmActionBtn: "确认", phone: "号码", age: "年龄", occupation: "职业",
                kit_counter: "跟进次数", stp_time: "STP时间", notes: "备注", name: "名字", analytics: { new_stps: "新增STP", new_gms: "新增GMS", new_joins: "成功加入", new_disqualified: "不合适/不加入" },
                guidePeriodLingchen: "凌晨", guidePeriodZaoshang: "早上", guidePeriodZhongwu: "中午", guidePeriodXiawu: "下午", guidePeriodBangwan: "傍晚", guidePeriodWanshang: "晚上",
                analyticsTrendTitle: "6个月表现趋势",
                copyStpBtn: "复制STP列表", copyGmsBtn: "复制GMS列表", copied: "已复制!",
                welcome: "欢迎钻石们!",
                recurringAvailabilityTitle: "设置每周重复可用时间",
                recurringAvailabilityDesc: "在这里设置您每周固定的可用时间。这些时间将自动应用到未来的日期。",
                saveRecurringBtn: "保存重复时间",
                selectAll: "全选"
            },
            'en': {
                tabCalendar: "Calendar", appTitle: "Amway Prospect Tracker💎", addProspectBtn: "➕ Add New Prospect", tabDashboard: "Dashboard", tabAllProspects: "All Prospects", tabAnalytics: "Analytics", tabSettings: "Settings", tabGuide: "Guide",
                upcomingAppointmentsTitle: "Upcoming Appointments 📅", followUpTitle: "Follow-up Needed 📞", noAppointmentsText: "No upcoming appointments.", noFollowUpsText: "No prospects to follow up with right now.",
                allProspectsTitle: "All Prospects", analyticsTitle: "Monthly Analytics", analyticsMonthLabel: "Select Month:", settingsTitle: "Data & Settings", 
                backupSyncTitle: "Backup & Sync", backupSyncDesc: "Export all your data (prospects and availability) to a single file. You can save this file as a backup or import it on another device to sync your data.",
                exportData: "Export Data", importDataLabel: "Import Data", importConfirm: "Are you sure you want to overwrite all current data with the data from this file? This action cannot be undone.", importSuccess: "Data imported successfully!", importError: "Invalid or corrupted file.",
                dangerZoneTitle: "Danger Zone", dangerZoneDesc: "This action will permanently delete all your prospect and availability data.",
                clearData: "Clear All Data", modalTitleAdd: "Add New Prospect", modalTitleEdit: "Edit Prospect Info", labelName: "Name:", labelPhone: "Phone:", labelAge: "Age:",
                labelOccupation: "Occupation:", labelTags: "Tags (comma-separated):", tagsPlaceholder: "e.g. Student, Penang, Friend", labelStpTime: "STP Appointment Time:", labelNotes: "Notes:",
                saveProspectBtn: "Save", status: "Status", kitCounter: "Follow-up Count", actions: "Actions", confirmClearData: "Are you sure you want to permanently delete all data?",
                dataCleared: "All data has been cleared.", searchPlaceholder: "Search by name, phone, or tag...", dayNames: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'], dayDetailsTitle: "Appointments for",
                sort: { label: "Sort by:", newest: "Newest First (STP Date)", name_az: "Name (A-Z)", name_za: "Name (Z-A)", status: "Status" },
                buttonEdit: "Edit", buttonDelete: "Delete", confirmDelete: "Are you sure you want to permanently delete this prospect? This action cannot be undone.",
                plannerTitle: "Daily Availability Planner", plannerAppointmentsTitle: "Confirmed Appointments", plannerTimelineTitle: "Set Your Availability", saveAvailability: "Save Availability", noAppointmentsToday: "No appointments today",
                legendAvailable: "Available", legendBooked: "Booked", legendBusy: "Busy", legendStp: "STP Appointment", legendGms: "GMS Appointment",
                sidebarTitle: "Upcoming Available Slots", noAvailableSlots: "No available slots found.", availabilityModalTitle: "Upcoming Available Slots", allStatuses: "All Statuses",
                ownerTypeLabel: "This prospect belongs to:", ownerUserOption: "Myself", ownerDownlineOption: "My Downline", downlineNameLabel: "Downline's Name:", downlineInfo: "Downline's Prospect: ",
                prospectViewToggleMine: "My Prospects", prospectViewToggleDownlines: "Downline's", prospectViewToggleAll: "All",
                analyticsViewToggleMine: "My Analytics", analyticsViewToggleDownlines: "Downline Support", downlineFilterLabel: "Filter by Downline:", allDownlinesOption: "All Downlines",
                errorDoubleBooking: "This time slot is already booked. Please choose another time.", errorDownlineNameRequired: "Please enter the downline's name.",
                errorGmsAfterStp: "GMS time must be after the STP time.",
                confirmJoin: "Are you sure you want to mark this prospect as 'Joined'?", confirmDisqualify: "Are you sure you want to mark this prospect as 'Disqualified'?", confirmNotJoining: "Are you sure you want to mark this prospect as 'Not Joining'?",
                STP: "STP Scheduled", GMS_Appointment: "GMS Scheduled", KIT_STP: "Keep In Touch (Post-STP)", KIT_GMS: "Keep In Touch (Post-GMS)", Joined: "Joined",
                Disqualified: "Disqualified", Not_Joining: "Not Joining", actionScheduleGMS: "Schedule GMS", actionKeepInTouch: "Keep In Touch", actionDisqualify: "Disqualify",
                actionJoined: "Mark as Joined", actionNotJoining: "Mark as Not Joining", actionFollowUp: "Follow Up", actionEditGMS: "Edit GMS Time", actionModalTitle: "Update Prospect Status",
                labelGmsTime: "GMS Appointment Time:", labelActionNotes: "Follow-up Notes (Optional):", confirmActionBtn: "Confirm", phone: "Phone", age: "Age",
                occupation: "Occupation", kit_counter: "KIT Count", stp_time: "STP Time", notes: "Notes", name: "Name",
                analytics: { new_stps: "New STPs", new_gms: "New GMS", new_joins: "New Joins", new_disqualified: "Disqualified / Not Joining" },
                analyticsTrendTitle: "6-Month Performance Trend",
                copyStpBtn: "Copy STP List", copyGmsBtn: "Copy GMS List", copied: "Copied!",
                welcome: "Welcome Diamonds!",
                recurringAvailabilityTitle: "Set Recurring Weekly Availability",
                recurringAvailabilityDesc: "Set your fixed weekly schedule here. These slots will be automatically applied to future dates.",
                saveRecurringBtn: "Save Recurring Slots",
                selectAll: "Select All"
            }
        };

        // =======================================================
        // --- START: UTILITY & HELPER FUNCTIONS
        // =======================================================
        
        /**
        * Shows a toast notification.
        * @param {string} message - The message to display.
        * @param {string} [type='info'] - The type of toast ('success', 'error', 'info').
        */
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }
        
        /**
        * Sets the loading state for a button.
        * @param {HTMLElement} button - The button element.
        * @param {boolean} isLoading - Whether to show the loading state.
        * @param {string} [loadingText='Loading...'] - Text to show when loading.
        */
        function setButtonLoading(button, isLoading, loadingText = 'Loading...') {
            if (isLoading) {
                button.dataset.originalText = button.innerHTML;
                button.innerHTML = loadingText;
                button.disabled = true;
            } else {
                if (button.dataset.originalText) {
                    button.innerHTML = button.dataset.originalText;
                }
                button.disabled = false;
            }
        }


        // =======================================================
        // --- START: INITIALIZATION OF DATE PICKERS
        // =======================================================
        // ROBUSTNESS FIX: Declare pickers here, but initialize them inside startApp
        let stpPicker, gmsPicker, analyticsPicker; 

        // --- START: NEW EVENT LISTENERS & LOGIC FOR LOGIN PAGE ---
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            forgotPasswordModal.style.display = 'flex';
        });
        
        document.getElementById('close-forgot-password-modal').onclick = () => {
            forgotPasswordModal.style.display = 'none';
        };
        
        document.getElementById('send-reset-btn').addEventListener('click', async () => {
            const email = document.getElementById('reset-email').value;
            if (!email) {
                alert('Please enter your email address.');
                return;
            }
            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.href.split('#')[0],
            });

            if (error) {
                alert(`Error: ${error.message}`);
            } else {
                alert('Password reset instructions have been sent to your email.');
                forgotPasswordModal.style.display = 'none';
            }
        });

        document.getElementById('password-toggle').addEventListener('click', (e) => {
            const passwordInput = document.getElementById('auth-password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            e.target.textContent = type === 'password' ? '👁️' : '🙈';
        });
        // --- END: New Event Listeners & Logic for Login Page ---


        function setLanguage(lang) {
    // Ensure flatpickr is localized only after it's loaded
    whenFlatpickrReady((fp) => {
      try {
        if (typeof flatpickr_zh_locale !== 'undefined') {
          fp.l10ns.zh = fp.l10ns.zh || flatpickr_zh_locale;
        }
        if (lang === 'zh-CN' && fp.l10ns.zh) {
          fp.localize(fp.l10ns.zh);
        } else {
          fp.localize(fp.l10ns.default || {});
        }
      } catch (e) { console.warn('flatpickr localization skipped:', e); }
    });

            currentLang = lang; 
            window.currentLang = lang; 
            document.documentElement.lang = lang; 
            localStorage.setItem('preferredLanguage', lang); // Save preference
            const t = translations[lang];

            // Set locale for flatpickr instances
            const locale = lang === 'zh-CN' ? 'zh' : 'default';
            if (flatpickr.l10ns[locale]) {
                stpPicker?.set('locale', locale);
                gmsPicker?.set('locale', locale);
                analyticsPicker?.set('locale', locale);
            }

            const elements = {
                appTitle: t.appTitle, 'add-prospect-btn': t.addProspectBtn, 'lang-toggle': lang === 'zh-CN' ? 'English' : '中文', tabDashboard: t.tabDashboard, tabCalendar: t.tabCalendar,
                tabAllProspects: t.tabAllProspects, tabAnalytics: t.tabAnalytics, tabSettings: t.tabSettings, tabGuide: t.tabGuide,
                upcomingAppointmentsTitle: t.upcomingAppointmentsTitle, followUpTitle: t.followUpTitle,
                allProspectsTitle: t.allProspectsTitle, analyticsTitle: t.analyticsTitle, analyticsMonthLabel: t.analyticsMonthLabel, settingsTitle: t.settingsTitle,
                backupSyncTitle: t.backupSyncTitle, backupSyncDesc: t.backupSyncDesc, exportData: t.exportData, importDataLabel: t.importDataLabel,
                dangerZoneTitle: t.dangerZoneTitle, dangerZoneDesc: t.dangerZoneDesc,
                clearData: t.clearData, modalTitleAdd: t.modalTitleAdd, modalTitleEdit: t.modalTitleEdit, labelName: t.labelName, labelPhone: t.labelPhone, labelAge: t.labelAge,
                labelOccupation: t.labelOccupation, labelTags: t.labelTags, labelStpTime: t.labelStpTime, labelNotes: t.labelNotes, 'save-prospect-btn': t.saveProspectBtn,
                labelGmsTime: t.labelGmsTime, labelActionNotes: t.labelActionNotes, 'confirm-action-btn': t.confirmActionBtn, 'action-modal-title': t.actionModalTitle,
                'planner-appointments-title': t.plannerAppointmentsTitle, 'planner-timeline-title': t.plannerTimelineTitle, 'save-availability-btn': t.saveAvailability,
                'legend-available': t.legendAvailable, 'legend-booked': t.legendBooked, 'legend-busy': t.legendBusy, 'legend-stp': t.legendStp, 'legend-gms': t.legendGms,
                'sidebar-title': t.sidebarTitle, 'availability-modal-title': t.availabilityModalTitle,
                'owner-type-label': t.ownerTypeLabel, 'owner-user-option': t.ownerUserOption, 'owner-downline-option': t.ownerDownlineOption,
                'downline-name-label': t.downlineNameLabel, 'downline-filter-label': t.downlineFilterLabel,
                
                'guide-main-title': t.guideMainTitle, 'guide-getting-started-title': t.guideGettingStartedTitle, 'guide-getting-started-p1': t.guideGettingStartedP1,
                'guide-getting-started-p2': t.guideGettingStartedP2, 'guide-getting-started-li1': t.guideGettingStartedLi1, 'guide-getting-started-li2': t.guideGettingStartedLi2, 'guide-getting-started-li3': t.guideGettingStartedLi3,
                'guide-interface-title': t.guideInterfaceTitle, 'guide-interface-p1': t.guideInterfaceP1, 'guide-interface-li1': t.guideInterfaceLi1, 'guide-interface-li2': t.guideInterfaceLi2, 'guide-interface-li3': t.guideInterfaceLi3,
                'guide-dashboard-title': t.guideDashboardTitle, 'guide-dashboard-p1': t.guideDashboardP1, 'guide-dashboard-li1': t.guideDashboardLi1, 'guide-dashboard-li2': t.guideDashboardLi2, 'guide-dashboard-li3': t.guideDashboardLi3,
                'guide-calendar-title': t.guideCalendarTitle, 'guide-calendar-p1': t.guideCalendarP1, 'guide-calendar-p2': t.guideCalendarP2, 'legend-stp-guide': t.legendStp, 'legend-gms-guide': t.legendGms, 
                'guide-calendar-li1':t.guideCalendarLi1, 'guide-calendar-li2':t.guideCalendarLi2, 'guide-calendar-li3':t.guideCalendarLi3,
                'guide-prospects-title': t.guideProspectsTitle, 'guide-prospects-p1': t.guideProspectsP1, 'guide-prospects-li1': t.guideProspectsLi1,
                'guide-prospects-li2': t.guideProspectsLi2, 'guide-prospects-li3': t.guideProspectsLi3, 'guide-prospects-p2': t.guideProspectsP2,
                'guide-prospects-li4': t.guideProspectsLi4, 'guide-prospects-li5': t.guideProspectsLi5, 'guide-prospects-p3': t.guideProspectsP3,
                'guide-analytics-title': t.guideAnalyticsTitle, 'guide-analytics-p1': t.guideAnalyticsP1, 'guide-analytics-li1': t.guideAnalyticsLi1,
                'guide-analytics-p2': t.guideAnalyticsP2, 'guide-analytics-li2': t.guideAnalyticsLi2, 'guide-analytics-li3': t.guideAnalyticsLi3, 'guide-analytics-p3': t.guideAnalyticsP3,
                'guide-settings-title': t.guideSettingsTitle, 'guide-settings-p1': t.guideSettingsP1, 'guide-settings-li1': t.guideSettingsLi1,
                'guide-settings-p2': t.guideSettingsP2, 'guide-settings-p3': t.guideSettingsP3, 'guide-settings-li2': t.guideSettingsLi2,
                'analytics-trend-title': t.analyticsTrendTitle, 'copy-stp-btn': t.copyStpBtn, 'copy-gms-btn': t.copyGmsBtn, 'welcome-text': t.welcome,
                'recurringAvailabilityTitle': t.recurringAvailabilityTitle, 'recurringAvailabilityDesc': t.recurringAvailabilityDesc, 'save-recurring-btn': t.saveRecurringBtn
            };
            for (const id in elements) { 
                const el = document.getElementById(id);
                if (el) el.innerHTML = elements[id];
            }

            const statusFilter = document.getElementById('status-filter');
            const statuses = ['STP', 'GMS_Appointment', 'KIT_STP', 'KIT_GMS', 'Joined', 'Disqualified', 'Not_Joining'];
            let statusOptionsHtml = `<option value="all">${t.allStatuses}</option>`;
            statuses.forEach(status => {
                statusOptionsHtml += `<option value="${status}">${t[status]}</option>`;
            });
            statusFilter.innerHTML = statusOptionsHtml;

            document.getElementById('search-input').placeholder = t.searchPlaceholder;
            document.getElementById('tags').placeholder = t.tagsPlaceholder;
            const sortSelect = document.getElementById('sort-by');
            sortSelect.innerHTML = `<option value="newest">${t.sort.newest}</option><option value="name_az">${t.sort.name_az}</option><option value="name_za">${t.sort.name_za}</option><option value="status">${t.sort.status}</option>`;
            
            renderRecurringAvailabilityForm();
        }
        
        async function renderAll() { 
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            if (!user) return;

            const { data: prospectsData, error: prospectsError } = await supabase.from('prospects').select('*').eq('user_id', user.id);
            const { data: availabilityData, error: availabilityError } = await supabase.from('availability').select('*').eq('user_id', user.id);
            const { data: settingsData, error: settingsError } = await supabase.from('user_settings').select('*').eq('user_id', user.id).maybeSingle();

            prospects = (prospectsData || []).map(p => ({ ...p, tags: Array.isArray(p.tags) ? p.tags : [] }));
            
            availability = availabilityData ? availabilityData.reduce((acc, curr) => {
                acc[curr.date] = curr.time_slots;
                return acc;
            }, {}) : {};
            
            if(settingsData) {
                recurringAvailability = settingsData.recurring_availability || {};
            } else {
                recurringAvailability = {};
            }
            
            populateDownlineDatalist();
            renderDashboard(); 
            renderProspectList(); 
            renderCalendar(); 
            if (document.getElementById('analytics').classList.contains('active')) {
                populateDownlineFilter();
                renderAnalytics();
            }
            renderAvailableSlotsSidebar(); 
            renderToggles(); 
            renderDataStatus();
            renderRecurringAvailabilityForm();
        }
        
        const prospectModal = document.getElementById('prospect-modal'); 
        const actionModal = document.getElementById('action-modal');
        const plannerModal = document.getElementById('planner-modal');
        const availabilityModal = document.getElementById('availability-modal');
        const showAvailabilityFab = document.getElementById('show-availability-fab');

        document.getElementById('add-prospect-btn').onclick = () => { 
            document.getElementById('prospect-form').reset(); 
            stpPicker.clear(); 
            document.getElementById('prospect-id').value = ''; 
            document.getElementById('modal-title').textContent = translations[currentLang].modalTitleAdd; 
            document.getElementById('downline-name-group').style.display = 'none';
            renderAvailableSlotsForPicker('stp');
            prospectModal.style.display = 'flex'; 
        };
        document.getElementById('close-modal').onclick = () => prospectModal.style.display = 'none';
        document.getElementById('action-close-modal').onclick = () => actionModal.style.display = 'none';
        document.getElementById('close-planner-modal').onclick = () => plannerModal.style.display = 'none';
        document.getElementById('close-availability-modal').onclick = () => availabilityModal.style.display = 'none';
        showAvailabilityFab.onclick = () => availabilityModal.style.display = 'flex';
                
        window.addEventListener('click', (e) => {
            if (!e.target.closest('.card-menu-container')) {
                document.querySelectorAll('.card-menu.open').forEach(menu => menu.classList.remove('open'));
            }
            if (e.target == prospectModal) prospectModal.style.display = 'none'; 
            if (e.target == actionModal) actionModal.style.display = 'none'; 
            if (e.target == plannerModal) plannerModal.style.display = 'none';
            if (e.target == availabilityModal) availabilityModal.style.display = 'none';
            if (e.target == forgotPasswordModal) forgotPasswordModal.style.display = 'none';
        });
        
        document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab).classList.add('active'); if(button.dataset.tab === 'analytics') { populateDownlineFilter(); renderAnalytics(); } }); });
        
        document.getElementById('owner-type').addEventListener('change', (e) => {
            document.getElementById('downline-name-group').style.display = e.target.value === 'downline' ? 'block' : 'none';
        });

        document.getElementById('prospect-form').addEventListener('submit', async (e) => {
            e.preventDefault(); 
            const id = document.getElementById('prospect-id').value;
            const stpTimeValue = document.getElementById('stp-datetime').value;
            if (!stpTimeValue) { alert('Please select an STP time.'); return; }

            const now = new Date();
            const chosen = new Date(stpTimeValue);
            if (isNaN(chosen.getTime()) || chosen <= now) {
                alert(currentLang === 'zh-CN' ? '不能选择过去的时间。' : 'You can’t choose a past date/time.');
                return;
            }

            const stpTime = new Date(stpTimeValue).toISOString();

            const ownerType = document.getElementById('owner-type').value;
            const downlineName = document.getElementById('downline-name').value.trim();

            if (ownerType === 'downline' && !downlineName) {
                alert(translations[currentLang].errorDownlineNameRequired);
                return;
            }
            if (isTimeSlotBooked(stpTimeValue, id)) {
                alert(translations[currentLang].errorDoubleBooking);
                return;
            }

            const tags = document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            const newNote = document.getElementById('notes').value;
            
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());

            let prospectData = {
                name: document.getElementById('name').value,
                phone: document.getElementById('phone').value,
                age: document.getElementById('age').value || null,
                occupation: document.getElementById('occupation').value,
                tags: tags,
                stp_time: stpTime,
                owner_type: ownerType,
                downline_name: downlineName,
                user_id: user.id
            };

            if (id) { // Edit
                const originalProspect = prospects.find(p => String(p.id) === id);
                if (!originalProspect) {
                    console.error("Prospect not found for editing");
                    return;
                }

                const updatedNotes = originalProspect.notes || [];
                if (newNote) {
                    updatedNotes.push({ date: new Date().toISOString(), content: `[EDIT] ${newNote}` });
                }
                prospectData.notes = updatedNotes;
                
                // Retain automatic tags (dedupe + handle missing tags)
                const baseTags = Array.isArray(tags) ? tags : [];
                prospectData.tags = Array.from(new Set([ ...baseTags, ...getAutomaticTags(originalProspect) ]));



                const { error } = await supabase.from('prospects').update(prospectData).eq('id', id);

                if (error) {
                    console.error('Error updating prospect:', error);
                } else {
                    if (originalProspect.stp_time !== stpTime) {
                        await addBackAvailabilityToDB(originalProspect.stp_time);
                        await removeBookedSlotFromDB(stpTimeValue);
                    }
                }
            } else { // New
                prospectData.notes = newNote ? [{ date: new Date().toISOString(), content: newNote }] : [];
                prospectData.status = 'STP';
                prospectData.kit_counter = 0;
                prospectData.status_history = [{ status: 'STP', date: new Date().toISOString() }];
                const { error } = await supabase.from('prospects').insert([prospectData]);
                if (error) {
                    console.error('Error creating prospect:', error);
                } else {
                    await removeBookedSlotFromDB(stpTimeValue);
                }
            }
            
            await renderAll(); // Refresh UI
            prospectModal.style.display = 'none';
        });

        document.getElementById('action-form').addEventListener('submit', async (e) => { 
            e.preventDefault(); 
            const id = document.getElementById('action-prospect-id').value; 
            const action = document.getElementById('action-type').value; 
            const p = prospects.find(prospect => String(prospect.id) === id); 
            if (!p) return;
            
            const notes = document.getElementById('action-notes').value; 
            const updatedNotes = p.notes || [];
            if(notes) {
                updatedNotes.push({ date: new Date().toISOString(), content: `[${action}] ${notes}` });
            }
            
            const updatedStatusHistory = p.status_history || [];
            const gmsTimeValue = document.getElementById('gms-datetime').value;

            if (action === 'schedule_gms' || action === 'edit_gms') {
                const newGmsTime = new Date(gmsTimeValue);
                const stpTime = new Date(p.stp_time);
                if (newGmsTime <= stpTime) {
                    alert(translations[currentLang].errorGmsAfterStp);
                    return; 
                }
                if (isTimeSlotBooked(gmsTimeValue, p.id)) {
                    alert(translations[currentLang].errorDoubleBooking);
                    return; 
                }
            }
            
            let confirmAction = true;
            if (action === 'joined') confirmAction = confirm(translations[currentLang].confirmJoin);
            if (action === 'disqualify') confirmAction = confirm(translations[currentLang].confirmDisqualify);
            if (action === 'not_joining') confirmAction = confirm(translations[currentLang].confirmNotJoining);
            if (!confirmAction) return;
            
            let updateData = { notes: updatedNotes, tags: p.tags || [] };

            const newKitCounter = (p.kit_counter || 0) + (action === 'follow_up' || action.startsWith('kit_') ? 1 : 0);
            
            // Remove old KIT tag if it exists
            updateData.tags = updateData.tags.filter(tag => !tag.startsWith('KIT:'));

            switch(action) {
                case 'schedule_gms': 
                    Object.assign(updateData, { status: 'GMS_Appointment', gms_time: new Date(gmsTimeValue).toISOString(), kit_counter: 0 });
                    updatedStatusHistory.push({ status: 'GMS_Appointment', date: new Date().toISOString() });
                    await removeBookedSlotFromDB(gmsTimeValue);
                    break;
                case 'edit_gms':
                    Object.assign(updateData, { gms_time: new Date(gmsTimeValue).toISOString() });
                    updatedStatusHistory.push({ status: 'GMS_Rescheduled', date: new Date().toISOString() });
                    if(p.gms_time !== updateData.gms_time) {
                        await addBackAvailabilityToDB(p.gms_time);
                        await removeBookedSlotFromDB(gmsTimeValue);
                    }
                    break;
                case 'kit_stp': 
                    Object.assign(updateData, { status: 'KIT_STP', kit_counter: newKitCounter });
                    updatedStatusHistory.push({ status: 'KIT_STP', date: new Date().toISOString() });
                    updateData.tags.push(`KIT: ${newKitCounter}`);
                    break;
                case 'kit_gms': 
                    Object.assign(updateData, { status: 'KIT_GMS', kit_counter: newKitCounter });
                    updatedStatusHistory.push({ status: 'KIT_GMS', date: new Date().toISOString() });
                    updateData.tags.push(`KIT: ${newKitCounter}`);
                    break;
                case 'disqualify': 
                    Object.assign(updateData, { status: 'Disqualified' });
                    updatedStatusHistory.push({ status: 'Disqualified', date: new Date().toISOString() });
                    break;
                case 'not_joining': 
                    Object.assign(updateData, { status: 'Not_Joining' });
                    updatedStatusHistory.push({ status: 'Not_Joining', date: new Date().toISOString() });
                    break;
                case 'joined': 
                    Object.assign(updateData, { status: 'Joined' });
                    updatedStatusHistory.push({ status: 'Joined', date: new Date().toISOString() });
                    break;
                case 'follow_up': 
                    Object.assign(updateData, { kit_counter: newKitCounter });
                    updatedStatusHistory.push({ status: 'Follow_Up', date: new Date().toISOString() });
                    updateData.tags.push(`KIT: ${newKitCounter}`);
                    break;
            }
            updateData.status_history = updatedStatusHistory;
            updateData.tags = Array.from(new Set(updateData.tags || []));

            const { error } = await supabase.from('prospects').update(updateData).eq('id', id);
            if (error) console.error('Error updating prospect status:', error);
            
            await renderAll(); // Refresh UI
            actionModal.style.display = 'none';
        });

        function openActionModal(id, action) {
            const p = prospects.find(prospect => String(prospect.id) === id);
            if(!p) return;

            document.getElementById('action-form').reset(); 
            gmsPicker.clear(); 
            document.getElementById('action-prospect-id').value = id; 
            document.getElementById('action-type').value = action; 
            
            const gmsGroup = document.getElementById('gms-schedule-group'); 
            gmsGroup.style.display = (action === 'schedule_gms' || action === 'edit_gms') ? 'block' : 'none'; 
            document.getElementById('gms-datetime').required = (action === 'schedule_gms' || action === 'edit_gms');
            
            if (action === 'schedule_gms' || action === 'edit_gms') {
                renderAvailableSlotsForPicker('gms');
            }
            
            if (action === 'edit_gms' && p.gms_time) {
                gmsPicker.setDate(new Date(p.gms_time), true);
            }
            actionModal.style.display = 'flex';
        }

        function getAutomaticTags(prospect) {
            if (!prospect) return [];
            return (prospect.tags || []).filter(tag => tag.startsWith('KIT:'));
        }
        
        function openEditModal(prospectId) {
            const p = prospects.find(p => String(p.id) === prospectId);
            if (!p) return;
            
            document.getElementById('prospect-form').reset();
            document.getElementById('modal-title').textContent = translations[currentLang].modalTitleEdit;
            document.getElementById('prospect-id').value = p.id; 
            document.getElementById('name').value = p.name;
            document.getElementById('phone').value = p.phone; 
            document.getElementById('age').value = p.age;
            document.getElementById('occupation').value = p.occupation; 
            document.getElementById('tags').value = p.tags ? p.tags.filter(t => !t.startsWith('KIT:')).join(', ') : '';
            document.getElementById('owner-type').value = p.owner_type || 'user';
            
            const downlineGroup = document.getElementById('downline-name-group');
            if (p.owner_type === 'downline') {
                downlineGroup.style.display = 'block';
                document.getElementById('downline-name').value = p.downline_name;
            } else {
                downlineGroup.style.display = 'none';
            }
            stpPicker.setDate(new Date(p.stp_time), true); 
            renderAvailableSlotsForPicker('stp');
            document.getElementById('notes').value = ''; 
            prospectModal.style.display = 'flex';
        }

        async function deleteProspect(prospectId) {
            if (confirm(translations[currentLang].confirmDelete)) {
                const prospectToDelete = prospects.find(p => String(p.id) === prospectId);
                const { error } = await supabase.from('prospects').delete().eq('id', prospectId);

                if (error) {
                    console.error('Error deleting prospect:', error);
                } else {
                    if (prospectToDelete) {
                        await addBackAvailabilityToDB(prospectToDelete.stp_time);
                        await addBackAvailabilityToDB(prospectToDelete.gms_time);
                    }
                    await renderAll(); // Refresh UI
                }
            }
        }

        function formatChineseTime(date) {
            const hour = date.getHours();
            const minute = String(date.getMinutes()).padStart(2, '0');
            let period = '';
            const t = translations['zh-CN'];

            if (hour >= 0 && hour < 5) period = t.guidePeriodLingchen;
            else if (hour >= 5 && hour < 12) period = t.guidePeriodZaoshang;
            else if (hour === 12) period = t.guidePeriodZhongwu;
            else if (hour > 12 && hour < 18) period = t.guidePeriodXiawu;
            else if (hour === 18) period = t.guidePeriodBangwan;
            else period = t.guidePeriodWanshang;
            
            let displayHour = hour % 12;
            if (displayHour === 0) displayHour = 12; 
            
            return `${period} ${displayHour}:${minute}`;
        }

        function formatDate(dateString) { 
            if (!dateString) return 'N/A'; 
            const date = new Date(dateString);

            if (isNaN(date.getTime())) {
                return "N/A";
            }
            if (currentLang === 'zh-CN') {
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${year}年${month}月${day}日 ${formatChineseTime(date)}`;
            }
            return date.toLocaleString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', hour12: true }); 
        }
        
        function isTimeSlotBooked(dateTimeString, prospectIdToExclude = null) {
            if (!dateTimeString) return false;
            const newApptTime = new Date(dateTimeString).getTime();
            const thirtyMinutes = 30 * 60 * 1000;
            return prospects.some(p => {
                if (String(p.id) === prospectIdToExclude) return false;
                
                const stpTime = p.stp_time ? new Date(p.stp_time).getTime() : 0;
                if (stpTime && Math.abs(newApptTime - stpTime) < thirtyMinutes) return true;
                
                const gmsTime = p.gms_time ? new Date(p.gms_time).getTime() : 0;
                if (gmsTime && Math.abs(newApptTime - gmsTime) < thirtyMinutes) return true;
                
                return false;
            });
        }

        function renderDashboard() {
            const appointmentsGrid = document.getElementById('appointments-grid'); 
            const followUpsGrid = document.getElementById('follow-ups-grid');
            appointmentsGrid.innerHTML = ''; 
            followUpsGrid.innerHTML = ''; 
            const now = new Date(); 
            let upcoming = [];
            prospects.forEach(p => {
                if (p.status === 'STP' && p.stp_time && new Date(p.stp_time) > now) {
                    upcoming.push({ p, type: 'STP', date: new Date(p.stp_time) });
                } else if (p.status === 'GMS_Appointment' && p.gms_time && new Date(p.gms_time) > now) {
                    upcoming.push({ p, type: 'GMS', date: new Date(p.gms_time) });
                }
            });
            upcoming.sort((a, b) => a.date - b.date);
            if (upcoming.length === 0) {
                appointmentsGrid.innerHTML = `<p>${translations[currentLang].noAppointmentsText}</p>`;
            } else {
                upcoming.forEach(item => { 
                    const card = document.createElement('div'); 
                    card.className = 'appointment-card'; 
                    let downlineHtml = item.p.owner_type === 'downline' ? `<div class="downline-info">👤 ${item.p.downline_name}</div>` : '';
                    card.innerHTML = `<h3>${item.p.name}</h3><p><strong>${item.type}:</strong> ${formatDate(item.date)}</p>${downlineHtml}`; 
                    appointmentsGrid.appendChild(card); 
                });
            }
            
            const followUps = prospects.filter(p => p.status && p.status.startsWith('KIT_'));
            if (followUps.length === 0) {
                followUpsGrid.innerHTML = `<p>${translations[currentLang].noFollowUpsText}</p>`;
            } else {
                followUps.forEach(p => {
                    const card = document.createElement('div'); 
                    card.className = 'reminder-card';
                    let downlineHtml = p.owner_type === 'downline' ? `<div class="downline-info">👤 ${p.downline_name}</div>` : '';
                    card.innerHTML = `<h3>${p.name}</h3><p><strong>${translations[currentLang].status}:</strong> ${translations[currentLang][p.status]}</p><p><strong>${translations[currentLang].kitCounter}:</strong> ${p.kit_counter || 0}</p>${downlineHtml}
                    <div class="prospect-actions"><button class="btn-primary" data-id="${p.id}" data-action="${p.status === 'KIT_STP' ? 'schedule_gms' : 'joined'}">${p.status === 'KIT_STP' ? translations[currentLang].actionScheduleGMS : translations[currentLang].actionJoined}</button>
                    <button class="btn-warning" data-id="${p.id}" data-action="follow_up">${translations[currentLang].actionFollowUp}</button></div>`;
                    followUpsGrid.appendChild(card);
                });
            }
            followUpsGrid.querySelectorAll('.prospect-actions button').forEach(button => button.addEventListener('click', (e) => openActionModal(e.target.dataset.id, e.target.dataset.action)));
        }
        
        document.getElementById('copy-stp-btn').addEventListener('click', () => copyAppointmentsToClipboard('STP'));
        document.getElementById('copy-gms-btn').addEventListener('click', () => copyAppointmentsToClipboard('GMS'));

        function copyAppointmentsToClipboard(type) {
            const now = new Date();
            let upcoming = [];
            prospects.forEach(p => {
                if (p.stp_time && new Date(p.stp_time) > now) upcoming.push({ p, type: 'STP', date: new Date(p.stp_time) });
                if (p.gms_time && new Date(p.gms_time) > now) upcoming.push({ p, type: 'GMS', date: new Date(p.gms_time) });
            });

            const appointmentsToCopy = upcoming
                .filter(item => item.type === type)
                .sort((a, b) => a.date - b.date); // ascending by datetime

            if (appointmentsToCopy.length === 0) return;

            const dayNames = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];

            let textToCopy = type === 'STP' ? 'STP资料\n' : 'GMS资料\n';
            appointmentsToCopy.forEach((item, index) => {
                const d = item.date;
                const formattedDate = `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()} ${dayNames[d.getDay()]} ${d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })}`;
                if(type === 'STP') {
                    textToCopy += `\n(${index+1})\n`;
                    textToCopy += `名字：${item.p.name}\n`;
                    textToCopy += `职业（工作/读书）：${item.p.occupation || ''}\n`;
                    textToCopy += `年龄：${item.p.age || ''}\n`;
                    textToCopy += `邀约时间：${formattedDate}\n`;
                } else { // GMS
                    textToCopy += `\n(${index+1})\n`;
                    textToCopy += `名字 ：${item.p.name}\n`;
                    textToCopy += `号码 ：${item.p.phone || ''}\n`;
                    textToCopy += `年龄 ：${item.p.age || ''}\n`;
                    const lastNote = item.p.notes && item.p.notes.length > 0 ? item.p.notes[item.p.notes.length - 1].content : '';
                    textToCopy += `加入/不加入：${lastNote}\n`;
                    textToCopy += `邀约时间 ：${formattedDate}\n`;
                }
            });
            
            navigator.clipboard.writeText(textToCopy.trim()).then(() => {
                const btn = document.getElementById(`copy-${type.toLowerCase()}-btn`);
                const originalText = btn.textContent;
                btn.textContent = translations[currentLang].copied;
                setTimeout(() => { btn.textContent = originalText; setLanguage(currentLang); }, 2000);
            });
        }

        function renderPagination(totalProspects) {
            const paginationControls = document.getElementById('pagination-controls');
            paginationControls.innerHTML = '';
            const totalPages = Math.ceil(totalProspects / PROSPECTS_PER_PAGE);

            if (totalPages <= 1) return;

            let paginationHTML = `<button class="page-btn" id="prev-page" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
            for (let i = 1; i <= totalPages; i++) {
                paginationHTML += `<button class="page-btn ${i === currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`;
            }
            paginationHTML += `<button class="page-btn" id="next-page" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
            paginationControls.innerHTML = paginationHTML;

            document.querySelectorAll('.page-btn[data-page]').forEach(button => {
                button.onclick = () => {
                    currentPage = Number(button.dataset.page);
                    renderProspectList();
                };
            });
            document.getElementById('prev-page')?.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderProspectList();
                }
            });
            document.getElementById('next-page')?.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderProspectList();
                }
            });
        }

        function renderProspectList() {
            const listDiv = document.getElementById('prospect-list');
            listDiv.innerHTML = '';

            const searchQuery = document.getElementById('search-input').value.toLowerCase();
            const statusFilter = document.getElementById('status-filter').value;
            const sortBy = document.getElementById('sort-by').value;
            let prospectsToDisplay = prospects;

            if (prospectViewFilter === 'user') {
                prospectsToDisplay = prospects.filter(p => p.owner_type !== 'downline');
            } else if (prospectViewFilter === 'downline') {
                prospectsToDisplay = prospects.filter(p => p.owner_type === 'downline');
            }

            let filtered = prospectsToDisplay.filter(p => {
                const pStatus = p.status || 'STP';
                const matchesSearch = p.name.toLowerCase().includes(searchQuery) || (p.phone && p.phone.includes(searchQuery)) || (p.tags && p.tags.some(tag => tag.toLowerCase().includes(searchQuery)));
                const matchesStatus = (statusFilter === 'all' || pStatus === statusFilter);
                return matchesSearch && matchesStatus;
            });

            filtered.sort((a, b) => { switch (sortBy) { case 'name_az': return a.name.localeCompare(b.name); case 'name_za': return b.name.localeCompare(a.name); case 'status': return (a.status || 'STP').localeCompare(b.status || 'STP'); case 'newest': default: return new Date(b.stp_time) - new Date(a.stp_time); } });

            const startIndex = (currentPage - 1) * PROSPECTS_PER_PAGE;
            const endIndex = startIndex + PROSPECTS_PER_PAGE;
            const paginatedProspects = filtered.slice(startIndex, endIndex);

            if (paginatedProspects.length === 0) {
                listDiv.innerHTML = `<p>${translations[currentLang].noFollowUpsText}</p>`;
                renderPagination(0);
                return;
            }

            paginatedProspects.forEach(p => {
                const pStatus = p.status || 'STP';
                const card = document.createElement('div'); card.className = 'prospect-card'; const statusText = translations[currentLang][pStatus] || pStatus;
                let kitInfo = pStatus.startsWith('KIT_') ? ` (${translations[currentLang].kitCounter}: ${p.kit_counter || 0})` : '';
                let tagsHtml = p.tags && p.tags.length ? `<div class="tags-container">${p.tags.map(tag => {
                    const kitMatch = tag.match(/^KIT: (\d+)$/);
                    let style = '';
                    if(kitMatch) {
                        style = `background-color: var(--warning-color); color: var(--text-color);`;
                    }
                    return `<span class="tag-badge" style="${style}">${tag}</span>`
                }).join('')}</div>` : '';
                let notesHtml = p.notes && p.notes.map(note => `<small>${formatDate(note.date)}: ${note.content}</small>`).join('<br>') || '';
                let downlineHtml = p.owner_type === 'downline' ? `<div class="downline-info">👤 ${translations[currentLang].downlineInfo}${p.downline_name}</div>` : '';
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${p.name} <span class="status-badge status-${pStatus}">${statusText}${kitInfo}</span></h3>
                        <div class="card-menu-container">
                            <button class="menu-toggle-btn" data-id="${p.id}">&#8942;</button>
                            <div class="card-menu" id="menu-${p.id}">
                                <a href="#" class="menu-item" data-action="edit" data-id="${p.id}">${translations[currentLang].buttonEdit}</a>
                                <a href="#" class="menu-item menu-item-danger" data-action="delete" data-id="${p.id}">${translations[currentLang].buttonDelete}</a>
                            </div>
                        </div>
                    </div>
                    ${downlineHtml}
                    ${tagsHtml}
                    <p class="prospect-meta">
                        <span><strong>${translations[currentLang].phone}:</strong> ${p.phone||'N/A'}</span><span class="separator">|</span>
                        <span><strong>${translations[currentLang].age}:</strong> ${p.age||'N/A'}</span><span class="separator">|</span>
                        <span><strong>${translations[currentLang].occupation}:</strong> ${p.occupation||'N/A'}</span>
                    </p>
                    <p class="prospect-meta">
                        <span><strong>${translations[currentLang].stp_time}:</strong> ${formatDate(p.stp_time)}</span><span class="separator">|</span>
                        <span><strong>GMS:</strong> ${formatDate(p.gms_time)}</span>
                    </p>
                    <div><strong>${translations[currentLang].notes}:</strong><br>${notesHtml}</div>
                    <div class="prospect-actions"></div>`;
                const actionsDiv = card.querySelector('.prospect-actions');
                if (pStatus === 'STP') { actionsDiv.innerHTML += `<button class="btn-primary" data-action="schedule_gms" data-id="${p.id}">${translations[currentLang].actionScheduleGMS}</button><button class="btn-secondary" data-action="kit_stp" data-id="${p.id}">${translations[currentLang].actionKeepInTouch}</button><button class="btn-danger" data-action="disqualify" data-id="${p.id}">${translations[currentLang].actionDisqualify}</button>`;
                } else if (pStatus === 'KIT_STP') { actionsDiv.innerHTML += `<button class="btn-primary" data-action="schedule_gms" data-id="${p.id}">${translations[currentLang].actionScheduleGMS}</button><button class="btn-warning" data-action="follow_up" data-id="${p.id}">${translations[currentLang].actionFollowUp} (${p.kit_counter || 0})</button><button class="btn-danger" data-action="disqualify" data-id="${p.id}">${translations[currentLang].actionDisqualify}</button>`;
                } else if (pStatus === 'GMS_Appointment') { actionsDiv.innerHTML += `<button class="btn-success" data-action="joined" data-id="${p.id}">${translations[currentLang].actionJoined}</button><button class="btn-primary" data-action="edit_gms" data-id="${p.id}">${translations[currentLang].actionEditGMS}</button><button class="btn-secondary" data-action="kit_gms" data-id="${p.id}">${translations[currentLang].actionKeepInTouch}</button><button class="btn-danger" data-action="not_joining" data-id="${p.id}">${translations[currentLang].actionNotJoining}</button>`;
                } else if (pStatus === 'KIT_GMS') { actionsDiv.innerHTML += `<button class="btn-success" data-action="joined" data-id="${p.id}">${translations[currentLang].actionJoined}</button><button class="btn-warning" data-action="follow_up" data-id="${p.id}">${translations[currentLang].actionFollowUp} (${p.kit_counter || 0})</button><button class="btn-danger" data-action="not_joining" data-id="${p.id}">${translations[currentLang].actionNotJoining}</button>`; }
                listDiv.appendChild(card);
            });

            renderPagination(filtered.length);
        }
        
        document.getElementById('prospect-list').addEventListener('click', (e) => {
            const menuToggle = e.target.closest('.menu-toggle-btn');
            if (menuToggle) {
                e.stopPropagation();
                const prospectId = menuToggle.dataset.id;
                const menu = document.getElementById(`menu-${prospectId}`);
                const isMenuOpen = menu.classList.contains('open');
                document.querySelectorAll('.card-menu.open').forEach(m => m.classList.remove('open'));
                if (!isMenuOpen) menu.classList.add('open');
                return;
            }
            const menuItem = e.target.closest('.menu-item');
            if (menuItem) {
                e.preventDefault();
                const prospectId = menuItem.dataset.id;
                const action = menuItem.dataset.action;
                if (action === 'edit') openEditModal(prospectId);
                if (action === 'delete') deleteProspect(prospectId);
                menuItem.closest('.card-menu').classList.remove('open');
                return;
            }
            const actionButton = e.target.closest('.prospect-actions button');
            if (actionButton) {
                openActionModal(actionButton.dataset.id, actionButton.dataset.action);
            }
        });
        
        document.getElementById('search-input').addEventListener('input', () => { currentPage = 1; renderProspectList(); }); 
        document.getElementById('sort-by').addEventListener('change', () => { currentPage = 1; renderProspectList(); });
        document.getElementById('status-filter').addEventListener('change', () => { currentPage = 1; renderProspectList(); });
        document.getElementById('prospect-view-toggle').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                currentPage = 1;
                prospectViewFilter = e.target.dataset.filter;
                renderProspectList();
                renderToggles();
            }
        });

        function renderAnalytics() {
            const monthInput = document.getElementById('analytics-month');
            const selectedMonth = monthInput.value;
            if (!selectedMonth) return;
            const [year, month] = selectedMonth.split('-').map(Number);
            
            let prospectsToAnalyze = prospects;
            if (analyticsView === 'user') {
                prospectsToAnalyze = prospects.filter(p => p.owner_type !== 'downline');
            } else {
                const selectedDownline = document.getElementById('downline-filter').value;
                prospectsToAnalyze = prospects.filter(p => p.owner_type === 'downline' && (selectedDownline === 'all' || p.downline_name === selectedDownline));
            }

            let newStps = 0, newGms = 0, newJoins = 0, newDisqualified = 0;

            prospectsToAnalyze.forEach(p => {
                const history = p.status_history || [];
                
                const firstStpInMonth = history.find(h => {
                    const historyDate = new Date(h.date);
                    return h.status === 'STP' && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                });
                if (firstStpInMonth) newStps++;

                const firstGmsInMonth = history.find(h => {
                    const historyDate = new Date(h.date);
                    return h.status === 'GMS_Appointment' && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                });
                if (firstGmsInMonth) newGms++;

                const firstJoinInMonth = history.find(h => {
                    const historyDate = new Date(h.date);
                    return h.status === 'Joined' && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                });
                if (firstJoinInMonth) newJoins++;
                
                const firstDisqualifiedInMonth = history.find(h => {
                    const historyDate = new Date(h.date);
                    return (h.status === 'Disqualified' || h.status === 'Not_Joining') && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                });
                if(firstDisqualifiedInMonth) newDisqualified++;
            });

            const summaryDiv = document.getElementById('analytics-summary');
            const t = translations[currentLang].analytics;
            summaryDiv.innerHTML = `<div class="analytics-card"><h4>${t.new_stps}</h4><div class="value">${newStps}</div></div><div class="analytics-card"><h4>${t.new_gms}</h4><div class="value">${newGms}</div></div>
                                    <div class="analytics-card"><h4>${t.new_joins}</h4><div class="value">${newJoins}</div></div><div class="analytics-card"><h4>${t.new_disqualified}</h4><div class="value">${newDisqualified}</div></div>`;
            
            renderTrendChart(prospectsToAnalyze);
        }
        
        function getMonthlyTrendData(prospectsToAnalyze) {
            const data = { labels: [], datasets: { stps: [], gms: [], joins: [], disqualified: [] } };
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const year = d.getFullYear();
                const month = d.getMonth() + 1;
                const monthName = d.toLocaleString(currentLang === 'zh-CN' ? 'zh-CN' : 'en-US', { month: 'short' });
                data.labels.push(monthName);

                let stps = 0, gms = 0, joins = 0, disqualified = 0;

                prospectsToAnalyze.forEach(p => {
                    const history = p.status_history || [];
                    
                    const firstStpInMonth = history.find(h => {
                        const historyDate = new Date(h.date);
                        return h.status === 'STP' && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                    });
                    if (firstStpInMonth) stps++;

                    const firstGmsInMonth = history.find(h => {
                        const historyDate = new Date(h.date);
                        return h.status === 'GMS_Appointment' && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                    });
                    if (firstGmsInMonth) gms++;

                    const firstJoinInMonth = history.find(h => {
                        const historyDate = new Date(h.date);
                        return h.status === 'Joined' && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                    });
                    if (firstJoinInMonth) joins++;
                    
                    const firstDisqualifiedInMonth = history.find(h => {
                        const historyDate = new Date(h.date);
                        return (h.status === 'Disqualified' || h.status === 'Not_Joining') && historyDate.getFullYear() === year && historyDate.getMonth() + 1 === month;
                    });
                    if (firstDisqualifiedInMonth) disqualified++;
                });
                data.datasets.stps.push(stps);
                data.datasets.gms.push(gms);
                data.datasets.joins.push(joins);
                data.datasets.disqualified.push(disqualified);
            }
            return data;
        }

        function renderTrendChart(prospectsToAnalyze) {
            const ctx = document.getElementById('analyticsTrendChart').getContext('2d');
            const trendData = getMonthlyTrendData(prospectsToAnalyze);
            const t = translations[currentLang].analytics;
            if (trendChartInstance) {
                trendChartInstance.destroy();
            }
            
            const isMobile = window.innerWidth <= 768;
            
            trendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.labels,
                    datasets: [
                        { label: t.new_stps, data: trendData.datasets.stps, borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.1)', fill: true, tension: 0.4 },
                        { label: t.new_gms, data: trendData.datasets.gms, borderColor: 'rgba(249, 115, 22, 1)', backgroundColor: 'rgba(249, 115, 22, 0.1)', fill: true, tension: 0.4 },
                        { label: t.new_joins, data: trendData.datasets.joins, borderColor: 'rgba(16, 185, 129, 1)', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true, tension: 0.4 },
                        { label: t.new_disqualified, data: trendData.datasets.disqualified, borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.1)', fill: true, tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            ticks: { precision: 0, font: { size: isMobile ? 10 : 12 } } 
                        },
                        x: {
                            ticks: { font: { size: isMobile ? 10 : 12 } }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'top',
                            labels: { font: { size: isMobile ? 10 : 12 } }
                        },
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index',
                    }
                }
            });
        }

        function renderToggles() {
            const t = translations[currentLang];
            const prospectToggle = document.getElementById('prospect-view-toggle');
            prospectToggle.innerHTML = `
                <button class="${prospectViewFilter === 'user' ? 'active' : ''}" data-filter="user">${t.prospectViewToggleMine}</button>
                <button class="${prospectViewFilter === 'downline' ? 'active' : ''}" data-filter="downline">${t.prospectViewToggleDownlines}</button>
                <button class="${prospectViewFilter === 'all' ? 'active' : ''}" data-filter="all">${t.prospectViewToggleAll}</button>
            `;
            const analyticsToggle = document.getElementById('analytics-view-toggle');
            analyticsToggle.innerHTML = `
                <button class="${analyticsView === 'user' ? 'active' : ''}" data-view="user">${t.analyticsViewToggleMine}</button>
                <button class="${analyticsView === 'downline' ? 'active' : ''}" data-view="downline">${t.analyticsViewToggleDownlines}</button>
            `;
        }

        document.getElementById('analytics-view-toggle').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                analyticsView = e.target.dataset.view;
                document.getElementById('downline-analytics-controls').style.display = analyticsView === 'downline' ? 'block' : 'none';
                if (analyticsView === 'downline') {
                    populateDownlineFilter();
                }
                renderAnalytics();
                renderToggles();
            }
        });
        
        document.getElementById('downline-filter').addEventListener('change', renderAnalytics);

        function populateDownlineFilter() {
            const downlineNames = Array.from(new Set(
                prospects.filter(p => p.owner_type === 'downline' && p.downline_name).map(p => p.downline_name)
            ));
            const filterSelect = document.getElementById('downline-filter');
            const currentVal = filterSelect.value;
            filterSelect.innerHTML = `<option value="all">${translations[currentLang].allDownlinesOption}</option>`;
            downlineNames.sort().forEach(name => {
                filterSelect.innerHTML += `<option value="${name}">${name}</option>`;
            });
            filterSelect.value = downlineNames.includes(currentVal) ? currentVal : 'all';
        }

        function populateDownlineDatalist() {
            const downlineNames = Array.from(new Set(
                prospects.filter(p => p.owner_type === 'downline' && p.downline_name).map(p => p.downline_name)
            ));
            const datalist = document.getElementById('downline-names-list');
            datalist.innerHTML = '';
            downlineNames.sort().forEach(name => {
                datalist.innerHTML += `<option value="${name}"></option>`;
            });
        }

        document.getElementById('clearData')?.addEventListener('click', async () => {
  const getLang = () => (typeof currentLang !== 'undefined' ? currentLang : 'en');
  const t = (key, fallback) => {
    try {
      if (typeof translations !== 'undefined' && translations[getLang()] && translations[getLang()][key]) {
        return translations[getLang()][key];
      }
    } catch (_) {}
    return fallback;
  };

  if (!confirm(t('confirmClearData', getLang() === 'zh-CN' ? '确认要清除所有数据吗？' : 'Are you sure you want to clear all your data?'))) return;
  const typed = prompt(getLang() === 'zh-CN' ? '为确认，请输入：DELETE（英文大写）' : 'To confirm, type: DELETE');
  if (typed !== 'DELETE') return;

  const btn = document.getElementById('clearData');
  const originalLabel = btn ? btn.textContent : '';
  if (btn) { btn.disabled = true; btn.textContent = getLang() === 'zh-CN' ? '正在清除…' : 'Clearing…'; }

  try {
    const authGetter = (typeof supabaseReady !== 'undefined') ? (async () => { await supabaseReady; return supabase.auth.getUser(); }) : (() => supabase.auth.getUser());
    const { data: { user } } = await authGetter();
    if (!user) { alert(getLang() === 'zh-CN' ? '请先登录。' : 'Please log in first.'); return; }

    try {
      if (typeof prospects !== 'undefined') prospects = [];
      if (typeof availability !== 'undefined') availability = {};
      if (typeof recurringAvailability !== 'undefined') recurringAvailability = {};
      if (typeof renderAll === 'function') { renderAll().catch(() => {}); }
    } catch (_) {}

    const tasks = [
      supabase.from('reminders').delete().eq('user_id', user.id),
      supabase.from('push_subscriptions').delete().eq('user_id', user.id),
      supabase.from('prospects').delete().eq('user_id', user.id),
      supabase.from('availability').delete().eq('user_id', user.id),
      supabase.from('user_settings').delete().eq('user_id', user.id),
    ];

    const results = await Promise.allSettled(tasks);
    const failures = results.filter(r => r.status === 'rejected' || (r.value && r.value.error));

    if (failures.length) {
      console.error('Some items failed to delete:', failures);
      alert(getLang() === 'zh-CN' ? '部分数据未能删除，请查看控制台。' : 'Some items could not be deleted. See console for details.');
    } else {
      alert(t('dataCleared', getLang() === 'zh-CN' ? '已清除你的所有数据。' : 'All your data has been cleared.'));
    }

    if (typeof renderAll === 'function') await renderAll();
  } catch (err) {
    console.error('Clear data failed:', err);
    alert(getLang() === 'zh-CN' ? '清除失败，请稍后重试。' : 'Failed to clear data. Please try again.');
  } finally {
    if (btn) { btn.disabled = false; btn.textContent = originalLabel; }
  }
});
        
        document.getElementById('exportData').addEventListener('click', () => {
            if (prospects.length === 0 && Object.keys(availability).length === 0) return alert('No data to export.');
            const timestamp = new Date();
            const dataToExport = {
                prospects: prospects,
                availability: availability,
                recurringAvailability: recurringAvailability,
                timestamp: timestamp.toISOString()
            };
            const dataStr = JSON.stringify(dataToExport, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            const date = `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')}`;
            const time = `${String(timestamp.getHours()).padStart(2, '0')}-${String(timestamp.getMinutes()).padStart(2, '0')}`;
            link.download = `AmwayTracker_Backup_${date}_${time}.json`;
            link.href = url;
            link.click();
            URL.revokeObjectURL(url);
        });

        document.getElementById('importData').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data && data.prospects && data.availability) {
                        if (confirm(translations[currentLang].importConfirm)) {
                            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
                            if(!user) return;

                            await supabase.from('prospects').delete().eq('user_id', user.id);
                            await supabase.from('availability').delete().eq('user_id', user.id);
                            
                            const prospectsToInsert = data.prospects.map(p => ({ ...p, user_id: user.id, id: undefined })); // Ensure DB generates new IDs
                            const availabilityToInsert = Object.keys(data.availability).map(date => ({ date, time_slots: data.availability[date], user_id: user.id }));

                            if(prospectsToInsert.length > 0) await supabase.from('prospects').insert(prospectsToInsert);
                            if(availabilityToInsert.length > 0) await supabase.from('availability').insert(availabilityToInsert);
                            
                            const settingsPayload = {
                                user_id: user.id,
                                recurring_availability: data.recurringAvailability || {}
                            };
                            await supabase.from('user_settings').upsert(settingsPayload, { onConflict: 'user_id' });

                            await renderAll(); // Refresh UI
                            alert(translations[currentLang].importSuccess);
                        }
                    } else {
                        alert(translations[currentLang].importError);
                    }
                } catch (error) {
                    console.error("Import error:", error);
                    alert(translations[currentLang].importError);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        });

        function renderDataStatus() {
            document.getElementById('total-prospects').textContent = prospects.length;
            const syncTimeEl = document.getElementById('last-sync-time');
            if (lastSyncTimestamp) {
                syncTimeEl.textContent = formatDate(lastSyncTimestamp);
            } else {
                syncTimeEl.textContent = "Never";
            }
        }
        
        document.getElementById('prev-month').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() - 1); renderCalendar(); });
        document.getElementById('next-month').addEventListener('click', () => { calendarDate.setMonth(calendarDate.getMonth() + 1); renderCalendar(); });
        function renderCalendar() {
            const gridBody = document.getElementById('calendar-grid-body'); const gridHeader = document.getElementById('calendar-grid-header');
            gridBody.innerHTML = ''; gridHeader.innerHTML = ''; const month = calendarDate.getMonth(); const year = calendarDate.getFullYear();
            document.getElementById('current-month-year').textContent = new Date(year, month).toLocaleString(currentLang === 'zh-CN' ? 'zh-Hans-CN' : 'en-US', { month: 'long', year: 'numeric' });
            translations[currentLang].dayNames.forEach(day => { const dayEl = document.createElement('div'); dayEl.className = 'calendar-day-header'; dayEl.textContent = day; gridHeader.appendChild(dayEl); });
            const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            for (let i = 0; i < firstDay; i++) { const emptyCell = document.createElement('div'); emptyCell.className = 'calendar-day other-month'; gridBody.appendChild(emptyCell); }
            for (let i = 1; i <= daysInMonth; i++) {
                const dayCell = document.createElement('div'); dayCell.className = 'calendar-day'; const thisDate = new Date(year, month, i); const today = new Date();
                if (i === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayCell.classList.add('today');
                const dayNumber = document.createElement('div'); dayNumber.className = 'day-number'; dayNumber.textContent = i; dayCell.appendChild(dayNumber);
                const appointmentsOnDay = prospects.filter(p => { const stpDate = p.stp_time ? new Date(p.stp_time) : null; const gmsDate = p.gms_time ? new Date(p.gms_time) : null; return (stpDate && stpDate.getDate() === i && stpDate.getMonth() === month && stpDate.getFullYear() === year) || (gmsDate && gmsDate.getDate() === i && gmsDate.getMonth() === month && gmsDate.getFullYear() === year); });
                if (appointmentsOnDay.length > 0) {
                    const dotsContainer = document.createElement('div'); dotsContainer.className = 'appointment-dots';
                    if (appointmentsOnDay.some(p => p.stp_time && new Date(p.stp_time).getDate() === i && new Date(p.stp_time).getMonth() === month)) {
                        dotsContainer.innerHTML += '<span class="appointment-dot dot-stp"></span>';
                    }
                    if (appointmentsOnDay.some(p => p.gms_time && new Date(p.gms_time).getDate() === i && new Date(p.gms_time).getMonth() === month)) {
                        dotsContainer.innerHTML += '<span class="appointment-dot dot-gms"></span>';
                    }
                    dayCell.appendChild(dotsContainer);
                }
                dayCell.style.cursor = 'pointer'; dayCell.onclick = () => showPlanner(thisDate);
                gridBody.appendChild(dayCell);
            }
        }

        let currentPlannerDate = null;
        function showPlanner(date) {
            currentPlannerDate = date;
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const t = translations[currentLang];
            document.getElementById('planner-title').textContent = `${date.toLocaleDateString(currentLang === 'zh-CN' ? 'zh-Hans-CN' : 'en-US', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})} - ${t.plannerTitle}`;
            const apptList = document.getElementById('planner-appointments-list');
            apptList.innerHTML = '';
            const appointmentsOnDay = prospects.filter(p => { const stpDate = p.stp_time ? new Date(p.stp_time) : null; const gmsDate = p.gms_time ? new Date(p.gms_time) : null; return (stpDate && stpDate.toDateString() === date.toDateString()) || (gmsDate && gmsDate.toDateString() === date.toDateString()); });
            if (appointmentsOnDay.length === 0) { apptList.innerHTML = `<li>${t.noAppointmentsToday}</li>`; } else {
                appointmentsOnDay.sort((a,b) => new Date(a.stp_time || a.gms_time) - new Date(b.stp_time || b.gms_time)).forEach(p => {
                    let ownerInfo = p.owner_type === 'downline' ? ` (${p.downline_name})` : '';
                    const formatTime = (timeStr) => {
                        const time = new Date(timeStr);
                        return currentLang === 'zh-CN' ? formatChineseTime(time) : time.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                    };
                    if (p.stp_time && new Date(p.stp_time).toDateString() === date.toDateString()) apptList.innerHTML += `<li>🔵 <strong>STP:</strong> ${p.name}${ownerInfo} - ${formatTime(p.stp_time)}</li>`;
                    if (p.gms_time && new Date(p.gms_time).toDateString() === date.toDateString()) apptList.innerHTML += `<li>🟠 <strong>GMS:</strong> ${p.name}${ownerInfo} - ${formatTime(p.gms_time)}</li>`;
                });
            }
            const timeline = document.getElementById('planner-timeline-slots');
            timeline.innerHTML = '';
            const dayOfWeek = date.getDay();
            const recurringSlotsForDay = recurringAvailability[dayOfWeek] || [];
            const savedSlots = availability[dateKey] !== undefined ? availability[dateKey] : recurringSlotsForDay;
            
            for (let hour = 0; hour < 24; hour++) {
                for (let min = 0; min < 60; min += 30) {
                    const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                    const slotBtn = document.createElement('button');
                    slotBtn.className = 'time-slot'; slotBtn.dataset.time = timeStr;
                    const tempDate = new Date(2000, 0, 1, hour, min);
                    slotBtn.textContent = (currentLang === 'zh-CN') ? formatChineseTime(tempDate) : tempDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                    
                    const isBooked = appointmentsOnDay.some(p => {
                        const slotStart = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, min);
                        const slotEnd = new Date(slotStart.getTime() + 30 * 60 * 1000);
                        const stpTime = p.stp_time ? new Date(p.stp_time) : null;
                        const gmsTime = p.gms_time ? new Date(p.gms_time) : null;
                        return (stpTime && stpTime >= slotStart && stpTime < slotEnd) || (gmsTime && gmsTime >= slotStart && gmsTime < slotEnd);
                    });

                    if (isBooked) { slotBtn.classList.add('booked'); slotBtn.disabled = true; } 
                    else if (savedSlots.includes(timeStr)) { slotBtn.classList.add('available'); }
                    if (!isBooked) { slotBtn.onclick = () => slotBtn.classList.toggle('available'); }
                    timeline.appendChild(slotBtn);
                }
            }
            plannerModal.style.display = 'flex';
        }

        document.getElementById('save-availability-btn').addEventListener('click', async () => {
            const dateKey = `${currentPlannerDate.getFullYear()}-${String(currentPlannerDate.getMonth() + 1).padStart(2, '0')}-${String(currentPlannerDate.getDate()).padStart(2, '0')}`;
            const availableSlots = Array.from(document.querySelectorAll('#planner-timeline-slots .time-slot.available')).map(slot => slot.dataset.time);
            
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            if(!user) return;
            
            const { error } = await supabase
                .from('availability')
                .upsert({ date: dateKey, time_slots: availableSlots, user_id: user.id }, { onConflict: 'date, user_id' });

            if (error) console.error('Error saving availability:', error);

            await renderAll();
            plannerModal.style.display = 'none';
        });
        
        function getSlotFromTime(date) {
            if (!date) return null;
            const minutes = date.getMinutes() < 30 ? '00' : '30';
            return `${String(date.getHours()).padStart(2, '0')}:${minutes}`;
        }

        async function removeBookedSlotFromDB(dateTimeString) {
            if (!dateTimeString) return;
            const date = new Date(dateTimeString);
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const timeSlot = getSlotFromTime(date);
            
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            if(!user || availability[dateKey] === undefined) return;

            const updatedSlots = availability[dateKey].filter(slot => slot !== timeSlot);

            if (updatedSlots.length === 0) {
                await supabase.from('availability').delete().match({ date: dateKey, user_id: user.id });
            } else {
                await supabase.from('availability').update({ time_slots: updatedSlots }).match({ date: dateKey, user_id: user.id });
            }
        }

        async function addBackAvailabilityToDB(dateTimeString) {
            if (!dateTimeString) return;
            const date = new Date(dateTimeString);
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const timeSlot = getSlotFromTime(date);
            
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            if(!user) return;
            
            const currentSlots = availability[dateKey] || [];
            if (!currentSlots.includes(timeSlot)) {
                currentSlots.push(timeSlot);
                currentSlots.sort();
                await supabase.from('availability').upsert({ date: dateKey, time_slots: currentSlots, user_id: user.id }, { onConflict: 'date, user_id' });
            }
        }

        function renderAvailableSlotsSidebar() {
            const listContainer = document.getElementById('available-slots-list');
            const modalListContainer = document.getElementById('modal-slots-list');
            listContainer.innerHTML = '';
            modalListContainer.innerHTML = '';
            
            let allAvailableSlots = getAllAvailableSlots();

            let contentHTML = '';
            if (allAvailableSlots.length === 0) {
                contentHTML = `<div class="slot-time">${translations[currentLang].noAvailableSlots}</div>`;
            } else {
                const groupedSlots = {};
                allAvailableSlots.slice(0, 20).forEach(slotDate => {
                    const dayKey = slotDate.toLocaleDateString(currentLang === 'zh-CN' ? 'zh-Hans-CN' : 'en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                    if (!groupedSlots[dayKey]) groupedSlots[dayKey] = [];
                    const timeString = (currentLang === 'zh-CN') ? formatChineseTime(slotDate) : slotDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                    groupedSlots[dayKey].push(timeString);
                });

                for (const day in groupedSlots) {
                    contentHTML += `<div class="slot-day-group"><h4>${day}</h4>`;
                    groupedSlots[day].forEach(time => {
                        contentHTML += `<div class="slot-time">${time}</div>`;
                    });
                    contentHTML += `</div>`;
                }
            }
            listContainer.innerHTML = contentHTML;
            modalListContainer.innerHTML = contentHTML;
        }

        function setupNotifications() {
            if (!("Notification" in window)) {
                console.log("This browser does not support desktop notification");
                return;
            }

            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    console.log("Notification permission granted.");
                    setInterval(checkForUpcomingAppointments, 60000);
                }
            });
        }

        function checkForUpcomingAppointments() {
            const now = new Date();
            const fifteenMinutesFromNow = new Date(now.getTime() + 15 * 60000);
            const t = translations[currentLang];

            prospects.forEach(p => {
                let appointmentTime = null;
                let appointmentType = '';

                if (p.status === 'STP' && p.stp_time) {
                    appointmentTime = new Date(p.stp_time);
                    appointmentType = 'STP';
                } else if (p.status === 'GMS_Appointment' && p.gms_time) {
                    appointmentTime = new Date(p.gms_time);
                    appointmentType = 'GMS';
                }

                if (appointmentTime && appointmentTime > now && appointmentTime <= fifteenMinutesFromNow) {
                    const notificationKey = `notif_sent_${p.id}_${appointmentType}`;
                    if (sessionStorage.getItem(notificationKey) === 'true') {
                        return; 
                    }

                    const title = t.upcomingAppointmentsTitle;
                    const options = {
                        body: `${p.name} - ${appointmentType} @ ${appointmentTime.toLocaleTimeString(currentLang === 'zh-CN' ? 'zh-CN' : 'en-US', { hour: '2-digit', minute: '2-digit' })}`,
                        icon: 'images/icon-192x192.png'
                    };

                    new Notification(title, options);
                    sessionStorage.setItem(notificationKey, 'true');
                }
            });
        }
        
        // --- START: Recurring Availability Redesign ---
        function renderRecurringAvailabilityForm() {
            const form = document.getElementById('recurring-availability-form');
            form.innerHTML = '';
            const t = translations[currentLang];
            const dayNames = currentLang === 'zh-CN' 
                ? ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'] 
                : ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            const timeBlocks = {
                morning: { start: 5, end: 12, label: t.guidePeriodZaoshang || "Morning" },
                afternoon: { start: 12, end: 18, label: t.guidePeriodXiawu || "Afternoon" },
                evening: { start: 18, end: 24, label: t.guidePeriodWanshang || "Evening" }
            };

            for (let day = 0; day < 7; day++) {
                const dayAccordion = document.createElement('div');
                dayAccordion.className = 'recurring-day-accordion';
                
                let dayHtml = `<div class="accordion-header" data-day="${day}">${dayNames[day]}</div>
                            <div class="accordion-content" id="content-day-${day}">`;

                for (const blockKey in timeBlocks) {
                    const block = timeBlocks[blockKey];
                    dayHtml += `<div class="time-block" id="block-${day}-${blockKey}">
                                    <div class="time-block-header">
                                        <h4>${block.label}</h4>
                                        <button type="button" class="select-all-btn" data-day="${day}" data-block="${blockKey}">${t.selectAll || 'Select All'}</button>
                                    </div>
                                    <div class="time-block-slots">`;

                    for (let hour = block.start; hour < block.end; hour++) {
                        for (let min = 0; min < 60; min += 30) {
                            const timeStr = `${String(hour).padStart(2, '0')}:${String(min).padStart(2, '0')}`;
                            const tempDate = new Date(2000, 0, 1, hour, min);
                            const displayTime = (currentLang === 'zh-CN') 
                                ? formatChineseTime(tempDate) 
                                : tempDate.toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit', hour12: true});
                            const isSelected = recurringAvailability[day] && recurringAvailability[day].includes(timeStr);
                            dayHtml += `<span class="slot-chip ${isSelected ? 'selected' : ''}" data-day="${day}" data-time="${timeStr}">${displayTime}</span>`;
                        }
                    }
                    dayHtml += `</div></div>`;
                }
                dayHtml += `</div>`;
                dayAccordion.innerHTML = dayHtml;
                form.appendChild(dayAccordion);
            }
        }

        document.getElementById('recurring-availability-form').addEventListener('click', e => {
            if (e.target.classList.contains('slot-chip')) {
                e.target.classList.toggle('selected');
            }
            if (e.target.classList.contains('accordion-header')) {
                const content = e.target.nextElementSibling;
                e.target.classList.toggle('active');
                content.classList.toggle('open');
            }
            if (e.target.classList.contains('select-all-btn')) {
                const day = e.target.dataset.day;
                const blockKey = e.target.dataset.block;
                const slotsInBlock = document.querySelectorAll(`#block-${day}-${blockKey} .slot-chip`);
                const areAllSelected = Array.from(slotsInBlock).every(slot => slot.classList.contains('selected'));
                slotsInBlock.forEach(slot => {
                    if (areAllSelected) {
                        slot.classList.remove('selected');
                    } else {
                        slot.classList.add('selected');
                    }
                });
            }
        });

        document.getElementById('save-recurring-btn').addEventListener('click', async () => {
            const newRecurring = {};
            document.querySelectorAll('.slot-chip.selected').forEach(chip => {
                const day = chip.dataset.day;
                const time = chip.dataset.time;
                if (!newRecurring[day]) newRecurring[day] = [];
                newRecurring[day].push(time);
            });
            recurringAvailability = newRecurring;
            
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            await supabase.from('user_settings').upsert({ user_id: user.id, recurring_availability: recurringAvailability }, { onConflict: 'user_id' });

            alert('Recurring availability saved!');
            await renderAll();
        });
        // --- END: Recurring Availability Redesign ---
        
        function getAllAvailableSlots() {
            const now = new Date();
            let allAvailableSlots = [];
            const checkedDates = new Set();
            
            // Check next 30 days for recurring slots
            for (let i = 0; i < 30; i++) {
                const date = new Date(now.getFullYear(), now.getMonth(), now.getDate() + i);
                const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                checkedDates.add(dateKey);
                
                let slotsForDay = availability[dateKey];
                if (slotsForDay === undefined) {
                    const dayOfWeek = date.getDay();
                    slotsForDay = recurringAvailability[dayOfWeek] || [];
                }
                
                slotsForDay.forEach(timeStr => {
                    const [hour, minute] = timeStr.split(':');
                    const slotDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, minute);
                    if (slotDate > now && !isTimeSlotBooked(slotDate.toISOString())) {
                        allAvailableSlots.push(slotDate);
                    }
                });
            }
            
            // Add specific future dates from availability that were not in the 30-day window
            Object.keys(availability).forEach(dateKey => {
                if (!checkedDates.has(dateKey)) {
                    const date = new Date(dateKey.replace(/-/g, '/')); 
                    if (date > now) {
                        availability[dateKey].forEach(timeStr => {
                            const [hour, minute] = timeStr.split(':');
                            const slotDate = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, minute);
                            if (slotDate > now && !isTimeSlotBooked(slotDate.toISOString())) {
                                allAvailableSlots.push(slotDate);
                            }
                        });
                    }
                }
            });
            
            allAvailableSlots.sort((a, b) => a - b);
            return allAvailableSlots;
        }

        function renderAvailableSlotsForPicker(type) { // type is 'stp' or 'gms'
            const pickerContainer = document.getElementById(`${type}-available-slots`);
            pickerContainer.innerHTML = '';
            const slots = getAllAvailableSlots();
            if (slots.length > 0) {
                slots.slice(0, 50).forEach(slotDate => {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'slot-picker-btn';
                    btn.textContent = formatDate(slotDate);
                    btn.onclick = () => {
                        const picker = type === 'stp' ? stpPicker : gmsPicker;
                        picker && picker.setDate(slotDate, true);
                    };
                    pickerContainer.appendChild(btn);
                });
            } else {
                pickerContainer.innerHTML = `<p>${translations[currentLang].noAvailableSlots}</p>`;
            }
        }
        
        // =======================================================
        // START: APP INITIALIZATION LOGIC
        // =======================================================
        async function cleanupExpiredAvailability() {
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            if (!user) return;

            const today = new Date();
            const todayDateString = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            const { error: deleteError } = await supabase.from('availability').delete().lt('date', todayDateString);
            if(deleteError) console.error("Error cleaning past dates:", deleteError);

            const { data: todayData, error: fetchError } = await supabase
                .from('availability')
                .select('*')
                .eq('date', todayDateString)
                .limit(1)
                .maybeSingle();

            if (fetchError || !todayData) return;

            const now = new Date();
            const futureSlots = todayData.time_slots.filter(timeStr => {
                const [hour, minute] = timeStr.split(':');
                const slotDate = new Date(today.getFullYear(), today.getMonth(), today.getDate(), hour, minute);
                return slotDate > now;
            });

            if (futureSlots.length !== todayData.time_slots.length) {
                if (futureSlots.length === 0) {
                    await supabase.from('availability').delete().eq('id', todayData.id);
                } else {
                    await supabase.from('availability').update({ time_slots: futureSlots }).eq('id', todayData.id);
                }
            }
        }


        async function startApp() {
            // ROBUSTNESS FIX: Initialize pickers now that the app is starting and DOM is ready.
            const _stpEl = document.querySelector("#stp-datetime");
            if (_stpEl) stpPicker = flatpickr(_stpEl, { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });
            const _gmsEl = document.querySelector("#gms-datetime");
            if (_gmsEl) gmsPicker = flatpickr(_gmsEl, { enableTime: true, dateFormat: "Y-m-d H:i", time_24hr: true });
            const _anEl = document.querySelector("#analytics-month");
            if (_anEl) analyticsPicker = flatpickr(_anEl, { 
                plugins: [ new monthSelectPlugin({ shorthand: false, dateFormat: "Y-m", altFormat: "F Y" }) ],
                altInput: true,
                onChange: () => renderAnalytics() 
            });

            const preferredLanguage = localStorage.getItem('preferredLanguage') || 'zh-CN';
            if (!window._langInitDone) setLanguage(preferredLanguage);

            try {
                const now = new Date();
                analyticsPicker?.setDate(now, true);
            } catch (error) {
                console.error("Failed to initialize analytics picker, but continuing:", error);
            }

            // Attach all event listeners for the main app
            const prospectModal = document.getElementById('prospect-modal'); 
            const actionModal = document.getElementById('action-modal');
            const plannerModal = document.getElementById('planner-modal');
            const availabilityModal = document.getElementById('availability-modal');
            const showAvailabilityFab = document.getElementById('show-availability-fab');
            
            document.getElementById('add-prospect-btn').onclick = () => { 
                document.getElementById('prospect-form').reset(); 
                stpPicker.clear(); 
                document.getElementById('prospect-id').value = ''; 
                document.getElementById('modal-title').textContent = translations[currentLang].modalTitleAdd; 
                document.getElementById('downline-name-group').style.display = 'none';
                renderAvailableSlotsForPicker('stp');
                prospectModal.style.display = 'flex'; 
            };
            document.getElementById('close-modal').onclick = () => prospectModal.style.display = 'none';
            document.getElementById('action-close-modal').onclick = () => actionModal.style.display = 'none';
            document.getElementById('close-planner-modal').onclick = () => plannerModal.style.display = 'none';
            document.getElementById('close-availability-modal').onclick = () => availabilityModal.style.display = 'none';
            showAvailabilityFab.onclick = () => availabilityModal.style.display = 'flex';
                        
            window.addEventListener('click', (e) => {
                if (!e.target.closest('.card-menu-container')) {
                    document.querySelectorAll('.card-menu.open').forEach(menu => menu.classList.remove('open'));
                }
                if (e.target == prospectModal) prospectModal.style.display = 'none'; 
                if (e.target == actionModal) actionModal.style.display = 'none'; 
                if (e.target == plannerModal) plannerModal.style.display = 'none';
                if (e.target == availabilityModal) availabilityModal.style.display = 'none';
            });

            document.querySelectorAll('.tab-button').forEach(button => { button.addEventListener('click', () => { document.querySelectorAll('.tab-button, .tab-content').forEach(el => el.classList.remove('active')); button.classList.add('active'); document.getElementById(button.dataset.tab).classList.add('active'); if(button.dataset.tab === 'analytics') { populateDownlineFilter(); renderAnalytics(); } }); });
            
            document.getElementById('owner-type').addEventListener('change', (e) => {
                document.getElementById('downline-name-group').style.display = e.target.value === 'downline' ? 'block' : 'none';
            });
            
            await cleanupExpiredAvailability();
            await renderAll();
            setupNotifications();

            supabase
            .channel('public:prospects')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'prospects' }, payload => {
                renderAll();
            })
            .subscribe();

            supabase
            .channel('public:availability')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'availability' }, payload => {
                renderAll();
            })
            .subscribe();
            
            supabase
            .channel('public:user_settings')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'user_settings' }, payload => {
                renderAll();
            })
            .subscribe();
        }
        
        function updateAuthView() {
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const actionBtn = document.getElementById('auth-action-btn');
            const confirmPassGroup = document.getElementById('confirm-password-group');
            const toggleText = document.getElementById('auth-toggle-text');
            const forgotPassLink = document.getElementById('forgot-password-link');

            if (isLoginView) {
                title.textContent = 'Welcome Back';
                subtitle.textContent = 'Login to track your prospects.';
                actionBtn.textContent = 'Login';
                actionBtn.className = 'btn-primary';
                confirmPassGroup.style.display = 'none';
                toggleText.innerHTML = 'No account? <span class="auth-toggle-link" id="toggle-to-signup">Sign up now</span>.';
                forgotPassLink.style.display = 'block';
                document.getElementById('toggle-to-signup').addEventListener('click', () => {
                    isLoginView = false;
                    updateAuthView();
                });
            } else {
                title.textContent = 'Create an Account';
                subtitle.textContent = 'Start tracking your prospects today.';
                actionBtn.textContent = 'Sign Up';
                actionBtn.className = 'btn-success';
                confirmPassGroup.style.display = 'block';
                toggleText.innerHTML = 'Already have an account? <span class="auth-toggle-link" id="toggle-to-login">Log in</span>.';
                forgotPassLink.style.display = 'none';
                document.getElementById('toggle-to-login').addEventListener('click', () => {
                    isLoginView = true;
                    updateAuthView();
                });
            }
        }
        
        document.getElementById('toggle-to-signup').addEventListener('click', () => {
            isLoginView = false;
            updateAuthView();
        });

        const authContainer = document.getElementById('auth-container');
        const mainApp = document.getElementById('main-app');
        const logoutBtn = document.getElementById('logout-btn');

        document.getElementById('auth-action-btn').addEventListener('click', async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            
            if (isLoginView) {
                const { error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) alert(error.message);
            } else {
                const confirmPassword = document.getElementById('auth-confirm-password').value;
                if (password !== confirmPassword) {
                    alert("Passwords do not match.");
                    return;
                }
                const { error } = await supabase.auth.signUp({ email, password });
                if (error) {
                    alert(error.message);
                } else {
                    alert('Sign up successful! Please check your email to verify.');
                    isLoginView = true;
                    updateAuthView();
                }
            }
        });

        logoutBtn.addEventListener('click', async () => {
            sessionStorage.removeItem('hasSeenWelcome'); 
            await supabase.auth.signOut();
        });

        document.getElementById('google-signin-btn').addEventListener('click', async () => {
            const { error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
            });
            if (error) {
                alert('Error signing in with Google: ' + error.message);
            }
        });

        async function updateUserUI(user) {
            const loadingScreen = document.getElementById('loading-screen');
            const hasSeenWelcome = sessionStorage.getItem('hasSeenWelcome');

            if (user) {
                // STEP 1: Run all the setup and rendering logic while the UI is hidden.
                document.getElementById('user-email').textContent = user.email;
                await startApp(); // This now runs before the UI is shown.

                // STEP 2: Visually switch from the auth screen to the main app.
                authContainer.style.display = 'none';
                mainApp.style.display = ''; // Use the default display style from CSS.

                // STEP 3: Hide the loading screen as the final step.
                if (!hasSeenWelcome) {
                    setTimeout(() => {
                        loadingScreen.classList.add('hidden');
                        sessionStorage.setItem('hasSeenWelcome', 'true');
                    }, 1500); // Keep your welcome animation.
                } else {
                    loadingScreen.style.display = 'none'; // Hide immediately if already seen.
                }
            } else {
                // This part handles the logged-out state and is correct.
                loadingScreen.style.display = 'none';
                authContainer.style.display = 'flex';
                mainApp.style.display = 'none';
                document.getElementById('user-email').textContent = '';
                updateAuthView(); 
            }
        }

        supabaseReady.then(() => {
  supabase.auth.onAuthStateChange((event, session) => {
    const user = session ? session.user : null;
    updateUserUI(user);
  });
});
(async () => {
            const { data: { user } } = await supabaseReady.then(() => supabase.auth.getUser());
            await updateUserUI(user);
        })();
  </script>
  <script>
   if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(err => {
                    console.log('ServiceWorker registration failed: ', err);
                });
        });
    }
  </script>
  <script>
   runWhenSupabaseReady(async () => {
  // Set your VAPID public key (from web-push generate-vapid-keys)
  const VAPID_PUBLIC_KEY = 'BIDMrzJt8JhFBipdyHSTNhdBVxetRNxuWw0KzxxUAn9e__jUNaxZg-luXSQ5kpjDtqMgvF1KmrZGNRNgRL7leLw';

  const toUint8 = (base64) => {
    const padding = '='.repeat((4 - (base64.length % 4)) % 4);
    const b64 = (base64 + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(b64); const out = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) out[i] = raw.charCodeAt(i);
    return out;
  };

  async function saveSubscription(sub) {
    const client = (typeof supabaseReady !== 'undefined' && supabaseReady && typeof supabaseReady.then==='function')
      ? await supabaseReady : (typeof supabase !== 'undefined' ? supabase : null);
    if (!client || !client.auth) { alert('Please sign in first.'); return; }
    const { data } = await client.auth.getUser();
    const user = data && data.user;
    if (!user) { alert('Please sign in first.'); return; }
    const payload = {
      user_id: user.id,
      endpoint: sub.endpoint,
      auth: sub.keys.auth,
      p256dh: sub.keys.p256dh
    };
    await supabase.from('push_subscriptions').upsert(payload, { onConflict: 'endpoint' });
  }

  async function enablePush() {
    try {
      if (!('Notification' in window) || !('serviceWorker' in navigator) || !('PushManager' in window)) {
        alert('Push is not supported on this browser.');
        return;
      }
      const perm = await Notification.requestPermission();
      if (perm !== 'granted') { alert('Permission denied.'); return; }
      const reg = await navigator.serviceWorker.ready;
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: toUint8(VAPID_PUBLIC_KEY)
      });
      await saveSubscription(sub);
      console.log('Push enabled');
    } catch (e) {
      console.error('Enable push failed', e);
      alert('Failed to enable push. See console for details.');
    }
  }

  document.getElementById('enable-push-btn')?.addEventListener('click', enablePush);
});
  </script>
 
<script>
// Language manager (English <-> 简体中文) with delegated events so it keeps working after re-renders
(function() {
  const LANG_KEY = "appLanguage";
  const langNames = { "en": "English", "zh-CN": "简体中文" };
  let currentLang = localStorage.getItem(LANG_KEY) || "en";

  function getToggle() {
    return document.getElementById("language-btn")
        || document.querySelector('[data-role="language-toggle"]')
        || document.querySelector(".language-toggle")
        || null;
  }

  function applyLanguage(lang) {
    currentLang = lang;
    try { localStorage.setItem(LANG_KEY, lang); } catch(e) {}

    // Update toggle label if present (node may be replaced by app code, so resolve fresh each time)
    const toggle = getToggle();
    if (toggle) {
      if (toggle.tagName === 'SELECT') toggle.value = lang;
      else toggle.textContent = langNames[lang] || lang;
    }

    // Update all translatable nodes
    document.querySelectorAll("[data-i18n]").forEach(el => {
      try {
        const dict = JSON.parse(el.getAttribute("data-i18n"));
        if (dict && dict[lang] != null) el.textContent = dict[lang];
      } catch (_) {}
    });

    document.querySelectorAll("[data-i18n-placeholder]").forEach(el => {
      try {
        const dict = JSON.parse(el.getAttribute("data-i18n-placeholder"));
        if (dict && dict[lang] != null) el.setAttribute("placeholder", dict[lang]);
      } catch (_) {}
    });

    document.querySelectorAll("[data-i18n-title]").forEach(el => {
      try {
        const dict = JSON.parse(el.getAttribute("data-i18n-title"));
        if (dict && dict[lang] != null) el.setAttribute("title", dict[lang]);
      } catch (_) {}
    });

    // Re-init DataTables if available (optional)
    if (window.jQuery && window.jQuery.fn && window.jQuery.fn.dataTable) {
      const $ = window.jQuery;
      $(".dataTable").each(function() {
        if ($.fn.dataTable.isDataTable(this)) $(this).DataTable().destroy();
        $(this).DataTable({
          language: { url: (lang === "en" ? "" : "//cdn.datatables.net/plug-ins/1.13.6/i18n/zh.json") }
        });
      });
    }
  }

  // Delegated listeners survive DOM replacements
  document.addEventListener("click", (e) => {
    const t = e.target.closest("#language-btn, [data-role='language-toggle'], .language-toggle");
    if (!t) return;
    if (t.tagName !== 'SELECT') {
      const next = (currentLang === "en") ? "zh-CN" : "en";
      applyLanguage(next);
    }
  });

  document.addEventListener("change", (e) => {
    const t = e.target.closest("#language-btn, [data-role='language-toggle'], .language-toggle");
    if (!t) return;
    if (t.tagName === 'SELECT') {
      applyLanguage(t.value === "zh-CN" ? "zh-CN" : "en");
    }
  });

  // Apply saved/default on load
  document.addEventListener("DOMContentLoaded", () => {
    applyLanguage(currentLang);
  });
})();
</script>


<script type="module">
// Robust one-time push setup after Supabase is ready
(() => {
  const VAPID_PUBLIC_KEY = 'BIDMrzJt8JhFBipdyHSTNhdBVxetRNxuWw0KzxxUAn9e__jUNaxZg-luXSQ5kpjDtqMgvF1KmrZGNRNgRL7leLw';
  const LS = { prompted: 'pushPrompted_v2', subscribed: 'pushSubscribed_v2' };

  const toUint8 = (b64) => {
    const pad = '='.repeat((4 - (b64.length % 4)) % 4);
    const base64 = (b64 + pad).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(base64); const out = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; i++) out[i] = raw.charCodeAt(i);
    return out;
  };

  const supported = () => ('Notification' in window) && ('serviceWorker' in navigator) && ('PushManager' in window);

  async function saveSubscription(client, userId, sub) {
    try {
      const json = sub.toJSON();
      const payload = { user_id: userId, endpoint: sub.endpoint, p256dh: json.keys.p256dh, auth: json.keys.auth };
      const { error } = await client.from('push_subscriptions').upsert(payload, { onConflict: 'endpoint' });
      if (!error) localStorage.setItem(LS.subscribed, '1');
      else console.error('saveSubscription error', error);
    } catch (e) { console.error('saveSubscription fatal', e); }
  }

  async function subscribeNow(client, user) {
    if (!supported()) return;
    const reg = await navigator.serviceWorker.ready;
    const existing = await reg.pushManager.getSubscription();
    if (existing) { await saveSubscription(client, user.id, existing); return; }
    const sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: toUint8(VAPID_PUBLIC_KEY) });
    await saveSubscription(client, user.id, sub);
  }

  let pushSetupDone = false;
  async function ensurePushSetupOnce() {
    if (pushSetupDone) return;

    // Wait for Supabase client
    const client = (typeof supabaseReady !== 'undefined' && supabaseReady && typeof supabaseReady.then === 'function')
      ? await supabaseReady
      : (typeof supabase !== 'undefined' ? supabase : null);

    if (!client || !client.auth) { console.warn('Supabase client not ready, skipping push setup'); return; }

    const { data, error } = await client.auth.getUser();
    const user = data && data.user;
    if (error) { console.warn('getUser error', error); return; }
    if (!user) { return; }

    if (Notification.permission === 'granted') {
      if (!localStorage.getItem(LS.subscribed)) await subscribeNow(client, user);
      pushSetupDone = true;
      return;
    }

    if (Notification.permission === 'default' && !localStorage.getItem(LS.prompted)) {
      localStorage.setItem(LS.prompted, '1');
      const perm = await Notification.requestPermission();
      if (perm === 'granted') await subscribeNow(client, user);
      pushSetupDone = true;
    }
  }

  // Hook into auth state only after client is ready
  (async () => {
    const client = (typeof supabaseReady !== 'undefined' && supabaseReady && typeof supabaseReady.then === 'function')
      ? await supabaseReady
      : (typeof supabase !== 'undefined' ? supabase : null);

    if (client && client.auth && typeof client.auth.onAuthStateChange === 'function') {
      client.auth.onAuthStateChange((_e, session) => {
        if (session && session.user) ensurePushSetupOnce();
      });
    }

    // also attempt once on load (for already logged-in session)
    ensurePushSetupOnce();
  })();

  // Optional manual re-enable button
  const manualBtn = document.getElementById('enable-push-btn');
  if (manualBtn) manualBtn.addEventListener('click', () => ensurePushSetupOnce());
})();
</script>


<script>
// === Auth-aware UI glue: welcome once per session, FAB only after login ===
(function () {
  function setAuthBodyClass(isLoggedIn) {
    document.body.classList.toggle('logged-in', !!isLoggedIn);
    document.body.classList.toggle('logged-out', !isLoggedIn);
  }

  // Hide welcome immediately if already seen and default to logged-out
  (function hideWelcomeEarly() {
    if (sessionStorage.getItem('hasSeenWelcome') === 'true') {
      const loading = document.getElementById('loading-screen');
      if (loading) loading.classList.add('hidden');
    }
    setAuthBodyClass(false);
  })();

  runWhenSupabaseReady(async () => {
    try {
      // ✅ Always use the resolved client, not the bare global
      const client = (typeof supabaseReady !== 'undefined' && supabaseReady && typeof supabaseReady.then === 'function')
        ? await supabaseReady
        : (typeof supabase !== 'undefined' ? supabase : null);

      if (!client || !client.auth) return;

      const { data } = await client.auth.getUser();
      const user = data?.user || null;
      setAuthBodyClass(!!user);

      if (typeof client.auth.onAuthStateChange === 'function') {
        client.auth.onAuthStateChange((_e, session) => {
          const u = session?.user || null;
          setAuthBodyClass(!!u);

          const loading = document.getElementById('loading-screen');
          if (!u) {
            sessionStorage.removeItem('hasSeenWelcome');
            if (loading) loading.classList.add('hidden');
          } else {
            const hasSeen = sessionStorage.getItem('hasSeenWelcome') === 'true';
            if (loading) {
              if (!hasSeen) {
                setTimeout(() => {
                  loading.classList.add('hidden');
                  sessionStorage.setItem('hasSeenWelcome', 'true');
                }, 1500);
              } else {
                loading.classList.add('hidden');
              }
            }
          }
        });
      }

      // Initial welcome hide/show
      const loading = document.getElementById('loading-screen');
      if (user) {
        const hasSeen = sessionStorage.getItem('hasSeenWelcome') === 'true';
        if (loading) {
          if (!hasSeen) {
            setTimeout(() => {
              loading.classList.add('hidden');
              sessionStorage.setItem('hasSeenWelcome', 'true');
            }, 1500);
          } else {
            loading.classList.add('hidden');
          }
        }
      } else if (loading) {
        loading.classList.add('hidden');
      }
    } catch (e) {
      console.warn('Auth UI glue error', e);
    }
  });
})();
</script>

<script>
// === Multi-device push subscription registration ===
runWhenSupabaseReady(async () => {
  const VAPID_PUBLIC_KEY = 'BIDMrzJt8JhFBipdyHSTNhdBVxetRNxuWw0KzxxUAn9e__jUNaxZg-luXSQ5kpjDtqMgvF1KmrZGNRNgRL7leLw';

  const toUint8 = (base64) => {
    const padding = '='.repeat((4 - (base64.length % 4)) % 4);
    const b64 = (base64 + padding).replace(/-/g, '+').replace(/_/g, '/');
    const raw = atob(b64); const out = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) out[i] = raw.charCodeAt(i);
    return out;
  };

  async function saveSubscription(sub) {
    const { data } = await supabase.auth.getUser();
    const user = data && data.user;
    if (!user || !sub) return;
    const payload = {
      user_id: user.id,
      endpoint: sub.endpoint,
      auth: sub.keys && sub.keys.auth,
      p256dh: sub.keys && sub.keys.p256dh
    };
    // Upsert by endpoint so one device doesn't affect others
    await supabase.from('push_subscriptions').upsert(payload, { onConflict: 'endpoint' });
  }

  async function ensurePushRegistered() {
    try {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
      const reg = await navigator.serviceWorker.ready;
      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        if (Notification.permission !== 'granted') return; // respect user's choice; your existing UI can request permission
        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: toUint8(VAPID_PUBLIC_KEY) });
      }
      await saveSubscription(sub);
    } catch (e) {
      console.warn('ensurePushRegistered failed', e);
    }
  }

  // Register/refresh subscription whenever auth state changes (per device)
  if (supabase?.auth?.onAuthStateChange) {
    supabase.auth.onAuthStateChange(async (_evt, session) => {
      if (session && session.user) await ensurePushRegistered();
    });
  }

  // Also run once for existing sessions
  try {
    const { data: { user } } = await supabase.auth.getUser();
    if (user) await ensurePushRegistered();
  } catch (e) {}
});
</script>
</body>
</html>